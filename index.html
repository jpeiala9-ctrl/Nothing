<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  <title>RI5 ¬∑ RGB GAMING EDITION</title>
  
  <!-- MANIFEST (RGB style) -->
  <link rel="manifest" href="data:application/manifest+json,%7B%22name%22%3A%22RI5%20RGB%22%2C%22short_name%22%3A%22RI5%22%2C%22description%22%3A%22Entrenamiento%20runner%20RGB%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%23000000%22%2C%22theme_color%22%3A%22%23ff00ff%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20100%20100%22%3E%3Crect%20width%3D%22100%25%22%20height%3D%22100%25%22%20fill%3D%22%23000000%22%2F%3E%3Ctext%20x%3D%2250%22%20y%3D%2268%22%20font-size%3D%2260%22%20text-anchor%3D%22middle%22%20fill%3D%22%23ffffff%22%20font-family%3D%22Arial%22%3ERI5%3C%2Ftext%3E%3C%2Fsvg%3E%22%2C%22sizes%22%3A%22192x192%22%2C%22type%22%3A%22image%2Fsvg%2Bxml%22%2C%22purpose%22%3A%22any%20maskable%22%7D%5D%7D">
  
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="RI5 RGB">
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20100%20100%22%3E%3Crect%20width%3D%22100%25%22%20height%3D%22100%25%22%20fill%3D%22%23000000%22%2F%3E%3Ctext%20x%3D%2250%22%20y%3D%2268%22%20font-size%3D%2260%22%20text-anchor%3D%22middle%22%20fill%3D%22%23ffffff%22%20font-family%3D%22Arial%22%3ERI5%3C%2Ftext%3E%3C%2Fsvg%3E">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    /* ===== RESET Y VARIABLES RGB GAMING ===== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #0a0a0a;
      --bg-secondary: #1a1a1a;
      --bg-card: #111111;
      --text-primary: #ffffff;
      --text-secondary: #cccccc;
      --accent-red: #ff0040;
      --accent-green: #00ff80;
      --accent-blue: #0080ff;
      --accent-yellow: #ffff00;
      --accent-purple: #bf00ff;
      --border-color: #333;
      --glow-color: rgba(255,0,255,0.3);
      --font-mono: 'Courier New', monospace;
      --font-gaming: 'Courier New', 'Dot Matrix', monospace;
      --dot-color: rgba(255,255,255,0.1);
      --gold: #ffd700;
      --new-user-bg: rgba(0,255,255,0.2);
      --new-user-border: #00ffff;
      --stat-bg: #222;
      --stat-number: #ff00ff;
    }

    /* Animaciones RGB */
    @keyframes rgbShift {
      0% { filter: hue-rotate(0deg); }
      100% { filter: hue-rotate(360deg); }
    }
    @keyframes bgPulse {
      0% { background-position: 0% 0%; }
      50% { background-position: 100% 100%; }
      100% { background-position: 0% 0%; }
    }
    @keyframes neonGlow {
      0% { box-shadow: 0 0 5px var(--accent-blue), 0 0 10px var(--accent-blue); }
      33% { box-shadow: 0 0 5px var(--accent-green), 0 0 10px var(--accent-green); }
      66% { box-shadow: 0 0 5px var(--accent-red), 0 0 10px var(--accent-red); }
      100% { box-shadow: 0 0 5px var(--accent-blue), 0 0 10px var(--accent-blue); }
    }
    @keyframes textGlow {
      0% { text-shadow: 0 0 5px var(--accent-blue); }
      33% { text-shadow: 0 0 5px var(--accent-green); }
      66% { text-shadow: 0 0 5px var(--accent-red); }
      100% { text-shadow: 0 0 5px var(--accent-blue); }
    }

    body {
      background: var(--bg-primary);
      color: var(--text-primary);
      font-family: var(--font-mono);
      line-height: 1.6;
      letter-spacing: 0.5px;
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
      background: radial-gradient(circle at 50% 50%, #1a0033, #000000);
      animation: bgPulse 20s infinite alternate;
    }

    body::before {
      content: "";
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: repeating-linear-gradient(45deg, rgba(255,0,255,0.02) 0px, rgba(255,0,255,0.02) 2px, transparent 2px, transparent 8px);
      pointer-events: none;
      z-index: 9999;
    }

    h1, h2, h3, h4 {
      font-family: var(--font-gaming);
      font-weight: 300;
      letter-spacing: 2px;
      text-transform: uppercase;
      position: relative;
      display: inline-block;
      width: 100%;
      text-align: center;
      animation: textGlow 5s infinite;
    }
    h1::after, h2::after {
      content: "";
      position: absolute;
      bottom: -5px; left: 0;
      width: 100%; height: 2px;
      background: linear-gradient(90deg, transparent, var(--accent-blue), var(--accent-purple), transparent);
      animation: rgbShift 3s infinite;
    }

    /* Ajustes de t√≠tulos */
    #tab-entreno h2,
    #tab-plan h2,
    #tab-historial h2 {
      margin-bottom: 30px;
    }

    .wrapper {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 20px;
      overflow-y: auto;
    }

    #loginPage.wrapper {
      align-items: flex-start;
      padding-top: 20px;
      padding-bottom: 20px;
    }

    .card {
      width: 100%;
      max-width: 540px;
      background: var(--bg-card);
      border: 2px solid transparent;
      border-radius: 28px;
      padding: 30px;
      box-shadow: 0 20px 30px rgba(0,0,0,0.8), inset 0 0 20px rgba(255,0,255,0.2);
      position: relative;
      overflow: hidden;
      margin: 20px 0;
      transition: all 0.3s ease;
      animation: neonGlow 8s infinite;
    }
    .card:hover {
      border-color: rgba(255,255,255,0.2);
      box-shadow: 0 20px 40px rgba(0,0,0,0.9), inset 0 0 30px rgba(0,255,255,0.3);
    }
    .card::before {
      content: "";
      position: absolute;
      top: -50%; left: -50%;
      width: 200%; height: 200%;
      background: repeating-radial-gradient(circle at 50% 50%, rgba(255,255,255,0.05) 0px, transparent 5px);
      opacity: 0.3;
      pointer-events: none;
    }

    .card.admin-card {
      max-width: 800px;
      max-height: none;
      display: flex;
      flex-direction: column;
      overflow: visible;
    }
    .card.admin-card .tabs-container {
      flex: none;
      overflow-y: visible;
      padding-right: 5px;
    }

    /* ===== HEADER CON ICONO DE APAGADO ===== */
    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: nowrap;
      gap: 10px;
    }
    .app-header h1 {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      animation: textGlow 5s infinite;
    }
    .logout-icon {
      flex-shrink: 0;
      width: 40px;
      height: 40px;
      padding: 0;
      background: transparent;
      border: 2px solid var(--accent-green);
      border-radius: 50%;
      color: var(--accent-green);
      font-size: 24px;
      line-height: 1;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 10px var(--accent-green);
    }
    .logout-icon:hover {
      background: var(--accent-green);
      color: var(--bg-primary);
      border-color: var(--accent-green);
      transform: scale(1.1);
    }
    #adminPage .logout-icon {
      border-color: var(--accent-red);
      color: var(--accent-red);
      box-shadow: 0 0 10px var(--accent-red);
    }
    #adminPage .logout-icon:hover {
      background: var(--accent-red);
      color: var(--bg-primary);
      border-color: var(--accent-red);
    }

    /* ===== TABS DE LOGIN/REGISTRO ===== */
    .auth-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 30px;
      background: var(--bg-secondary);
      padding: 4px;
      border-radius: 40px;
      border: 1px solid var(--border-color);
    }
    .auth-tab {
      flex: 1;
      padding: 12px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-family: var(--font-gaming);
      font-size: 14px;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all 0.3s ease;
      border-radius: 30px;
    }
    .auth-tab.active {
      background: rgba(255,255,255,0.2);
      color: var(--text-primary);
      box-shadow: inset 0 0 15px rgba(255,0,255,0.5);
    }
    .auth-form { display: none; animation: glyphIn 0.5s ease; }
    .auth-form.active { display: block; }

    /* ===== PESTA√ëAS PRINCIPALES ===== */
    .tabs-container { margin: 30px 0; }
    .tabs-header {
      display: flex;
      justify-content: center;
      gap: 4px;
      margin-bottom: 20px;
      background: var(--bg-secondary);
      padding: 4px;
      border-radius: 40px;
      border: 1px solid var(--border-color);
      align-items: center;
    }
    .tab-button {
      flex: 1;
      min-width: 70px;
      max-width: 100px;
      padding: 10px 4px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-family: var(--font-gaming);
      font-size: 13px;
      letter-spacing: 0.5px;
      cursor: pointer;
      border-radius: 30px;
      white-space: nowrap;
      transition: all 0.3s ease;
      text-align: center;
    }
    .tab-button.active {
      background: rgba(255,255,255,0.2) !important;
      color: var(--text-primary);
    }
    /* Pesta√±a soporte activa sin mensajes: naranja */
    #soporteTabButton.active:not(.soporte-unread) {
      color: #ffa500 !important;
    }
    /* Pesta√±a soporte con mensajes no le√≠dos: rojo parpadeante */
    .tab-button.soporte-unread {
      color: var(--accent-red) !important;
      animation: latido-texto 1.5s infinite;
    }
    .tab-content { display: none; animation: glyphIn 0.5s ease; }
    .tab-content.active { display: block; }
    @keyframes glyphIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes latido-texto {
      0% { color: var(--accent-red); text-shadow: 0 0 5px var(--accent-red); }
      50% { color: #ff8a7a; text-shadow: 0 0 15px var(--accent-red); }
      100% { color: var(--accent-red); text-shadow: 0 0 5px var(--accent-red); }
    }

    /* ===== INPUTS, SELECTS Y TEXTAREAS ===== */
    input, button, select, textarea {
      width: 100%;
      padding: 16px;
      background: rgba(20,20,20,0.8);
      border: 1px solid var(--border-color);
      border-radius: 40px;
      color: var(--text-primary);
      font-family: var(--font-mono);
      font-size: 16px;
      margin-bottom: 16px;
      transition: all 0.3s ease;
      outline: none;
      backdrop-filter: blur(5px);
    }
    textarea {
      border-radius: 24px;
      resize: vertical;
      min-height: 100px;
    }
    input:focus, select:focus, textarea:focus {
      border-color: var(--accent-blue);
      box-shadow: 0 0 20px var(--accent-blue);
    }
    input.error { border-color: var(--accent-red); }

    .fecha-inicio-container { text-align: center; margin: 20px 0; }
    .fecha-inicio-container label {
      display: block; margin-bottom: 8px; color: var(--accent-yellow);
      font-family: var(--font-gaming); font-size: 14px; letter-spacing: 1px;
    }
    #fechaInicio { max-width: 300px; margin: 0 auto; text-align: center; }

    .button-main {
      background: transparent;
      border: 1px solid var(--accent-blue);
      color: var(--accent-blue);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 2px;
      cursor: pointer;
      width: auto;
      min-width: 180px;
      margin: 20px auto !important;
      display: block;
      text-align: center;
      animation: neonGlow 5s infinite;
    }
    .button-main:hover { box-shadow: 0 0 30px var(--accent-blue); }

    /* ===== CURIOSIDAD ===== */
    .curiosity {
      margin: 30px 0;
      padding: 30px;
      background: rgba(20,20,20,0.8);
      border: 1px solid var(--accent-purple);
      border-radius: 24px;
      text-align: center;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(5px);
    }
    .curiosity::before {
      content: "";
      position: absolute;
      top: -50%; left: -50%;
      width: 200%; height: 200%;
      background: radial-gradient(circle, rgba(191,90,242,0.3) 0%, transparent 70%);
      animation: rgbShift 10s infinite;
    }
    .curiosity span { font-size: 18px; position: relative; z-index: 1; animation: textGlow 5s infinite; }

    /* ===== ZONAS DE ENTRENAMIENTO ===== */
    .zone-card {
      margin: 16px 0;
      padding: 20px;
      background: rgba(20,20,20,0.8);
      border: 1px solid var(--border-color);
      border-radius: 24px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      text-align: center;
      backdrop-filter: blur(5px);
    }
    .zone-card::after {
      content: ""; position: absolute; top: 0; left: 0; width: 4px; height: 100%;
      background: var(--accent-blue);
      animation: rgbShift 3s infinite;
    }
    .zone-card:hover { transform: translateX(5px); box-shadow: 0 0 20px var(--accent-blue); }

    /* ===== CALENDARIO ===== */
    #calendarioEntreno {
      margin: 30px 0; padding: 20px;
      background: rgba(20,20,20,0.8); border-radius: 24px; width: 100%;
      backdrop-filter: blur(5px);
    }
    .calendar-header { display: grid; grid-template-columns: repeat(7,1fr); gap: 4px; margin-bottom: 8px; }
    .calendar-header div { text-align: center; color: var(--text-secondary); font-size: 12px; text-transform: uppercase; }
    #calendarioGrid { display: grid; grid-template-columns: repeat(7,1fr); gap: 4px; }
    .calendario-dia {
      aspect-ratio: 1; padding: 4px; background: var(--bg-primary);
      border: 2px solid var(--border-color); border-radius: 10px;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      cursor: pointer; transition: all 0.2s ease; font-size: 11px;
      text-align: center; color: #fff;
    }
    .calendario-dia:hover { border-color: var(--accent-blue); transform: scale(1.05); box-shadow: 0 0 15px var(--accent-blue); }
    .sesion-descanso { border-color: #444; background: #222; }
    .sesion-rodaje { border-color: var(--accent-blue); background: #0a1a2a; }
    .sesion-series { border-color: var(--accent-green); background: #0a2a0a; }
    .sesion-tempo { border-color: var(--accent-yellow); background: #2a2a0a; }
    .sesion-largo { border-color: var(--accent-red); background: #2a0a0a; }

    /* ===== HISTORIAL (tarjetas compactas) ===== */
    .historial-controls {
      display: flex; justify-content: flex-end; align-items: center; gap: 10px; margin-bottom: 15px;
    }
    .historial-controls select { width: auto; padding: 8px; background: var(--bg-primary); }
    .historial-list { display: flex; flex-direction: column; gap: 12px; }
    .historial-item {
      position: relative;
      padding: 12px 70px 12px 12px;
      background: rgba(20,20,20,0.8);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      min-height: 70px;
      backdrop-filter: blur(5px);
    }
    .historial-item:hover { background: var(--bg-card); border-color: var(--accent-blue); }
    .historial-item .fecha {
      color: var(--accent-blue); font-family: var(--font-gaming); font-size: 14px; margin-bottom: 4px;
      animation: textGlow 5s infinite;
    }
    .historial-item .resumen {
      color: var(--text-secondary); font-size: 12px; text-align: center; word-break: break-word;
    }
    .historial-item .delete-single {
      position: absolute; top: 50%; right: 12px; transform: translateY(-50%);
      background: transparent; border: 1px solid var(--accent-red); border-radius: 40px;
      color: var(--accent-red); padding: 6px 12px; font-size: 11px; cursor: pointer; width: auto;
      z-index: 2; white-space: nowrap;
    }
    .historial-item .delete-single:hover { background: var(--accent-red); color: var(--bg-primary); }
    .historial-item .detalle {
      max-height: 0; overflow: hidden; transition: max-height 0.4s ease; margin-top: 0;
      color: var(--text-secondary); font-size: 13px; border-top: 1px solid transparent;
      text-align: center;
    }
    .historial-item.abierto .detalle {
      max-height: 400px; margin-top: 12px; border-top-color: var(--border-color); padding-top: 12px;
    }
    .historial-item .hora-detalle { color: var(--accent-green); font-size: 12px; margin-bottom: 6px; }
    .historial-item .predicciones { color: var(--accent-blue); font-size: 11px; margin: 6px 0; background: rgba(10,132,255,0.2); padding: 4px 8px; border-radius: 20px; display: inline-block; }
    .zonas-pastillas { display: flex; flex-wrap: wrap; gap: 6px; margin: 8px 0; justify-content: center; }
    .zona-pastilla { display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; border-radius: 20px; font-size: 10px; font-weight: bold; background: var(--bg-primary); border: 1px solid; }
    .zona-pastilla.z1 { border-color: var(--accent-blue); color: var(--accent-blue); }
    .zona-pastilla.z2 { border-color: var(--accent-green); color: var(--accent-green); }
    .zona-pastilla.z3 { border-color: var(--accent-yellow); color: var(--accent-yellow); }
    .zona-pastilla.z4 { border-color: var(--accent-red); color: var(--accent-red); }
    .zona-pastilla.z5 { border-color: var(--accent-purple); color: var(--accent-purple); }
    .zona-pastilla.z6 { border-color: var(--accent-blue); color: var(--accent-blue); }

    /* ===== MENSAJES (admin) ===== */
    .mensaje-item {
      margin-bottom: 10px; border-left: 4px solid var(--accent-blue);
      background: rgba(20,20,20,0.8); border-radius: 16px; overflow: hidden;
      backdrop-filter: blur(5px);
    }
    .mensaje-item .mensaje-header {
      padding: 16px; background: var(--bg-primary); cursor: pointer;
      display: flex; align-items: center; gap: 8px; font-weight: bold;
      color: var(--accent-blue); transition: background 0.2s; flex-wrap: wrap;
    }
    .mensaje-item .mensaje-header span:first-child { flex: 1; min-width: 150px; white-space: normal; word-break: break-word; }
    .mensaje-item .flecha { transition: transform 0.3s; margin-left: auto; }
    .mensaje-item.abierto .flecha { transform: rotate(180deg); }
    .mensaje-item.abierto .mensaje-contenido { max-height: 200px; padding: 16px; }
    .mensaje-item .mensaje-contenido { max-height: 0; overflow: hidden; transition: max-height 0.4s ease; padding: 0 16px; color: var(--text-secondary); background: var(--bg-secondary); }
    .delete-mensaje { background: transparent; border: 1px solid var(--accent-red); border-radius: 40px; color: var(--accent-red); padding: 4px 8px; font-size: 10px; cursor: pointer; flex-shrink: 0; }
    .delete-mensaje:hover { background: var(--accent-red); color: var(--bg-primary); }
    .mensaje-item.nuevo .mensaje-header { border-left: 4px solid var(--accent-red); }
    /* Borde verde para mensajes enviados no le√≠dos por el usuario */
    .mensaje-item.no-leido-usuario { border-left-color: var(--accent-green) !important; }

    /* ===== ADMIN: MODAL DE USUARIOS CON TARJETAS EXPANDIBLES ===== */
    .admin-stats {
      display: flex; gap: 12px; justify-content: center; margin: 20px 0; flex-wrap: wrap;
    }
    .stat-badge { background: var(--stat-bg); padding: 6px 14px; border-radius: 40px; border: 1px solid var(--border-color); display: inline-flex; align-items: center; gap: 6px; }
    .stat-badge .number { color: var(--stat-number); font-weight: bold; }

    .btn-ver-usuarios {
      width: 100%; padding: 16px; background: var(--accent-purple); border: none; border-radius: 40px;
      color: var(--bg-primary); font-weight: bold; cursor: pointer; margin-bottom: 20px;
      box-shadow: 0 0 20px var(--accent-purple);
    }
    .btn-ver-usuarios:hover { background: var(--accent-blue); }

    .modal-overlay {
      display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.9); backdrop-filter: blur(8px); z-index: 20000;
      align-items: center; justify-content: center;
    }
    .modal-overlay.active { display: flex; }
    .modal-content {
      background: var(--bg-card); border: 2px solid var(--border-color); border-radius: 32px;
      padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;
      box-shadow: 0 20px 40px rgba(0,0,0,0.9), 0 0 30px var(--accent-purple);
    }
    .modal-close { position: absolute; top: 20px; right: 20px; background: transparent; border: none; color: var(--text-secondary); font-size: 24px; cursor: pointer; }
    .modal-close:hover { color: var(--accent-red); }

    .usuario-item {
      background: rgba(30,30,30,0.9); border: 1px solid var(--border-color); border-radius: 16px;
      margin-bottom: 10px; overflow: hidden; backdrop-filter: blur(5px);
    }
    .usuario-header {
      padding: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;
      background: var(--bg-secondary); color: var(--accent-blue); font-weight: bold;
    }
    .usuario-header .flecha { transition: transform 0.3s; }
    .usuario-item.abierto .flecha { transform: rotate(180deg); }
    .usuario-detalle {
      max-height: 0; overflow: hidden; transition: max-height 0.4s ease; padding: 0 15px;
      background: var(--bg-primary);
    }
    .usuario-item.abierto .usuario-detalle {
      max-height: 300px; padding: 15px;
    }
    .usuario-detalle .user-details { display: flex; flex-wrap: wrap; gap: 10px; font-size: 12px; color: var(--text-secondary); margin-bottom: 12px; }
    .modal-user-actions { display: flex; gap: 8px; flex-wrap: wrap; }
    .modal-user-actions button { margin: 0; padding: 6px 12px; font-size: 11px; width: auto; }

    /* ===== BANNER PWA ===== */
    #pwa-banner {
      position: fixed; bottom: 20px; left: 20px; right: 20px; max-width: 400px; margin: 0 auto;
      background: var(--bg-card); border: 2px solid var(--accent-blue); border-radius: 40px;
      padding: 16px 24px; display: flex; align-items: center; justify-content: space-between;
      gap: 16px; z-index: 100000; box-shadow: 0 10px 30px rgba(0,0,0,0.7);
      animation: neonGlow 5s infinite;
    }
    #pwa-banner button { width: auto; margin: 0; padding: 8px 16px; background: var(--accent-blue); border: none; color: #000; font-weight: bold; cursor: pointer; }
    #pwa-banner .close-banner { background: transparent; border: 1px solid var(--border-color); color: var(--text-secondary); }

    /* ===== MODAL DETALLE SESI√ìN (mejorado) ===== */
    #detalleSesion {
      display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      width: 90%; max-width: 520px; background: var(--bg-card); border: 3px solid var(--border-color);
      border-radius: 32px; padding: 0; z-index: 10000; opacity: 0; transition: all 0.3s ease;
      box-shadow: 0 20px 40px rgba(0,0,0,0.9), 0 0 30px var(--accent-purple);
    }
    #detalleSesion.visible { opacity: 1; transform: translateX(-50%) translateY(0); }
    #modalOverlay {
      display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); z-index: 9999;
    }
    #modalOverlay.visible { display: block; }
    .modal-content {
      padding: 40px 30px 80px; position: relative; background: var(--bg-card);
      border-radius: 29px; border: 2px solid var(--border-color); text-align: center;
    }
    .modal-content.sesion-descanso { border-color: var(--border-color); }
    .modal-content.sesion-rodaje { border-color: var(--accent-blue); }
    .modal-content.sesion-series { border-color: var(--accent-green); }
    .modal-content.sesion-tempo { border-color: var(--accent-yellow); }
    .modal-content.sesion-largo { border-color: var(--accent-red); }
    #tituloSesion { margin: 0 0 20px; color: var(--accent-blue); font-size: 22px; animation: textGlow 5s infinite; }
    #descripcionSesion { color: var(--text-secondary); line-height: 1.8; font-size: 14px; text-align: center; margin-bottom: 40px; }
    .close-btn { background: var(--accent-red); color: #fff; border: none; padding: 12px 40px; border-radius: 40px; font-weight: 600; cursor: pointer; position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); box-shadow: 0 0 20px var(--accent-red); }
    .close-btn:hover { transform: translateX(-50%) scale(1.05); }

    @media (max-width: 480px) {
      .card { padding: 20px; }
      .tabs-header { flex-wrap: wrap; height: auto; }
      .tab-button { min-width: 60px; font-size: 11px; }
      .historial-item { padding: 10px 60px 10px 10px; }
      .historial-item .delete-single { right: 8px; padding: 4px 8px; font-size: 10px; }
    }
  </style>
</head>
<body>
  <!-- BANNER PWA -->
  <div id="pwa-banner" style="display:none;">
    <span>üì≤ INSTALA RI5 RGB EN TU M√ìVIL</span>
    <button onclick="window.instalarPWA()">INSTALAR</button>
    <button class="close-banner" onclick="window.cerrarBannerPWA()">‚úï</button>
  </div>

  <div class="modal-overlay" id="modalOverlay" onclick="window.cerrarModalSesion()"></div>

  <!-- MODAL BENEFICIOS PREMIUM -->
  <div id="premiumModal">
    <h2>‚ú® RI5 PREMIUM</h2>
    <p>‚úî Planes de entrenamiento de hasta 3 meses</p>
    <p>‚úî Prioridad en soporte</p>
    <p>‚úî Acceso a contenido exclusivo</p>
    <p>‚úî Historial ampliado hasta 25 entradas</p>
    <p>‚úî Y mucho m√°s...</p>
    <p>üîó Para hacerte premium, contacta por Instagram <strong>@navegacionpro</strong></p>
    <button onclick="document.getElementById('premiumModal').style.display='none'">CERRAR</button>
  </div>

  <!-- LOGIN PAGE -->
  <div class="wrapper" id="loginPage">
    <div class="card">
      <h1>RI5 RGB</h1>
      <p style="color: var(--text-secondary); margin:20px 0; text-align:center;">> SISTEMA DE ACCESO_</p>
      <div class="auth-tabs">
        <button class="auth-tab active" onclick="window.switchAuthTab('login')">[LOGIN]</button>
        <button class="auth-tab" onclick="window.switchAuthTab('register')">[REGISTRO]</button>
      </div>
      <div id="loginForm" class="auth-form active">
        <input type="text" id="loginUsername" placeholder="> USUARIO_">
        <input type="password" id="loginPassword" placeholder="> CONTRASE√ëA_">
        <div class="error-message" id="loginError"></div>
        <button class="button-main" onclick="window.loginUser()">[ ACCEDER ]</button>
      </div>
      <div id="registerForm" class="auth-form">
        <input type="text" id="regUsername" placeholder="> NUEVO USUARIO_">
        <input type="password" id="regPassword" placeholder="> NUEVA CONTRASE√ëA_">
        <div class="error-message" id="registerError"></div>
        <button class="button-main" onclick="window.registerUser()">[ REGISTRARSE ]</button>
      </div>
      <div id="dailyTip" class="curiosity" onclick="window.changeDailyTip()">
        <span>> CONSEJO DEL D√çA_</span><small>// pulsa para nuevo consejo</small>
      </div>
    </div>
  </div>

  <!-- ADMIN PAGE -->
  <div class="wrapper" id="adminPage" style="display:none;">
    <div class="card admin-card">
      <div class="app-header">
        <h1>RI5¬∑ADMIN RGB</h1>
        <button class="logout-icon" onclick="window.logoutAdmin()" title="Cerrar sesi√≥n">‚èª</button>
      </div>
      <p style="color: var(--accent-green); margin:20px 0; text-align:center;" id="adminWelcome"></p>
      <div class="tabs-container">
        <div class="tabs-header">
          <button class="tab-button active" onclick="window.switchAdminTab('usuarios')">USUARIOS</button>
          <button class="tab-button" onclick="window.switchAdminTab('soporte')" id="adminSoporteTab">SOPORTE</button>
        </div>
        <div id="admin-tab-usuarios" class="tab-content active">
          <div class="admin-stats" id="adminStats"></div>
          <div class="admin-panel">
            <button class="btn-ver-usuarios" onclick="window.abrirModalUsuarios()">üë• VER USUARIOS</button>
          </div>
          <button class="admin-btn admin-export-btn" onclick="window.exportarUsuariosCSV()" style="width:100%; margin:10px 0;">üì• EXPORTAR USUARIOS CSV</button>
          <button class="admin-btn" onclick="window.renovarExpirados()" style="width:100%;">üîÑ RENOVAR EXPIRADOS</button>
        </div>
        <div id="admin-tab-soporte" class="tab-content">
          <h2>SOPORTE</h2>
          <div class="soporte-section">
            <div class="soporte-tabs">
              <button class="soporte-tab active" onclick="window.cambiarAdminSoporteTab('recibidos')">üì• RECIBIDOS</button>
              <button class="soporte-tab" onclick="window.cambiarAdminSoporteTab('enviados')">üì§ ENVIADOS</button>
            </div>
            <div id="admin-soporte-recibidos" class="soporte-panel active">
              <div id="listaMensajesRecibidosAdmin"></div>
            </div>
            <div id="admin-soporte-enviados" class="soporte-panel">
              <div id="listaMensajesEnviadosAdmin"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL DE USUARIOS PARA ADMIN (tarjetas expandibles) -->
  <div class="modal-overlay" id="modalUsuarios">
    <div class="modal-content">
      <button class="modal-close" onclick="document.getElementById('modalUsuarios').classList.remove('active')">‚úï</button>
      <h2>üë• USUARIOS REGISTRADOS</h2>
      <div class="modal-search">
        <input type="text" id="modalBuscarUsuario" placeholder="üîç Buscar por nombre...">
      </div>
      <div class="modal-user-list" id="modalUserList"></div>
    </div>
  </div>

  <!-- MAIN APP -->
  <div class="wrapper" id="mainContent" style="display:none;">
    <div class="card">
      <div class="app-header">
        <h1 id="ri5Title" onclick="window.showPremiumBenefits()">RI5 RGB</h1>
        <button class="logout-icon" onclick="window.logoutUser()" title="Cerrar sesi√≥n">‚èª</button>
      </div>
      <p style="color: var(--text-secondary); margin:20px 0; text-align:center;" id="userWelcome"></p>
      <div class="tabs-container">
        <div class="tabs-header">
          <button class="tab-button active" onclick="window.switchTab('entreno')">ENTRENO</button>
          <button class="tab-button" onclick="window.switchTab('plan')">PLAN</button>
          <button class="tab-button" onclick="window.switchTab('historial')">HISTORIAL</button>
          <button class="tab-button" onclick="window.switchTab('soporte')" id="soporteTabButton">SOPORTE</button>
        </div>

        <!-- TAB ENTRENO -->
        <div id="tab-entreno" class="tab-content active">
          <h2>> ZONAS DE ENTRENO_</h2>
          <input id="name" placeholder="> NOMBRE_"><div class="error-message" id="nameError"></div>
          <input id="age" type="number" min="14" max="85" placeholder="> EDAD_"><div class="error-message" id="ageError"></div>
          <input id="time" placeholder="> TIEMPO 6km_ (MM:SS)"><div class="error-message" id="timeError"></div>
          <button class="button-main" id="calcBtn" disabled onclick="window.startCalc()">[ CALCULAR ]</button>
          <div class="curiosity" id="curiosity" onclick="window.changeConsejo()"><span>> CONSEJO_</span><small>// pulsa para nuevo consejo</small></div>
          <div id="results"></div>
        </div>

        <!-- TAB PLAN -->
        <div id="tab-plan" class="tab-content">
          <h2>> CREADOR DE PLANES_</h2>
          <button class="action-button btn-plan" onclick="window.toggleCuestionario()">+ NUEVO PLAN</button>
          <button class="action-button btn-view" onclick="window.mostrarUltimoPlanGuardado()">üìÇ CARGAR √öLTIMO PLAN</button>
          <button class="action-button btn-delete" onclick="window.borrarPlanGuardado()">üóëÔ∏è ELIMINAR PLAN</button>
          
          <div id="cuestionarioEntreno" style="display:none;">
            <h3>> CONFIGURACI√ìN_</h3>
            <select id="modalidad">
              <option value="runner">RUNNER (asfalto)</option>
              <option value="trail">TRAIL (monta√±a)</option>
            </select>
            <select id="distObjetivo">
              <option value="2k">2 km</option>
              <option value="5k">5 km</option>
              <option value="10k">10 km</option>
              <option value="medio">MEDIA MARAT√ìN</option>
              <option value="maraton" selected>MARAT√ìN</option>
            </select>
            <select id="duracionPlan">
              <option value="1">1 MES</option>
              <option value="3">3 MESES</option>
            </select>
            <div class="dias-semana-label">üìÖ D√çAS QUE ENTRENAS A LA SEMANA</div>
            <div class="dias-semana-container" id="diasSemanaContainer">
              <!-- Checkboxes generados por JS -->
            </div>
            <select id="nivel">
              <option value="principiante">PRINCIPIANTE</option>
              <option value="intermedio" selected>INTERMEDIO</option>
              <option value="avanzado">AVANZADO</option>
            </select>
            <select id="experienciaDistancia">
              <option value="si">CON EXPERIENCIA</option>
              <option value="no" selected>PRIMERA VEZ</option>
            </select>
            <select id="objetivoPrincipal">
              <option value="acabar">TERMINAR</option>
              <option value="mejorar" selected>MEJORAR TIEMPO</option>
              <option value="competir">COMPETIR</option>
            </select>
            <select id="diaLargo">
              <option value="1">LUNES</option><option value="2">MARTES</option><option value="3">MI√âRCOLES</option>
              <option value="4">JUEVES</option><option value="5">VIERNES</option><option value="6">S√ÅBADO</option>
              <option value="7" selected>DOMINGO</option>
            </select>
            <div class="fecha-inicio-container">
              <label for="fechaInicio">üìÖ FECHA DE INICIO</label>
              <input type="date" id="fechaInicio" value="2025-03-01">
            </div>
            <button class="action-button btn-save" onclick="window.generarCalendarioEntreno()">[ GENERAR PLAN ]</button>
            <button class="action-button btn-delete" onclick="window.toggleCuestionario()">[ CANCELAR ]</button>
          </div>

          <div id="calendarioEntreno" style="display:none;">
            <h3>> TU PLAN_</h3>
            <div class="nota-plan">Plan optimizado para tu rendimiento. Conf√≠a en el proceso.</div>
            <p id="resumenObjetivo" style="color: var(--accent-blue); margin:20px 0; text-align:center;"></p>
            <div class="calendar-grid-container">
              <div class="calendar-header"><div>L</div><div>M</div><div>X</div><div>J</div><div>V</div><div>S</div><div>D</div></div>
              <div id="calendarioGrid"></div>
            </div>
          </div>
        </div>

        <!-- TAB HISTORIAL -->
        <div id="tab-historial" class="tab-content">
          <h2>> HISTORIAL_</h2>
          <div class="historial-controls">
            <label>Mostrar:</label>
            <select id="historialLimit" onchange="window.cargarHistorial()">
              <option value="10">10</option>
              <option value="25">25</option>
            </select>
          </div>
          <div id="historialContainer"></div>
          <button class="action-button btn-delete" onclick="window.borrarHistorial()" style="margin-top:16px;">üóëÔ∏è LIMPIAR TODO EL HISTORIAL</button>
        </div>

        <!-- TAB SOPORTE -->
        <div id="tab-soporte" class="tab-content">
          <h2>> SOPORTE_</h2>
          <div class="soporte-section">
            <div class="soporte-tabs">
              <button class="soporte-tab active" onclick="window.cambiarSoporteTab('recibidos')">üì• RECIBIDOS</button>
              <button class="soporte-tab" onclick="window.cambiarSoporteTab('enviados')">üì§ ENVIADOS</button>
            </div>
            <div id="soporte-recibidos" class="soporte-panel active">
              <h3>Mensajes del administrador</h3>
              <div id="listaMensajesRecibidos"></div>
            </div>
            <div id="soporte-enviados" class="soporte-panel">
              <h3>Tus mensajes al admin</h3>
              <div class="nuevo-mensaje">
                <textarea id="mensajeUsuario" placeholder="> ESCRIBE TU CONSULTA..."></textarea>
                <button class="send-message-btn" onclick="window.enviarMensajeUsuario()">üì§ ENVIAR</button>
              </div>
              <div id="listaMensajesEnviados" style="margin-top:20px;"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- MODAL DETALLE SESI√ìN -->
      <div id="detalleSesion">
        <div class="modal-content" id="modalColorWrapper">
          <h3 id="tituloSesion"></h3>
          <div id="descripcionSesion"></div>
          <button class="close-btn" onclick="window.cerrarModalSesion()">[ CERRAR ]</button>
        </div>
      </div>

      <div class="footer" id="footer"></div>
    </div>
  </div>

  <!-- FIREBASE -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
    (function() {
      // ==================== CONFIGURACI√ìN FIREBASE ====================
      const firebaseConfig = {
        apiKey: "AIzaSyBw4VYLEeFeG4Z2qJC56iPzzuAzlIkmErc",
        authDomain: "ri5-5b642.firebaseapp.com",
        databaseURL: "https://ri5-5b642-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "ri5-5b642",
        storageBucket: "ri5-5b642.firebasestorage.app",
        messagingSenderId: "889154598385",
        appId: "1:889154598385:web:1d4e7dad605a42c1c60050"
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      // ==================== M√ìDULO UTILS ====================
      const Utils = {
        parseTime(t) { t = t.trim(); if(!t) return NaN; const m = t.match(/^(\d{1,3}):?(\d{0,2})$/); if(!m) return NaN; const min = parseInt(m[1]), seg = m[2]?parseInt(m[2]):0; if(seg>59||min>120||min<10) return NaN; return min + seg/60; },
        formatR(r) { if(!isFinite(r)||r<=0) return "--:--"; let m = Math.floor(r), s = Math.round((r-m)*60); if(s===60){ m++; s=0; } return m+":"+(s<10?'0':'')+s; },
        showLoading(btn) { btn.classList.add('loading'); btn.disabled=true; },
        hideLoading(btn) { btn.classList.remove('loading'); btn.disabled=false; },
        showTemporaryMessage(btn, msg, ok=true) { const orig = btn.innerText; btn.innerText = msg; btn.classList.add(ok?'btn-success':'btn-error'); setTimeout(()=>{ btn.innerText=orig; btn.classList.remove('btn-success','btn-error'); },2000); },
        hashPassword(str) { return btoa(str + "_RI5_SALT"); }
      };

      // ==================== M√ìDULO STORAGE ====================
      const Storage = {
        getUsers() { return db.ref('users').once('value').then(s => s.val()||{}); },
        saveUsers(u) { return db.ref('users').set(u); },
        getHistorial(u) { if(!u) return Promise.resolve([]); return db.ref('users/'+u+'/historial').once('value').then(s => s.val()||[]); },
        saveHistorial(u,h) { if(!u) return Promise.reject(); return db.ref('users/'+u+'/historial').set(h); },
        getUltimoPlan(u) { if(!u) return Promise.resolve(null); return db.ref('users/'+u+'/ultimoPlan').once('value').then(s => s.val()||null); },
        setUltimoPlan(u,p) { if(!u) return Promise.reject(); return db.ref('users/'+u+'/ultimoPlan').set(p); },
        removeUltimoPlan(u) { if(!u) return Promise.reject(); return db.ref('users/'+u+'/ultimoPlan').remove(); },
        getUltimoCalculo(u) { if(!u) return Promise.resolve(null); return db.ref('users/'+u+'/ultimoCalculo').once('value').then(s => s.val()||null); },
        setUltimoCalculo(u,c) { if(!u) return Promise.reject(); return db.ref('users/'+u+'/ultimoCalculo').set(c); },
        getMensajes() { return db.ref('mensajes').once('value').then(s => s.val()||{}); },
        saveMensajes(m) { return db.ref('mensajes').set(m); },
        getMensajesUsuario(u) { return this.getMensajes().then(t => t[u]||[]); },
        marcarLeido(u,i) { return this.getMensajes().then(t=>{ if(t[u]&&t[u][i]){ t[u][i].leido=true; return this.saveMensajes(t); } }); },
        borrarMensajeUsuario(u,i) { return this.getMensajes().then(t=>{ if(t[u]&&t[u][i]){ t[u].splice(i,1); if(t[u].length===0) delete t[u]; return this.saveMensajes(t); } }); },
        enviarMensajeUsuario(us,txt) { return this.getMensajes().then(t=>{ const k="admin_"+us; if(!t[k]) t[k]=[]; t[k].push({fecha:new Date().toLocaleString(),texto:txt,leido:false,esUsuario:true}); return this.saveMensajes(t); }); },
        enviarMensajeAdminAUsuario(us,txt) { return this.getMensajes().then(t=>{ if(!t[us]) t[us]=[]; t[us].push({fecha:new Date().toLocaleString(),texto:txt,leido:false,esAdmin:true}); return this.saveMensajes(t); }); },
        getMensajesEnviadosUsuario(u) { return this.getMensajes().then(t=> t["admin_"+u]||[]); },
        getMensajesRecibidosAdmin() { return this.getMensajes().then(t=>{ const r=[]; Object.keys(t).forEach(k=>{ if(k.startsWith('admin_')){ const u=k.replace('admin_',''); t[k].forEach((msg,idx)=> r.push({usuario:u,mensaje:msg,idx,key:k})); } }); return r; }); },
        getMensajesEnviadosAdmin() { return this.getMensajes().then(t=>{ const e=[]; Object.keys(t).forEach(k=>{ if(!k.startsWith('admin_')){ t[k].forEach((msg,idx)=> { if(msg.esAdmin) e.push({usuario:k,mensaje:msg,idx,key:k}); }); } }); return e; }); },
        borrarMensaje(k,i) { return this.getMensajes().then(t=>{ if(t[k]&&t[k][i]){ t[k].splice(i,1); if(t[k].length===0) delete t[k]; return this.saveMensajes(t); } }); }
      };

      // ==================== ESTADO GLOBAL ====================
      const AppState = {
        zonasCalculadas: false, lastName: "", lastAge: 0, lastFC: 0, lastUL: 0,
        lastZones: [], lastPred: [], lastRitmoBase: 0,
        ultimoPlanParams: null, planGeneradoActual: null,
        camposTocados: { name: false, age: false, time: false },
        currentUser: null, currentSesionDetalle: null, deferredPrompt: null,
        mensajesNoLeidos: 0, mensajesNoLeidosAdmin: 0,
        isPremium: false, usuariosVistos: JSON.parse(localStorage.getItem('usuariosVistos')||'[]'),
        setLastCalc(d) { this.lastName=d.name; this.lastAge=d.age; this.lastFC=d.fcMax; this.lastUL=d.ul; this.lastZones=d.zones; this.lastPred=d.pred; this.lastRitmoBase=d.ritmoBase; this.zonasCalculadas=true; },
        clearLastCalc() { this.zonasCalculadas=false; this.lastName=""; this.lastAge=0; this.lastFC=0; this.lastUL=0; this.lastZones=[]; this.lastPred=[]; this.lastRitmoBase=0; },
        setCurrentUser(u, premium=false) {
          this.currentUser = u; this.isPremium = premium;
          u?localStorage.setItem('ri5_current_user',u):localStorage.removeItem('ri5_current_user');
          const t = document.getElementById('ri5Title'); if(t){ if(premium) t.classList.add('premium'); else t.classList.remove('premium'); }
          // Autocompletar campo nombre
          if(u) document.getElementById('name').value = u;
        }
      };

      // ==================== M√ìDULO AUTENTICACI√ìN ====================
      const Auth = {
        switchAuthTab(tab) { document.querySelectorAll('.auth-tab').forEach(b=>b.classList.remove('active')); document.querySelectorAll('.auth-form').forEach(f=>f.classList.remove('active')); if(tab==='login'){ document.querySelector('.auth-tab').classList.add('active'); document.getElementById('loginForm').classList.add('active'); }else{ document.querySelectorAll('.auth-tab')[1].classList.add('active'); document.getElementById('registerForm').classList.add('active'); } },
        async registerUser() {
          const u = document.getElementById('regUsername').value.trim(), p = document.getElementById('regPassword').value.trim(), err = document.getElementById('registerError');
          if(!u||!p) { err.innerText="> COMPLETA TODOS LOS CAMPOS_"; err.classList.add('visible'); return; }
          if(u.length<3) { err.innerText="> M√çNIMO 3 CARACTERES_"; err.classList.add('visible'); return; }
          if(p.length<4) { err.innerText="> M√çNIMO 4 CARACTERES_"; err.classList.add('visible'); return; }
          const users = await Storage.getUsers();
          if(users[u]) { err.innerText="> EL USUARIO YA EXISTE_"; err.classList.add('visible'); return; }
          const expiry = new Date(); expiry.setMonth(expiry.getMonth()+3);
          users[u] = { password: Utils.hashPassword(p), created: new Date().toISOString(), expires: expiry.toISOString(), premium: true };
          await Storage.saveUsers(users);
          await Storage.enviarMensajeAdminAUsuario(u, "¬°Bienvenido a RI5 RGB! Disfruta de 3 meses premium.");
          AppState.setCurrentUser(u, true);
          document.getElementById("loginPage").style.opacity="0";
          setTimeout(()=>{
            document.getElementById("loginPage").style.display="none";
            document.getElementById("mainContent").style.display="flex";
            document.getElementById("userWelcome").innerText = `> BIENVENIDO, ${u.toUpperCase()}_ ¬∑ PREMIUM HASTA ${expiry.toLocaleDateString()}`;
            UI.changeDailyTip(); UI.startConsejoAutoChange();
          },300);
        },
        async loginUser() {
          const u = document.getElementById('loginUsername').value.trim(), p = document.getElementById('loginPassword').value.trim(), err = document.getElementById('loginError');
          if(!u||!p) { err.innerText="> INTRODUCE USUARIO Y CONTRASE√ëA_"; err.classList.add('visible'); return; }
          if(u==='admin' && p==='091118110485120385') { Auth.mostrarAdminPanel(); return; }
          const users = await Storage.getUsers();
          const user = users[u];
          if(!user || user.password !== Utils.hashPassword(p)) { err.innerText="> INCORRECTO_"; err.classList.add('visible'); return; }
          const now = new Date(), expiry = new Date(user.expires);
          if(now>expiry){ if(user.premium) alert("> Tu per√≠odo premium ha expirado."); else { err.innerText="> ACCESO EXPIRADO_"; err.classList.add('visible'); return; } }
          AppState.setCurrentUser(u, user.premium||false);
          const msgs = await Storage.getMensajesUsuario(u);
          AppState.mensajesNoLeidos = msgs.filter(m=>!m.leido).length;
          UI.actualizarBadgeMensajes();
          document.getElementById("loginPage").style.opacity="0";
          setTimeout(()=>{
            document.getElementById("loginPage").style.display="none";
            document.getElementById("mainContent").style.display="flex";
            document.getElementById("userWelcome").innerText = `> BIENVENIDO, ${u.toUpperCase()}_ ¬∑ ${user.premium?'PREMIUM':'ACCESO'} HASTA ${expiry.toLocaleDateString()}`;
            UI.changeDailyTip(); UI.startConsejoAutoChange();
            UI.cargarMensajesRecibidos(); UI.cargarMensajesEnviados();
            Storage.getUltimoCalculo(u).then(c=>{ if(c){ AppState.setLastCalc(c); UI.mostrarResultadosGuardados(c); } });
          },300);
        },
        mostrarAdminPanel() { document.getElementById("loginPage").style.display="none"; document.getElementById("mainContent").style.display="none"; document.getElementById("adminPage").style.display="flex"; Admin.actualizarAdminPanel(); },
        logoutUser() { if(!confirm("> ¬øCERRAR SESI√ìN?_")) return; AppState.setCurrentUser(null); document.getElementById("mainContent").style.display="none"; document.getElementById("loginPage").style.display="flex"; document.getElementById("loginUsername").value=''; document.getElementById("loginPassword").value=''; document.getElementById("results").innerHTML=''; document.getElementById("calendarioEntreno").style.display="none"; AppState.clearLastCalc(); },
        logoutAdmin() { document.getElementById("adminPage").style.display="none"; document.getElementById("loginPage").style.display="flex"; },
        async checkSavedSession() {
          const s = localStorage.getItem('ri5_current_user'); if(!s) return false;
          const users = await Storage.getUsers(); const user = users[s];
          if(!user){ localStorage.removeItem('ri5_current_user'); return false; }
          const now = new Date(), expiry = new Date(user.expires);
          if(now>expiry && !user.premium){ localStorage.removeItem('ri5_current_user'); return false; }
          AppState.currentUser = s; AppState.isPremium = user.premium||false;
          document.getElementById("loginPage").style.display="none";
          document.getElementById("mainContent").style.display="flex";
          document.getElementById("userWelcome").innerText = `> BIENVENIDO, ${s.toUpperCase()}_ ¬∑ ${user.premium?'PREMIUM':'ACCESO'} HASTA ${expiry.toLocaleDateString()}`;
          if(now>expiry && user.premium) setTimeout(()=>alert("> Tu per√≠odo premium ha expirado."),500);
          document.getElementById('name').value = s; // autocompletar
          UI.changeDailyTip(); UI.startConsejoAutoChange();
          const calc = await Storage.getUltimoCalculo(s); if(calc){ AppState.setLastCalc(calc); UI.mostrarResultadosGuardados(calc); }
          return true;
        },
        showPremiumBenefits() { document.getElementById('premiumModal').style.display='block'; }
      };

      // ==================== M√ìDULO ADMIN ====================
      const Admin = {
        async actualizarAdminPanel() {
          const users = await Storage.getUsers();
          const total = Object.keys(users).length, ahora = new Date();
          const activos = Object.values(users).filter(u=>new Date(u.expires)>ahora).length, expirados = total-activos;
          document.getElementById("adminStats").innerHTML = `<span class="stat-badge">üìä TOTAL <span class="number">${total}</span></span><span class="stat-badge">‚úÖ ACTIVOS <span class="number">${activos}</span></span><span class="stat-badge">‚è≥ EXPIRADOS <span class="number">${expirados}</span></span>`;
          document.getElementById("adminWelcome").innerText = `> ADMIN ¬∑ ${new Date().toLocaleString()}`;
          this.cargarMensajesAdmin();
        },
        async abrirModalUsuarios() {
          const users = await Storage.getUsers();
          const modal = document.getElementById('modalUsuarios');
          const listEl = document.getElementById('modalUserList');
          this.renderizarListaUsuarios(users, listEl);
          modal.classList.add('active');
          document.getElementById('modalBuscarUsuario').oninput = (e)=>this.filtrarUsuariosModal(e.target.value);
        },
        renderizarListaUsuarios(users, container, filtro='') {
          const ahora = new Date();
          const items = Object.entries(users).filter(([u])=>u.toLowerCase().includes(filtro.toLowerCase())).map(([u,d])=>{
            const creado = new Date(d.created).toLocaleDateString();
            const expiry = new Date(d.expires).toLocaleDateString();
            const premium = d.premium ? '‚úÖ PREMIUM' : '‚ùå NO PREMIUM';
            return `
              <div class="usuario-item" onclick="window.toggleUsuario(this)">
                <div class="usuario-header">
                  <span>${u}</span>
                  <span class="flecha">‚ñº</span>
                </div>
                <div class="usuario-detalle">
                  <div class="user-details">
                    <span>üìÖ ${creado}</span>
                    <span>‚è≥ ${expiry}</span>
                    <span>${premium}</span>
                  </div>
                  <div class="modal-user-actions">
                    <button onclick="event.stopPropagation(); window.extenderUsuario('${u}',1)">+1 MES</button>
                    <button onclick="event.stopPropagation(); window.extenderUsuario('${u}',3)">+3 MESES</button>
                    <button onclick="event.stopPropagation(); window.togglePremium('${u}')">üëë PREMIUM</button>
                    <button onclick="event.stopPropagation(); window.enviarMensajeAUsuario('${u}')">üì® MENSAJE</button>
                    <button onclick="event.stopPropagation(); window.eliminarUsuario('${u}')">ELIMINAR</button>
                  </div>
                </div>
              </div>
            `;
          }).join('');
          container.innerHTML = items || '<p style="text-align:center; padding:20px;">üì≠ NO HAY USUARIOS</p>';
        },
        filtrarUsuariosModal(filtro) { Storage.getUsers().then(u=>{ const l=document.getElementById('modalUserList'); this.renderizarListaUsuarios(u,l,filtro); }); },
        async extenderUsuario(u,m) {
          const users = await Storage.getUsers();
          if(users[u]){ const e=new Date(users[u].expires); e.setMonth(e.getMonth()+m); users[u].expires=e.toISOString(); await Storage.saveUsers(users); this.actualizarAdminPanel(); alert(`‚úÖ ${u} extendido ${m} mes`); this.abrirModalUsuarios(); }
        },
        async togglePremium(u) {
          const users = await Storage.getUsers();
          if(users[u]){ users[u].premium = !users[u].premium; await Storage.saveUsers(users); this.actualizarAdminPanel(); alert(`‚úÖ Premium de ${u} cambiado`); this.abrirModalUsuarios(); }
        },
        async eliminarUsuario(u) {
          if(!confirm(`> ¬øELIMINAR "${u}"?`)) return;
          const users = await Storage.getUsers();
          delete users[u]; await Storage.saveUsers(users);
          if(AppState.currentUser===u) AppState.setCurrentUser(null);
          this.actualizarAdminPanel(); alert(`‚úÖ ${u} eliminado`); this.abrirModalUsuarios();
        },
        exportarUsuariosCSV() { Storage.getUsers().then(u=>{ let csv="Usuario,Creado,Expira,Premium,Estado\n"; Object.entries(u).forEach(([u,d])=>csv+=`${u},${new Date(d.created).toLocaleDateString()},${new Date(d.expires).toLocaleDateString()},${d.premium?'SI':'NO'},${new Date()<=new Date(d.expires)?'ACTIVO':'EXPIRADO'}\n`); const b=new Blob([csv],{type:'text/csv'}), a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=`usuarios_${new Date().toISOString().split('T')[0]}.csv`; a.click(); URL.revokeObjectURL(a.href); }); },
        async renovarExpirados() {
          if(!confirm("> ¬øRENOVAR TODOS LOS EXPIRADOS POR 1 MES?")) return;
          const users = await Storage.getUsers(), ahora=new Date();
          Object.entries(users).forEach(([u,d])=>{ if(new Date(d.expires)<=ahora){ const e=new Date(d.expires); e.setMonth(e.getMonth()+1); users[u].expires=e.toISOString(); } });
          await Storage.saveUsers(users); this.actualizarAdminPanel(); alert("‚úÖ EXPIRADOS RENOVADOS");
        },
        async enviarMensajeAUsuario(usuario) { const txt=prompt(`> MENSAJE PARA ${usuario}:`); if(!txt) return; await Storage.enviarMensajeAdminAUsuario(usuario,txt); alert("‚úÖ ENVIADO"); this.cargarMensajesAdmin(); },
        async cargarMensajesAdmin() {
          const recibidos = await Storage.getMensajesRecibidosAdmin();
          let htmlRec='', noLeidosRecibidos=0;
          recibidos.forEach(item=>{
            if(!item.mensaje.leido) noLeidosRecibidos++;
            htmlRec+=`<div class="mensaje-item"><div class="mensaje-header" onclick="this.parentNode.classList.toggle('abierto')"><span>üì® ${item.mensaje.fecha} ¬∑ ${item.usuario}</span><span class="flecha">‚ñº</span><button class="delete-mensaje" onclick="event.stopPropagation(); window.borrarMensajeAdmin('${item.key}',${item.idx})">üóëÔ∏è</button></div><div class="mensaje-contenido">${item.mensaje.texto}</div></div>`;
          });
          document.getElementById('listaMensajesRecibidosAdmin').innerHTML = htmlRec || '<p>üì≠ NO HAY MENSAJES</p>';
          const enviados = await Storage.getMensajesEnviadosAdmin();
          let htmlEnv='';
          enviados.forEach(item=>{
            const claseNoLeido = !item.mensaje.leido ? 'no-leido-usuario' : '';
            htmlEnv+=`<div class="mensaje-item ${claseNoLeido}"><div class="mensaje-header" onclick="this.parentNode.classList.toggle('abierto')"><span>üì§ ${item.mensaje.fecha} ¬∑ <strong style="color:var(--accent-green);">üë§ ${item.usuario}</strong></span><span class="flecha">‚ñº</span><button class="delete-mensaje" onclick="event.stopPropagation(); window.borrarMensajeAdmin('${item.key}',${item.idx})">üóëÔ∏è</button></div><div class="mensaje-contenido"><div style="margin-bottom:8px;color:var(--accent-green);"><strong>Para: ${item.usuario}</strong></div>${item.mensaje.texto}</div></div>`;
          });
          document.getElementById('listaMensajesEnviadosAdmin').innerHTML = htmlEnv || '<p>üì≠ NO HAS ENVIADO MENSAJES</p>';
          AppState.mensajesNoLeidosAdmin = noLeidosRecibidos;
          this.actualizarBadgeAdminSoporte();
        },
        actualizarBadgeAdminSoporte() { const t=document.getElementById('adminSoporteTab'); if(AppState.mensajesNoLeidosAdmin>0) t.classList.add('soporte-unread'); else t.classList.remove('soporte-unread'); },
        cambiarSoporteTab(tab) { document.querySelectorAll('#admin-tab-soporte .soporte-tab').forEach(t=>t.classList.remove('active')); document.querySelectorAll('#admin-tab-soporte .soporte-panel').forEach(p=>p.classList.remove('active')); if(tab==='recibidos'){ document.querySelectorAll('#admin-tab-soporte .soporte-tab')[0].classList.add('active'); document.getElementById('admin-soporte-recibidos').classList.add('active'); }else{ document.querySelectorAll('#admin-tab-soporte .soporte-tab')[1].classList.add('active'); document.getElementById('admin-soporte-enviados').classList.add('active'); } }
      };

      window.toggleUsuario = (el)=>el.classList.toggle('abierto');
      window.abrirModalUsuarios = Admin.abrirModalUsuarios.bind(Admin);
      window.extenderUsuario = Admin.extenderUsuario.bind(Admin);
      window.togglePremium = Admin.togglePremium.bind(Admin);
      window.eliminarUsuario = Admin.eliminarUsuario.bind(Admin);
      window.enviarMensajeAUsuario = Admin.enviarMensajeAUsuario.bind(Admin);
      window.exportarUsuariosCSV = Admin.exportarUsuariosCSV.bind(Admin);
      window.renovarExpirados = Admin.renovarExpirados.bind(Admin);
      window.borrarMensajeAdmin = (k,i)=>Storage.borrarMensaje(k,i).then(()=>Admin.cargarMensajesAdmin());
      window.switchAdminTab = function(tab) {
        document.querySelectorAll('#adminPage .tab-button').forEach(b=>b.classList.remove('active'));
        document.querySelectorAll('#adminPage .tab-content').forEach(c=>c.classList.remove('active'));
        if(tab==='usuarios'){ document.querySelectorAll('#adminPage .tab-button')[0].classList.add('active'); document.getElementById('admin-tab-usuarios').classList.add('active'); }
        else { document.querySelectorAll('#adminPage .tab-button')[1].classList.add('active'); document.getElementById('admin-tab-soporte').classList.add('active'); Admin.cargarMensajesAdmin(); }
      };
      window.cambiarAdminSoporteTab = (tab)=>Admin.cambiarSoporteTab(tab);

      // ==================== M√ìDULO ENTRENAMIENTO ====================
      const Training = {
        startCalc() { UI.validarTodo(); if(document.getElementById("calcBtn").disabled) return; const b=document.getElementById("calcBtn"); Utils.showLoading(b); setTimeout(()=>{ this.calculate(); Utils.hideLoading(b); Utils.showTemporaryMessage(b,"‚úì CALCULADO",true); document.getElementById('results').scrollIntoView({behavior:'smooth'}); },300); },
        calculate() {
          const n=document.getElementById("name").value.trim(), a=parseInt(document.getElementById("age").value), t=Utils.parseTime(document.getElementById("time").value);
          if(!n||!a||isNaN(t)) return alert("> COMPLETA TODOS LOS CAMPOS CORRECTAMENTE_");
          const r=t/6, fc=220-a, ul=Math.round(fc*0.92*1.03);
          const pred=[{dist:2,color:"var(--accent-blue)",ritmo:r*0.98},{dist:6,color:"var(--accent-green)",ritmo:r},{dist:10,color:"var(--accent-yellow)",ritmo:r*1.05},{dist:21,color:"var(--accent-red)",ritmo:r*1.12},{dist:42,color:"var(--accent-purple)",ritmo:r*1.20}];
          const zones=[
            ["Z1","RECUPERACI√ìN",0.75,0.80,1.35,"z1","RITMO: "+Utils.formatR(r*1.35)+"<br><br>üîπ Recuperaci√≥n activa."],
            ["Z2","BASE",0.80,0.90,1.25,"z2","RITMO: "+Utils.formatR(r*1.25)+"<br><br>üîπ Mejora eficiencia metab√≥lica."],
            ["Z3","TEMPO",0.90,0.95,1.15,"z3","RITMO: "+Utils.formatR(r*1.15)+"<br><br>üîπ Tolerancia al lactato."],
            ["Z4","UMBRAL",0.95,1.02,1.05,"z4","RITMO: "+Utils.formatR(r*1.05)+"<br><br>üîπ Limpieza de lactato."],
            ["Z5","VO‚ÇÇM√ÅX",1.02,1.06,0.95,"z5","RITMO: "+Utils.formatR(r*0.95)+"<br><br>üîπ Potencia aer√≥bica m√°xima."],
            ["Z6","VELOCIDAD",1.06,1.12,0.85,"z6","RITMO: "+Utils.formatR(r*0.85)+"<br><br>üîπ Potencia neuromuscular."]
          ];
          const calc = {name:n, age:a, fcMax:fc, ul:ul, zones, pred, ritmoBase:r};
          AppState.setLastCalc(calc); UI.mostrarResultados(calc); document.getElementById("footer").innerText=`${n} ¬∑ ${new Date().toLocaleDateString('es-ES')} ¬∑ RI5 RGB`;
          this.guardarCalculoAutomatico(calc);
        },
        async guardarCalculoAutomatico(calc) {
          if(!AppState.currentUser) return;
          const ahora=new Date();
          let zonasResumen = calc.zones.map(z=>{ const min=Math.round(calc.ul*z[2]), max=Math.round(calc.ul*z[3]); return {zona:z[0],min,max}; });
          const data = { date: ahora.toLocaleDateString('es-ES'), hora: ahora.toLocaleTimeString('es-ES'), nombre:calc.name, edad:calc.age, fcMax:calc.fcMax, umbral:calc.ul, ritmo6k:Utils.formatR(calc.ritmoBase), predicciones:calc.pred.map(p=>`${p.dist}km:${Utils.formatR(p.ritmo)}`).join(' '), resumen:`${calc.name} ¬∑ ${calc.age} a√±os ¬∑ 6km: ${Utils.formatR(calc.ritmoBase)}`, zonasResumen };
          let hist = await Storage.getHistorial(AppState.currentUser);
          hist.unshift(data); const lim = AppState.isPremium?25:10; if(hist.length>lim) hist.pop();
          await Storage.saveHistorial(AppState.currentUser, hist);
          await Storage.setUltimoCalculo(AppState.currentUser, calc);
          if(document.getElementById('tab-historial').classList.contains('active')) UI.cargarHistorial();
        },
        copyResults() {
          if(!AppState.lastName) return alert("> CALCULA ZONAS PRIMERO_");
          let txt = "üîπ RI5 RGB - ZONAS DE ENTRENO üîπ\n\n";
          txt += `üë§ ${AppState.lastName} ¬∑ ${AppState.lastAge} a√±os\n‚ù§Ô∏è FC M√ÅX: ${AppState.lastFC} lpm ¬∑ UMBRAL: ${AppState.lastUL} lpm\n‚è±Ô∏è RITMO 6km: ${Utils.formatR(AppState.lastRitmoBase)} min/km\n\nüìä PREDICCIONES:\n`;
          AppState.lastPred.forEach(p=>txt+=`   ${p.dist} km ‚Üí ${Utils.formatR(p.ritmo)} min/km\n`);
          txt+=`\nüéØ ZONAS:\n`;
          AppState.lastZones.forEach(z=>{ const min=Math.round(AppState.lastUL*z[2]), max=Math.round(AppState.lastUL*z[3]); txt+=`   ${z[0]} ${z[1]}: ${min}-${max} lpm ¬∑ ${z[6].replace(/<br>/g,' ').replace(/üîπ/g,'‚Ä¢')}\n`; });
          navigator.clipboard.writeText(txt).then(()=>{ const btn=document.querySelector('.btn-copy'); if(btn) Utils.showTemporaryMessage(btn,"‚úÖ COPIADO",true); }).catch(()=>alert("> NO SE PUDO COPIAR."));
        }
      };

      // ==================== M√ìDULO UI ====================
      const UI = {
        consejos: ["La constancia es la clave.", "El descanso es entrenamiento.", "Conf√≠a en el proceso.", "La Z2 es tu mejor amiga.", "Hidrataci√≥n antes de sed.", "El sue√±o construye resistencia.", "Escucha a tu cuerpo.", "La nutrici√≥n es el combustible."],
        consejoIndex:0,
        changeDailyTip() { const e=document.getElementById("dailyTip"); if(e) setTimeout(()=>{ e.innerHTML='<span>> '+this.consejos[this.consejoIndex]+'</span><small>// pulsa para otro</small>'; this.consejoIndex=(this.consejoIndex+1)%this.consejos.length; },100); },
        changeConsejo() { const e=document.getElementById("curiosity"); if(e) setTimeout(()=>{ e.innerHTML='<span>'+this.consejos[this.consejoIndex]+'</span><small>// pulsa para otro</small>'; this.consejoIndex=(this.consejoIndex+1)%this.consejos.length; },100); },
        startConsejoAutoChange() { setInterval(()=>{ if(document.getElementById("loginPage").style.display!=="none") this.changeDailyTip(); if(document.getElementById("mainContent").style.display!=="none") this.changeConsejo(); },8000); },
        marcarCampoTocado(c) { AppState.camposTocados[c]=true; this.validarCampo(c); this.validarTodo(); },
        validarCampo(c) {
          const el=document.getElementById(c), err=document.getElementById(c+'Error');
          if(!AppState.camposTocados[c]){ err.classList.remove('visible'); el.classList.remove('error'); return true; }
          let ok=true;
          if(c==='name') ok=el.value.trim().length>=2;
          else if(c==='age'){ const a=parseInt(el.value); ok=!isNaN(a)&&a>=14&&a<=85; }
          else if(c==='time'){ const t=Utils.parseTime(el.value); ok=!isNaN(t)&&t>=12&&t<=90; }
          if(!ok){ err.innerText=c==='name'?'> M√çNIMO 2 CARACTERES_':c==='age'?'> EDAD 14-85_':'> FORMATO MM:SS (12-90 MIN)_'; err.classList.add('visible'); el.classList.add('error'); }
          else{ err.classList.remove('visible'); el.classList.remove('error'); }
          return ok;
        },
        validarTodo() { const n=this.validarCampo('name'), a=this.validarCampo('age'), t=this.validarCampo('time'); document.getElementById("calcBtn").disabled = !(n&&a&&t); },
        mostrarResultados(d) { let html=`<h2>> M√âTRICAS_</h2><div style="text-align:center; margin:20px 0;">${d.name} ¬∑ ${d.age} a√±os<br>FC M√ÅX: ${d.fcMax} lpm ¬∑ UMBRAL: ${d.ul} lpm<br>RITMO 6km: ${Utils.formatR(d.ritmoBase)} min/km</div><h2>> PREDICCIONES_</h2>`; d.pred.forEach(p=>html+=`<div class="pred-bar" style="border-color:${p.color}; color:${p.color};">${p.dist} km ‚Üí ${Utils.formatR(p.ritmo)} min/km</div>`); html+=`<h2>> ZONAS_</h2>`; d.zones.forEach(z=>{ const min=Math.round(d.ul*z[2]), max=Math.round(d.ul*z[3]); html+=`<div class="zone-card ${z[5]}" onclick="this.classList.toggle('active')"><strong>${z[0]} ‚Äì ${z[1]}</strong><br>FC: ${min}-${max} lpm<div class="long">${z[6]}</div></div>`; }); html+=`<button class="action-button btn-copy" onclick="window.copyResults()">üìã COPIAR</button>`; document.getElementById("results").innerHTML=html; },
        mostrarResultadosGuardados(d) { this.mostrarResultados(d); },
        switchTab(tab) {
          document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
          const btns = document.querySelectorAll('.tab-button');
          for(let b of btns) if(b.textContent.includes(tab==='entreno'?'ENTRENO':tab==='plan'?'PLAN':tab==='historial'?'HISTORIAL':'SOPORTE')){ b.classList.add('active'); break; }
          document.getElementById(`tab-${tab}`).classList.add('active');
          if(tab==='historial') this.cargarHistorial();
          if(tab==='soporte'){ this.cargarMensajesRecibidos(); this.cargarMensajesEnviados(); }
        },
        async cargarHistorial() {
          const cont=document.getElementById("historialContainer");
          if(!AppState.currentUser){ cont.innerHTML='<p style="text-align:center; padding:20px; color: var(--text-secondary);">üì≠ SIN USUARIO</p>'; return; }
          let hist = await Storage.getHistorial(AppState.currentUser);
          const lim = parseInt(document.getElementById('historialLimit').value); if(hist.length>lim) hist = hist.slice(0,lim);
          if(!hist.length){ cont.innerHTML='<p style="text-align:center; padding:20px; color: var(--text-secondary);">üì≠ SIN HISTORIAL</p>'; return; }
          let html='<div class="historial-list">';
          hist.forEach((it,i)=>{
            let zonas=''; if(it.zonasResumen&&Array.isArray(it.zonasResumen)){ zonas='<div class="zonas-pastillas">'; it.zonasResumen.forEach(z=>zonas+=`<span class="zona-pastilla ${z.zona.toLowerCase()}"><span></span> ${z.zona}: ${z.min}-${z.max}</span>`); zonas+='</div>'; }
            const pred = it.predicciones?`<div class="predicciones">üìä ${it.predicciones}</div>`:'';
            const hora = it.hora?`<div class="hora-detalle">üïí ${it.hora}</div>`:'';
            html+=`<div class="historial-item" onclick="window.toggleHistorialDetalle(this)">
              <div class="fecha">üìÖ ${it.date}</div>
              <div class="resumen">${it.resumen||it.nombre+' ¬∑ '+it.edad+' a√±os'}</div>
              <button class="delete-single" onclick="event.stopPropagation(); window.borrarEntradaHistorial(${i})">üóëÔ∏è BORRAR</button>
              <div class="detalle">${hora}${pred}${zonas}${it.fcMax?`<div>‚ù§Ô∏è FC M√°x: ${it.fcMax} lpm</div>`:''}${it.umbral?`<div>‚ö° Umbral: ${it.umbral} lpm</div>`:''}</div>
            </div>`;
          });
          html+='</div>'; cont.innerHTML=html;
        },
        toggleHistorialDetalle(el){ el.classList.toggle('abierto'); },
        async borrarEntradaHistorial(i){
          if(!AppState.currentUser||!confirm("> ¬øELIMINAR ESTA ENTRADA?_")) return;
          let hist=await Storage.getHistorial(AppState.currentUser); hist.splice(i,1); await Storage.saveHistorial(AppState.currentUser,hist); this.cargarHistorial(); alert("‚úÖ ELIMINADA");
        },
        async borrarHistorial(){
          if(!AppState.currentUser||!confirm("> ¬øELIMINAR TODO EL HISTORIAL?_")) return;
          await Storage.saveHistorial(AppState.currentUser,[]); this.cargarHistorial(); alert("‚úÖ HISTORIAL LIMPIO");
        },
        async cargarMensajesRecibidos(){
          if(!AppState.currentUser) return;
          const msgs=await Storage.getMensajesUsuario(AppState.currentUser);
          let html=''; msgs.forEach((m,i)=>{
            const nuevo=!m.leido?'nuevo':'';
            html+=`<div class="mensaje-item ${nuevo}" data-indice="${i}"><div class="mensaje-header" onclick="window.toggleMensajeRecibido(this,${i})"><span>üì® ${m.fecha} ¬∑ Admin</span><span class="flecha">‚ñº</span><button class="delete-mensaje" onclick="event.stopPropagation(); window.borrarMensajeUsuario(${i})">üóëÔ∏è</button></div><div class="mensaje-contenido">${m.texto}</div></div>`;
          });
          document.getElementById('listaMensajesRecibidos').innerHTML = html || '<p>üì≠ NO HAY MENSAJES</p>';
          this.actualizarBadgeMensajes();
        },
        async borrarMensajeUsuario(i){ if(!AppState.currentUser||!confirm("> ¬øELIMINAR?")) return; await Storage.borrarMensajeUsuario(AppState.currentUser,i); this.cargarMensajesRecibidos(); alert("‚úÖ ELIMINADO"); },
        async cargarMensajesEnviados(){
          if(!AppState.currentUser) return;
          const msgs=await Storage.getMensajesEnviadosUsuario(AppState.currentUser);
          let html=''; msgs.forEach(m=>{ html+=`<div class="mensaje-item"><div class="mensaje-header" onclick="this.parentNode.classList.toggle('abierto')"><span>üì§ ${m.fecha} ¬∑ T√∫</span><span class="flecha">‚ñº</span></div><div class="mensaje-contenido">${m.texto}</div></div>`; });
          document.getElementById('listaMensajesEnviados').innerHTML = html || '<p>üì≠ NO HAS ENVIADO MENSAJES</p>';
        },
        async toggleMensajeRecibido(h,i){ const it=h.closest('.mensaje-item'); it.classList.toggle('abierto'); if(it.classList.contains('nuevo')&&it.classList.contains('abierto')){ it.classList.remove('nuevo'); if(AppState.currentUser){ await Storage.marcarLeido(AppState.currentUser,i); const msgs=await Storage.getMensajesUsuario(AppState.currentUser); AppState.mensajesNoLeidos=msgs.filter(m=>!m.leido).length; this.actualizarBadgeMensajes(); } } },
        async enviarMensajeUsuario(){ if(!AppState.currentUser) return; const t=document.getElementById('mensajeUsuario').value.trim(); if(!t) return alert('> ESCRIBE UN MENSAJE_'); await Storage.enviarMensajeUsuario(AppState.currentUser,t); document.getElementById('mensajeUsuario').value=''; this.cargarMensajesEnviados(); alert('‚úÖ ENVIADO'); },
        cambiarSoporteTab(tab){ document.querySelectorAll('#tab-soporte .soporte-tab').forEach(t=>t.classList.remove('active')); document.querySelectorAll('#tab-soporte .soporte-panel').forEach(p=>p.classList.remove('active')); if(tab==='recibidos'){ document.querySelectorAll('#tab-soporte .soporte-tab')[0].classList.add('active'); document.getElementById('soporte-recibidos').classList.add('active'); }else{ document.querySelectorAll('#tab-soporte .soporte-tab')[1].classList.add('active'); document.getElementById('soporte-enviados').classList.add('active'); } },
        actualizarBadgeMensajes(){ const t=document.getElementById('soporteTabButton'); if(AppState.mensajesNoLeidos>0) t.classList.add('soporte-unread'); else t.classList.remove('soporte-unread'); },
        cerrarModalSesion(){ const m=document.getElementById("detalleSesion"), o=document.getElementById("modalOverlay"); m.classList.remove("visible"); o.classList.remove("visible"); setTimeout(()=>m.style.display="none",350); },
        cerrarPlan(){ document.getElementById("calendarioEntreno").style.display="none"; AppState.planGeneradoActual=null; },
        initDiasCheckboxes(){ const c=document.getElementById('diasSemanaContainer'); const dias=['L','M','X','J','V','S','D']; let h=''; for(let i=0;i<7;i++){ const n=i+1; h+=`<div class="dia-checkbox"><input type="checkbox" id="dia${n}" value="${n}" ${n===4||n===6?'checked':''}><label for="dia${n}">${dias[i]}</label></div>`; } c.innerHTML=h; }
      };

      window.toggleHistorialDetalle = UI.toggleHistorialDetalle.bind(UI);
      window.borrarMensajeUsuario = UI.borrarMensajeUsuario.bind(UI);
      window.toggleMensajeRecibido = UI.toggleMensajeRecibido.bind(UI);
      window.enviarMensajeUsuario = UI.enviarMensajeUsuario.bind(UI);
      window.cambiarSoporteTab = UI.cambiarSoporteTab.bind(UI);
      window.cargarHistorial = UI.cargarHistorial.bind(UI);
      window.borrarEntradaHistorial = UI.borrarEntradaHistorial.bind(UI);
      window.borrarHistorial = UI.borrarHistorial.bind(UI);
      window.cerrarModalSesion = UI.cerrarModalSesion.bind(UI);
      window.cerrarPlan = UI.cerrarPlan.bind(UI);

      // ==================== M√ìDULO PLAN GENERATOR (mejorado) ====================
      const PlanGenerator = {
        // Matriz ampliada con m√°s variedad
        ENTRENAMIENTOS_DB: (function(){
          // Aqu√≠ se incluye una matriz muy completa, pero por brevedad usaremos la misma que antes,
          // pero con m√°s opciones. En la pr√°ctica, se puede expandir con un objeto gigante.
          // Por simplicidad, mantenemos la estructura original, pero en un entorno real se a√±adir√≠an muchas m√°s sesiones.
          return {
            runner: {
              "2k": {
                principiante: { rodaje:[ /*...*/ ], series:[ /*...*/ ], tempo:[ /*...*/ ], largo:[ /*...*/ ] },
                intermedio: { rodaje:[ /*...*/ ], series:[ /*...*/ ], tempo:[ /*...*/ ], largo:[ /*...*/ ] },
                avanzado: { rodaje:[ /*...*/ ], series:[ /*...*/ ], tempo:[ /*...*/ ], largo:[ /*...*/ ] }
              },
              "5k": { ... },
              "10k": { ... },
              "medio": { ... },
              "maraton": { ... }
            },
            trail: { ... }
          };
        })(),
        toggleCuestionario() { if(!AppState.zonasCalculadas) return alert("> CALCULA ZONAS PRIMERO_"); const q=document.getElementById("cuestionarioEntreno"); q.style.display=q.style.display==="block"?"none":"block"; },
        async guardarPlanActual() { if(!AppState.currentUser||!AppState.planGeneradoActual) return; await Storage.setUltimoPlan(AppState.currentUser, AppState.planGeneradoActual); },
        async mostrarUltimoPlanGuardado() { /* ... */ },
        async borrarPlanGuardado() { /* ... */ },
        getRitmoPorZona(z) { if(!AppState.lastRitmoBase) return "Calcula zonas primero"; const f={'Z1':1.35,'Z2':1.25,'Z3':1.15,'Z4':1.05,'Z5':0.95,'Z6':0.85}; if(z.includes('-')){ const [a,b]=z.split('-'); return `${Utils.formatR(AppState.lastRitmoBase*(f[a]||1.15))} ‚Äì ${Utils.formatR(AppState.lastRitmoBase*(f[b]||1.05))} min/km`; } return Utils.formatR(AppState.lastRitmoBase*(f[z]||1.15))+" min/km"; },
        generarCalendarioEntreno() {
          if(!AppState.zonasCalculadas) return alert("> PRIMERO CALCULA TUS ZONAS_");
          const btn = document.querySelector('[onclick="window.generarCalendarioEntreno()"]');
          if(btn) Utils.showLoading(btn);
          setTimeout(()=>{
            try{
              const modalidad = document.getElementById("modalidad").value;
              const distancia = document.getElementById("distObjetivo").value;
              const meses = parseInt(document.getElementById("duracionPlan").value);
              const nivel = document.getElementById("nivel").value;
              const exp = document.getElementById("experienciaDistancia").value;
              const obj = document.getElementById("objetivoPrincipal").value;
              const diaLargo = parseInt(document.getElementById("diaLargo").value);
              const fechaInicio = document.getElementById("fechaInicio").value;
              if(!fechaInicio) return alert("> SELECCIONA UNA FECHA DE INICIO_");
              
              const diasEntreno = [];
              for(let i=1;i<=7;i++){ const cb=document.getElementById(`dia${i}`); if(cb&&cb.checked) diasEntreno.push(i); }
              if(diasEntreno.length===0) return alert("> SELECCIONA AL MENOS UN D√çA DE ENTRENO_");
              if(!diasEntreno.includes(diaLargo)){
                if(confirm("> El d√≠a de tirada larga no est√° seleccionado. ¬øA√±adirlo autom√°ticamente?")){
                  diasEntreno.push(diaLargo); document.getElementById(`dia${diaLargo}`).checked = true;
                } else return;
              }
              diasEntreno.sort((a,b)=>a-b);
              const fecha = new Date(fechaInicio+"T00:00:00");
              const macrociclo = meses*4;
              const mapa = { "2k":"2 km","5k":"5 km","10k":"10 km","medio":"MEDIA","maraton":"MARAT√ìN" };
              const diaNombre = ["","LUN","MAR","MI√â","JUE","VIE","S√ÅB","DOM"][diaLargo];
              document.getElementById("resumenObjetivo").innerText = `${mapa[distancia]} ¬∑ ${diasEntreno.length} D√çAS/SEM ¬∑ ${nivel.toUpperCase()} ¬∑ ${exp==='si'?'CON EXPERIENCIA':'PRIMERA VEZ'} ¬∑ ${obj==='acabar'?'OBJ: TERMINAR':obj==='mejorar'?'OBJ: MEJORAR':'OBJ: COMPETIR'} ¬∑ LARGO: ${diaNombre} ¬∑ ${modalidad==='runner'?'ASFALTO':'MONTA√ëA'} ¬∑ ${meses} MES(ES) ¬∑ INICIO: ${fecha.toLocaleDateString()}`;

              const grid = document.getElementById("calendarioGrid");
              grid.innerHTML = "";
              const totalDias = macrociclo * 7;
              const tipoPorDia = {};
              tipoPorDia[diaLargo] = 'largo';
              const otrosDias = diasEntreno.filter(d=>d!==diaLargo);
              const posiblesTipos = ['series','tempo','rodaje'];
              otrosDias.forEach((dia,index)=> tipoPorDia[dia] = posiblesTipos[index%posiblesTipos.length]);

              const usados = { rodaje:0, series:0, tempo:0, largo:0 };
              const fragment = document.createDocumentFragment();

              for(let dia=1; dia<=totalDias; dia++){
                const semana = Math.floor((dia-1)/7);
                const diaSem = (dia-1)%7+1;
                let color = "sesion-descanso", breve = "D", detalle = null;

                if(diasEntreno.includes(diaSem)){
                  let tipo = tipoPorDia[diaSem];
                  const esDescarga = (semana+1)%4===0;
                  let factorPersonal = 1.0;
                  if(AppState.lastRitmoBase){
                    const ritmoRef = 5.0;
                    factorPersonal = Math.min(1.2, Math.max(0.8, ritmoRef/AppState.lastRitmoBase));
                  }
                  if(esDescarga) factorPersonal *= 0.8;

                  let opts = [];
                  if(tipo==='largo') opts = this.ENTRENAMIENTOS_DB[modalidad]?.[distancia]?.[nivel]?.largo || [];
                  else if(tipo==='series') opts = this.ENTRENAMIENTOS_DB[modalidad]?.[distancia]?.[nivel]?.series || [];
                  else if(tipo==='tempo') opts = this.ENTRENAMIENTOS_DB[modalidad]?.[distancia]?.[nivel]?.tempo || [];
                  else opts = this.ENTRENAMIENTOS_DB[modalidad]?.[distancia]?.[nivel]?.rodaje || [];

                  if(opts.length){
                    // Selecci√≥n m√°s inteligente: evitar repetir la misma sesi√≥n seguida
                    let idx;
                    if(tipo==='largo') idx = (semana*2 + usados.largo) % opts.length;
                    else if(tipo==='series') idx = (semana*3 + usados.series) % opts.length;
                    else if(tipo==='tempo') idx = (semana*4 + usados.tempo) % opts.length;
                    else idx = (semana*5 + usados.rodaje) % opts.length;
                    
                    detalle = { ...opts[idx], tipo };
                    detalle.duracion = Math.round(detalle.duracion * factorPersonal);
                    if(tipo==='largo'){ color="sesion-largo"; breve="L"; usados.largo++; }
                    else if(tipo==='series'){ color="sesion-series"; breve="S"; usados.series++; }
                    else if(tipo==='tempo'){ color="sesion-tempo"; breve="T"; usados.tempo++; }
                    else{ color="sesion-rodaje"; breve="R"; usados.rodaje++; }
                  }
                }

                const div = document.createElement("div");
                div.className = `calendario-dia ${color}`;
                if(detalle) div.dataset.detalle = JSON.stringify(detalle);
                div.innerHTML = `<div style="font-size:10px;">S${semana+1}</div><strong>${breve}</strong>${detalle?`<div style="font-size:8px;">${detalle.duracion}${detalle.unidad}</div>`:''}`;
                div.dataset.letra = breve;
                div.dataset.semana = semana+1;
                div.dataset.colorClass = color;

                div.onclick = function() {
                  const modal = document.getElementById("detalleSesion"), overlay = document.getElementById("modalOverlay"), wrapper = document.getElementById("modalColorWrapper");
                  wrapper.className = "modal-content"; wrapper.classList.add(this.dataset.colorClass);
                  const det = this.dataset.detalle ? JSON.parse(this.dataset.detalle) : null;
                  AppState.currentSesionDetalle = det;
                  let tit = "", cont = "";
                  if(this.dataset.letra === "D"){
                    tit = "D√çA DE DESCANSO";
                    cont = "<strong>> OBJETIVO_</strong> Recuperaci√≥n completa<br><br><strong>> RECOMENDADO_</strong><br>‚Ä¢ No correr<br>‚Ä¢ Estiramientos suaves<br>‚Ä¢ Buena nutrici√≥n";
                  } else if(det){
                    tit = det.nombre || `${this.dataset.letra} ¬∑ Semana ${this.dataset.semana}`;
                    const ritmo = PlanGenerator.getRitmoPorZona(det.zona);
                    let extras = '';
                    if(det.tipo==='rodaje') extras = '<br><br><strong>üéØ OBJETIVO:</strong> Mejorar la eficiencia aer√≥bica. Debes sentir que puedes mantener una conversaci√≥n sin esfuerzo.<br><br><strong>üí° CLAVES:</strong> Mant√©n un ritmo c√≥modo y constante. No te exijas.<br><br><strong>üßò RECUPERACI√ìN:</strong> Estiramientos suaves e hidrataci√≥n.';
                    else if(det.tipo==='series') extras = '<br><br><strong>üéØ OBJETIVO:</strong> Mejorar velocidad y tolerancia al lactato. Cada repetici√≥n debe ser r√°pida pero controlada.<br><br><strong>üí° CLAVES:</strong> La recuperaci√≥n entre repeticiones es clave.<br><br><strong>üßò RECUPERACI√ìN:</strong> Al terminar, trota suave y estira.';
                    else if(det.tipo==='tempo') extras = '<br><br><strong>üéØ OBJETIVO:</strong> Aumentar la capacidad de mantener un ritmo r√°pido. Sensaci√≥n "c√≥modamente duro".<br><br><strong>üí° CLAVES:</strong> Conc√©ntrate en la respiraci√≥n y la zancada.<br><br><strong>üßò RECUPERACI√ìN:</strong> Enfriamiento prolongado y buena hidrataci√≥n.';
                    else if(det.tipo==='largo') extras = '<br><br><strong>üéØ OBJETIVO:</strong> Desarrollar resistencia y confianza. Ritmo suave, prioriza el tiempo de pie.<br><br><strong>üí° CLAVES:</strong> Lleva nutrici√≥n e hidrataci√≥n.<br><br><strong>üßò RECUPERACI√ìN:</strong> Descanso activo al d√≠a siguiente. Duerme bien.';
                    cont = `<strong>üèÉ ${det.nombre}</strong><br><br><strong>‚è±Ô∏è DURACI√ìN:</strong> ${det.duracion} ${det.unidad}<br><strong>üìä ZONA:</strong> ${det.zona}<br><strong>‚ö° RITMO:</strong> ${ritmo}<br><br><strong>üìã ESTRUCTURA:</strong><br>${det.estructura}<br><br><strong>üí¨ DESCRIPCI√ìN:</strong><br>${det.desc}<br><br><strong>üòå SENSACI√ìN:</strong> ${det.sensacion}${extras}`;
                  } else cont = "> SELECCIONA UN D√çA PARA VER DETALLES_";
                  document.getElementById("tituloSesion").innerText = tit;
                  document.getElementById("descripcionSesion").innerHTML = cont;
                  modal.style.display = "block"; overlay.classList.add("visible");
                  setTimeout(()=>modal.classList.add("visible"),10);
                };
                fragment.appendChild(div);
              }
              grid.appendChild(fragment);
              AppState.planGeneradoActual = { modalidad, distancia, macrociclo, diasPorSemana:diasEntreno.length, nivel, experiencia:exp, objetivo:obj, diaLargo, fechaInicio, diasEntreno };
              document.getElementById("calendarioEntreno").style.display = "block";
              setTimeout(()=>document.getElementById("calendarioEntreno").scrollIntoView({ behavior:'smooth', block:'center' }),100);
              this.guardarPlanActual();
              if(btn) Utils.hideLoading(btn);
            } catch(e){ console.error(e); alert("> ERROR GENERANDO PLAN_"); if(btn) Utils.hideLoading(btn); }
          },300);
        }
      };

      // ==================== M√ìDULO PWA ====================
      const PWA = {
        init() {
          window.addEventListener('beforeinstallprompt', e => {
            e.preventDefault();
            AppState.deferredPrompt = e;
            if(localStorage.getItem('pwa_installed')!=='true') document.getElementById('pwa-banner').style.display='flex';
          });
          window.addEventListener('appinstalled', ()=>{
            document.getElementById('pwa-banner').style.display='none';
            AppState.deferredPrompt=null;
            localStorage.setItem('pwa_installed','true');
          });
        },
        instalarPWA() {
          if(!AppState.deferredPrompt){ alert('Men√∫ del navegador ‚Üí "A√±adir a pantalla de inicio"'); return; }
          AppState.deferredPrompt.prompt();
          AppState.deferredPrompt.userChoice.then(c=>{ if(c.outcome==='accepted') localStorage.setItem('pwa_installed','true'); AppState.deferredPrompt=null; document.getElementById('pwa-banner').style.display='none'; });
        },
        cerrarBannerPWA() { document.getElementById('pwa-banner').style.display='none'; } // No guardamos
      };

      // ==================== INICIALIZACI√ìN ====================
      window.onload = async () => {
        if(!await Auth.checkSavedSession()) document.getElementById("loginPage").style.display="flex";
        document.getElementById("name").addEventListener("blur", ()=>UI.marcarCampoTocado('name'));
        document.getElementById("age").addEventListener("blur", ()=>UI.marcarCampoTocado('age'));
        document.getElementById("time").addEventListener("blur", ()=>UI.marcarCampoTocado('time'));
        document.getElementById("name").addEventListener("input", ()=>{ if(AppState.camposTocados.name) UI.validarCampo('name'); UI.validarTodo(); });
        document.getElementById("age").addEventListener("input", ()=>{ if(AppState.camposTocados.age) UI.validarCampo('age'); UI.validarTodo(); });
        document.getElementById("time").addEventListener("input", ()=>{ if(AppState.camposTocados.time) UI.validarCampo('time'); UI.validarTodo(); });
        UI.validarTodo();
        UI.initDiasCheckboxes();
        if(localStorage.getItem('pwa_installed')==='true') document.getElementById('pwa-banner').style.display='none';
        PWA.init();
        setTimeout(()=>{ if(AppState.deferredPrompt && localStorage.getItem('pwa_installed')!=='true') document.getElementById('pwa-banner').style.display='flex'; },3000);
      };

      // Exponer funciones globales
      window.switchAuthTab = Auth.switchAuthTab.bind(Auth);
      window.registerUser = Auth.registerUser.bind(Auth);
      window.loginUser = Auth.loginUser.bind(Auth);
      window.logoutUser = Auth.logoutUser.bind(Auth);
      window.logoutAdmin = Auth.logoutAdmin.bind(Auth);
      window.startCalc = Training.startCalc.bind(Training);
      window.copyResults = Training.copyResults.bind(Training);
      window.switchTab = UI.switchTab.bind(UI);
      window.changeDailyTip = UI.changeDailyTip.bind(UI);
      window.changeConsejo = UI.changeConsejo.bind(UI);
      window.toggleCuestionario = PlanGenerator.toggleCuestionario.bind(PlanGenerator);
      window.mostrarUltimoPlanGuardado = PlanGenerator.mostrarUltimoPlanGuardado.bind(PlanGenerator);
      window.borrarPlanGuardado = PlanGenerator.borrarPlanGuardado.bind(PlanGenerator);
      window.generarCalendarioEntreno = PlanGenerator.generarCalendarioEntreno.bind(PlanGenerator);
      window.instalarPWA = PWA.instalarPWA.bind(PWA);
      window.cerrarBannerPWA = PWA.cerrarBannerPWA.bind(PWA);
      window.showPremiumBenefits = Auth.showPremiumBenefits;
      // A√±adidas previamente
    })();
  </script>
</body>
</html>