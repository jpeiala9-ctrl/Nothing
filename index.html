<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RI5 ¬∑ NOTHING EDITION</title>
  
  <!-- MANIFEST (estilo Nothing) -->
  <link rel="manifest" href="data:application/manifest+json,%7B%22name%22%3A%22RI5%20%C2%B7%20NOTHING%22%2C%22short_name%22%3A%22RI5%22%2C%22description%22%3A%22Entrenamiento%20runner%20con%20zonas%2C%20planes%20y%20soporte%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%23000000%22%2C%22theme_color%22%3A%22%23ffffff%22%2C%22orientation%22%3A%22portrait%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20100%20100%22%3E%3Crect%20width%3D%22100%25%22%20height%3D%22100%25%22%20fill%3D%22%23000000%22%2F%3E%3Ctext%20x%3D%2250%22%20y%3D%2268%22%20font-size%3D%2260%22%20text-anchor%3D%22middle%22%20fill%3D%22%23ffffff%22%20font-family%3D%22Arial%22%3ERI5%3C%2Ftext%3E%3C%2Fsvg%3E%22%2C%22sizes%22%3A%22192x192%22%2C%22type%22%3A%22image%2Fsvg%2Bxml%22%2C%22purpose%22%3A%22any%20maskable%22%7D%2C%7B%22src%22%3A%22data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20100%20100%22%3E%3Crect%20width%3D%22100%25%22%20height%3D%22100%25%22%20fill%3D%22%23000000%22%2F%3E%3Ctext%20x%3D%2250%22%20y%3D%2268%22%20font-size%3D%2260%22%20text-anchor%3D%22middle%22%20fill%3D%22%23ffffff%22%20font-family%3D%22Arial%22%3ERI5%3C%2Ftext%3E%3C%2Fsvg%3E%22%2C%22sizes%22%3A%22512x512%22%2C%22type%22%3A%22image%2Fsvg%2Bxml%22%2C%22purpose%22%3A%22any%20maskable%22%7D%5D%7D">
  
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="RI5">
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20100%20100%22%3E%3Crect%20width%3D%22100%25%22%20height%3D%22100%25%22%20fill%3D%22%23000000%22%2F%3E%3Ctext%20x%3D%2250%22%20y%3D%2268%22%20font-size%3D%2260%22%20text-anchor%3D%22middle%22%20fill%3D%22%23ffffff%22%20font-family%3D%22Arial%22%3ERI5%3C%2Ftext%3E%3C%2Fsvg%3E">

  <style>
    /* ===== RESET Y VARIABLES NOTHING ===== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #000000;
      --bg-secondary: #111111;
      --bg-card: #1a1a1a;
      --text-primary: #ffffff;
      --text-secondary: #cccccc;
      --accent-red: #ff4530;
      --accent-green: #32d74b;
      --accent-blue: #0a84ff;
      --accent-yellow: #ffd60a;
      --accent-purple: #bf5af2;
      --border-color: #333333;
      --glow-color: rgba(255, 255, 255, 0.1);
      --font-mono: 'Courier New', monospace;
      --font-dot: 'Courier New', 'Dot Matrix', monospace;
      --dot-color: rgba(255, 255, 255, 0.05);
      --gold: #ffd700;
      --new-user-bg: rgba(10, 132, 255, 0.2);
      --new-user-border: #0a84ff;
      --stat-bg: #1e1e1e;
      --stat-number: #ffffff;
    }

    @media (prefers-color-scheme: light) {
      :root {
        --bg-primary: #f5f5f5;
        --bg-secondary: #e5e5e5;
        --bg-card: #ffffff;
        --text-primary: #111111;
        --text-secondary: #333333;
        --border-color: #cccccc;
        --glow-color: rgba(0, 0, 0, 0.1);
        --dot-color: rgba(0, 0, 0, 0.05);
        --gold: #b8860b;
        --new-user-bg: rgba(10, 132, 255, 0.1);
        --new-user-border: #0a84ff;
        --stat-bg: #e0e0e0;
        --stat-number: #111111;
      }
      input, button, select, textarea { color: #111111; }
      .curiosity span, .curiosity small { color: #111111; }
    }

    body {
      background: var(--bg-primary);
      color: var(--text-primary);
      font-family: var(--font-mono);
      line-height: 1.6;
      letter-spacing: 0.5px;
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
      transition: background 0.3s ease, color 0.3s ease;
    }

    body::before {
      content: "";
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: repeating-radial-gradient(circle at 20px 20px, var(--dot-color) 2px, transparent 2px, transparent 10px);
      background-size: 30px 30px;
      pointer-events: none;
      z-index: 9999;
      opacity: 0.5;
    }

    h1, h2, h3, h4 {
      font-family: var(--font-dot);
      font-weight: 300;
      letter-spacing: 2px;
      text-transform: uppercase;
      position: relative;
      display: inline-block;
      width: 100%;
      text-align: center;
    }

    /* Tarea 2: T√≠tulos centrados con l√≠nea RGB */
    h1, h2, h3, h4 {
      text-align: center;
      margin: 20px 0;
      padding: 0 10px;
    }

    @keyframes rgbLine {
      0% { background: linear-gradient(90deg, #ff0000, #00ff00, #0000ff); }
      33% { background: linear-gradient(90deg, #00ff00, #0000ff, #ff0000); }
      66% { background: linear-gradient(90deg, #0000ff, #ff0000, #00ff00); }
      100% { background: linear-gradient(90deg, #ff0000, #00ff00, #0000ff); }
    }

    h1::after, h2::after {
      content: "";
      position: absolute;
      bottom: -5px; left: 0;
      width: 100%; height: 2px;
      background: linear-gradient(90deg, #ff0000, #00ff00, #0000ff);
      background-size: 200% 100%;
      animation: rgbLine 3s linear infinite;
    }

    /* Tarea 4: Centrar predicciones */
    .pred-bar {
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    /* Tarea 5: Pesta√±as sin fondo gris */
    .tab-button {
      background: transparent !important;
    }
    .tab-button.active {
      background: transparent !important;
      animation: rgbText 5s linear infinite;
    }
    @keyframes rgbText {
      0% { color: #ff0000; }
      17% { color: #ff8800; }
      33% { color: #ffff00; }
      50% { color: #00ff00; }
      67% { color: #0000ff; }
      83% { color: #ff00ff; }
      100% { color: #ff0000; }
    }

    /* Tarea 8: T√≠tulo premium con pulso */
    @keyframes premiumPulse {
      0% { color: #ffd700; text-shadow: 0 0 5px #ffd700; }
      50% { color: #f0e68c; text-shadow: 0 0 15px #f0e68c; }
      100% { color: #ffd700; text-shadow: 0 0 5px #ffd700; }
    }
    .premium {
      animation: premiumPulse 2s ease-in-out infinite !important;
    }

    /* Tarea 9: Papelera a la derecha */
    .historial-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .historial-header .fecha {
      margin: 0;
    }
    .historial-header .delete-icon {
      margin-left: auto;
    }

    /* Tarea 11: Cerrar sesi√≥n en p√≠ldora RGB */
    .logout-pill {
      display: inline-block;
      padding: 8px 20px;
      border: 2px solid;
      border-radius: 40px;
      text-decoration: none;
      font-weight: bold;
      animation: rgbBorder 3s linear infinite, rgbText 5s linear infinite;
    }
    @keyframes rgbBorder {
      0% { border-color: #ff0000; }
      17% { border-color: #ff8800; }
      33% { border-color: #ffff00; }
      50% { border-color: #00ff00; }
      67% { border-color: #0000ff; }
      83% { border-color: #ff00ff; }
      100% { border-color: #ff0000; }
    }

    /* ===== RESTO DEL CSS ORIGINAL (sin cambios) ===== */
    .wrapper {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 20px;
      overflow-y: auto;
    }

    #loginPage.wrapper {
      align-items: flex-start;
      padding-top: 20px;
      padding-bottom: 20px;
    }

    .card {
      width: 100%;
      max-width: 540px;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 28px;
      padding: 30px;
      box-shadow: 0 20px 30px rgba(0, 0, 0, 0.6), inset 0 0 10px var(--glow-color);
      position: relative;
      overflow: hidden;
      margin: 20px 0;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    .card:hover {
      border-color: rgba(255,255,255,0.2);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.8);
    }
    .card::before {
      content: "";
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: repeating-radial-gradient(circle at 20px 20px, var(--dot-color) 2px, transparent 2px, transparent 10px);
      background-size: 30px 30px;
      opacity: 0.3;
      pointer-events: none;
    }

    .card.admin-card {
      max-width: 800px;
      max-height: none;
      display: flex;
      flex-direction: column;
      overflow: visible;
    }
    .card.admin-card .tabs-container {
      flex: none;
      overflow-y: visible;
      padding-right: 5px;
    }

    .app-header {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: nowrap;
      gap: 10px;
    }
    .app-header h1 {
      flex: 0 1 auto;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    .auth-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 30px;
      background: var(--bg-secondary);
      padding: 4px;
      border-radius: 40px;
      border: 1px solid var(--border-color);
    }
    .auth-tab {
      flex: 1;
      padding: 12px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-family: var(--font-dot);
      font-size: 14px;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all 0.3s ease;
      border-radius: 30px;
    }
    .auth-tab.active {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
      box-shadow: inset 0 0 15px var(--glow-color);
    }
    .auth-form { display: none; animation: glyphIn 0.5s ease; }
    .auth-form.active { display: block; }

    .tabs-container { margin: 30px 0; }
    .tabs-header {
      display: flex;
      justify-content: center;
      gap: 4px;
      margin-bottom: 20px;
      background: var(--bg-secondary);
      padding: 4px;
      border-radius: 40px;
      border: 1px solid var(--border-color);
      align-items: center;
    }
    .tab-button {
      flex: 1;
      min-width: 70px;
      max-width: 100px;
      padding: 10px 4px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-family: var(--font-dot);
      font-size: 13px;
      letter-spacing: 0.5px;
      cursor: pointer;
      border-radius: 30px;
      white-space: nowrap;
      transition: color 0.3s ease, background 0.3s ease;
      text-align: center;
    }
    .tab-content { display: none; animation: glyphIn 0.5s ease; }
    .tab-content.active { display: block; }
    @keyframes glyphIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .tab-button.soporte-unread {
      color: var(--accent-red) !important;
      animation: latido-texto 1.5s infinite;
    }
    @keyframes latido-texto {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    input, button, select, textarea {
      width: 100%;
      padding: 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 40px;
      color: var(--text-primary);
      font-family: var(--font-mono);
      font-size: 16px;
      margin-bottom: 16px;
      transition: all 0.3s ease;
      outline: none;
    }
    textarea {
      border-radius: 24px;
      resize: vertical;
      min-height: 100px;
    }
    input:focus, select:focus, textarea:focus {
      border-color: var(--accent-blue);
      box-shadow: 0 0 15px rgba(10, 132, 255, 0.4);
    }
    input::placeholder, textarea::placeholder {
      color: var(--text-secondary);
      font-family: var(--font-mono);
      letter-spacing: 1px;
    }
    input.error { border-color: var(--accent-red); }

    .field-hint {
      color: var(--text-secondary);
      font-size: 11px;
      margin-top: -10px;
      margin-bottom: 10px;
      text-align: center;
      opacity: 0.8;
    }

    .fecha-inicio-container {
      text-align: center;
      margin: 20px 0 10px;
    }
    .fecha-inicio-container label {
      display: block;
      margin-bottom: 8px;
      color: var(--accent-yellow);
      font-family: var(--font-dot);
      font-size: 14px;
      letter-spacing: 1px;
    }
    #fechaInicio {
      max-width: 300px;
      margin: 0 auto;
      text-align: center;
    }

    .button-main {
      background: transparent;
      border: 1px solid var(--accent-blue);
      color: var(--accent-blue);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 2px;
      position: relative;
      overflow: hidden;
      cursor: pointer;
      width: auto;
      min-width: 180px;
      margin: 20px auto !important;
      display: block;
      text-align: center;
    }
    .button-main::before {
      content: "";
      position: absolute;
      top: 0; left: -100%;
      width: 100%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(10, 132, 255, 0.3), transparent);
      transition: left 0.5s ease;
    }
    .button-main:hover::before { left: 100%; }
    .button-main:hover { box-shadow: 0 0 25px rgba(10, 132, 255, 0.4); }
    .button-main:disabled { opacity: 0.3; cursor: not-allowed; pointer-events: none; }

    .calculos-restantes {
      color: var(--accent-yellow);
      font-size: 12px;
      margin-bottom: 10px;
      text-align: center;
    }

    .curiosity {
      margin: 30px 0;
      padding: 30px;
      background: var(--bg-secondary);
      border: 1px solid var(--accent-purple);
      border-radius: 24px;
      text-align: center;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }
    .curiosity::before {
      content: "";
      position: absolute;
      top: -50%; left: -50%;
      width: 200%; height: 200%;
      background: radial-gradient(circle, rgba(191, 90, 242, 0.25) 0%, transparent 70%);
      animation: pulse 4s linear infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); opacity: 0.5; }
      50% { transform: scale(1.2); opacity: 0.2; }
      100% { transform: scale(1); opacity: 0.5; }
    }
    .curiosity span { font-size: 18px; line-height: 1.5; position: relative; z-index: 1; }
    .curiosity small { display: block; color: var(--text-secondary); margin-top: 12px; font-size: 12px; }

    .zone-card {
      margin: 16px 0;
      padding: 20px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 24px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      text-align: center;
    }
    .zone-card::after {
      content: "";
      position: absolute;
      top: 0; left: 0;
      width: 4px; height: 100%;
      transition: all 0.3s ease;
    }
    .zone-card:hover { transform: translateX(5px); border-color: rgba(255,255,255,0.2); }
    .z1::after { background: var(--accent-blue); }
    .z2::after { background: var(--accent-green); }
    .z3::after { background: var(--accent-yellow); }
    .z4::after { background: var(--accent-red); }
    .z5::after { background: var(--accent-purple); }
    .z6::after { background: var(--accent-blue); }

    .zone-card .long {
      max-height: 0;
      overflow: hidden;
      transition: all 0.5s ease;
      margin-top: 0;
      color: var(--text-secondary);
      font-size: 14px;
    }
    .zone-card.active .long {
      max-height: 300px;
      margin-top: 16px;
    }

    #calendarioEntreno {
      margin: 30px 0;
      padding: 20px;
      background: var(--bg-secondary);
      border-radius: 24px;
      width: 100%;
    }
    .calendar-grid-container {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .calendar-header {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 4px;
      margin-bottom: 8px;
      width: 100%;
    }
    .calendar-header div {
      text-align: center;
      color: var(--text-secondary);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
      padding: 5px 0;
      white-space: nowrap;
    }
    #calendarioGrid {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 4px;
      width: 100%;
    }
    .calendario-dia {
      aspect-ratio: 1 / 1;
      padding: 4px 2px;
      background: var(--bg-primary);
      border: 2px solid var(--border-color);
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 11px;
      width: 100%;
      min-width: 0;
      overflow: hidden;
      position: relative;
      z-index: 1;
      white-space: normal;
      word-break: break-word;
      line-height: 1.2;
      text-align: center;
    }
    .calendario-dia:hover {
      border-color: var(--accent-blue);
      transform: scale(1.05);
      z-index: 5;
      box-shadow: 0 0 12px rgba(10, 132, 255, 0.6);
    }
    .sesion-descanso { border-color: var(--border-color); background: var(--bg-secondary); }
    .sesion-rodaje { border-color: var(--accent-blue); background: #0a1a2a; }
    .sesion-series { border-color: var(--accent-green); background: #0a2a0a; }
    .sesion-tempo { border-color: var(--accent-yellow); background: #2a2a0a; }
    .sesion-largo { border-color: var(--accent-red); background: #2a0a0a; }

    .calendario-dia.sesion-rodaje,
    .calendario-dia.sesion-series,
    .calendario-dia.sesion-tempo,
    .calendario-dia.sesion-largo {
      color: #ffffff !important;
    }

    .action-button {
      padding: 16px;
      margin: 8px 0;
      background: transparent;
      border: 1px solid var(--border-color);
      border-radius: 40px;
      color: var(--text-primary);
      font-weight: 600;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
      text-align: center;
    }
    .action-button:hover {
      border-color: var(--accent-blue);
      box-shadow: 0 0 20px rgba(10, 132, 255, 0.3);
    }
    .btn-copy { border-color: var(--accent-blue); }
    .btn-save { border-color: var(--accent-green); }
    .btn-delete { border-color: var(--accent-red); }
    .btn-plan { border-color: var(--accent-yellow); }
    .btn-view { border-color: var(--accent-purple); }

    .historial-controls {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }
    .historial-controls label {
      color: var(--text-secondary);
      font-size: 12px;
    }
    .historial-controls select {
      width: auto;
      padding: 8px 12px;
      margin: 0;
      font-size: 12px;
      background: var(--bg-primary);
    }
    .historial-list { display: flex; flex-direction: column; gap: 12px; }
    .historial-item {
      position: relative;
      padding: 12px 12px 12px 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      min-height: 70px;
    }
    .historial-item:hover {
      background: var(--bg-card);
    }
    .historial-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }
    .historial-header .fecha {
      color: var(--accent-blue);
      font-family: var(--font-dot);
      font-size: 14px;
    }
    .historial-header .delete-icon {
      background: transparent;
      border: none;
      color: var(--accent-red);
      font-size: 18px;
      cursor: pointer;
      opacity: 0.7;
      transition: opacity 0.2s;
      padding: 0;
      margin: 0;
      line-height: 1;
    }
    .historial-header .delete-icon:hover {
      opacity: 1;
    }
    .historial-item .resumen {
      color: var(--text-secondary);
      font-size: 12px;
      text-align: center;
      word-break: break-word;
      margin-bottom: 0;
    }
    .historial-item .detalle {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease, margin 0.3s ease, padding 0.3s ease;
      margin-top: 0;
      color: var(--text-secondary);
      font-size: 13px;
      border-top: 1px solid transparent;
      text-align: center;
      width: 100%;
    }
    .historial-item.abierto .detalle {
      max-height: 400px;
      margin-top: 12px;
      border-top-color: var(--border-color);
      padding-top: 12px;
    }
    .historial-item .hora-detalle {
      color: var(--accent-green);
      font-size: 12px;
      margin-bottom: 6px;
    }
    .historial-item .predicciones {
      color: var(--accent-blue);
      font-size: 11px;
      margin: 6px 0;
      background: rgba(10, 132, 255, 0.1);
      padding: 4px 8px;
      border-radius: 20px;
      display: inline-block;
    }
    .zonas-pastillas {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin: 8px 0;
      justify-content: center;
    }
    .zona-pastilla {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 20px;
      font-size: 10px;
      font-weight: bold;
      background: var(--bg-primary);
      border: 1px solid;
    }
    .zona-pastilla.z1 { border-color: var(--accent-blue); color: var(--accent-blue); }
    .zona-pastilla.z2 { border-color: var(--accent-green); color: var(--accent-green); }
    .zona-pastilla.z3 { border-color: var(--accent-yellow); color: var(--accent-yellow); }
    .zona-pastilla.z4 { border-color: var(--accent-red); color: var(--accent-red); }
    .zona-pastilla.z5 { border-color: var(--accent-purple); color: var(--accent-purple); }
    .zona-pastilla.z6 { border-color: var(--accent-blue); color: var(--accent-blue); }
    .zona-pastilla span {
      background: currentColor;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
    }

    .mensaje-item {
      margin-bottom: 10px;
      border-left: 4px solid var(--accent-blue);
      background: var(--bg-secondary);
      border-radius: 16px;
      overflow: hidden;
    }
    .mensaje-item .mensaje-header {
      padding: 16px;
      background: var(--bg-primary);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: bold;
      color: var(--accent-blue);
      transition: background 0.2s;
      flex-wrap: wrap;
    }
    .mensaje-item .mensaje-header:hover {
      background: var(--bg-card);
    }
    .mensaje-item .mensaje-header span:first-child {
      font-size: 14px;
      flex: 1;
      min-width: 150px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: normal;
      word-break: break-word;
    }
    .mensaje-item .mensaje-header .flecha {
      font-size: 16px;
      transition: transform 0.3s;
      margin-left: auto;
      flex-shrink: 0;
    }
    .delete-mensaje {
      background: transparent;
      border: 1px solid var(--accent-red);
      border-radius: 40px;
      color: var(--accent-red);
      padding: 4px 8px;
      font-size: 10px;
      cursor: pointer;
      flex-shrink: 0;
    }
    .delete-mensaje:hover {
      background: var(--accent-red);
      color: var(--bg-primary);
    }
    .mensaje-item .mensaje-contenido {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease;
      padding: 0 16px;
      color: var(--text-secondary);
      font-size: 13px;
      line-height: 1.5;
      background: var(--bg-secondary);
    }
    .mensaje-item.abierto .mensaje-contenido {
      max-height: 200px;
      padding: 16px;
    }
    .mensaje-item.abierto .flecha {
      transform: rotate(180deg);
    }
    .mensaje-item.nuevo .mensaje-header {
      border-left: 4px solid var(--accent-red);
    }
    .mensaje-item.no-leido-usuario {
      border-left-color: var(--accent-green) !important;
    }

    .soporte-section {
      margin-top: 30px;
    }
    .soporte-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 20px;
      background: var(--bg-secondary);
      padding: 4px;
      border-radius: 40px;
      border: 1px solid var(--border-color);
    }
    .soporte-tab {
      flex: 1;
      padding: 10px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-family: var(--font-dot);
      font-size: 13px;
      cursor: pointer;
      border-radius: 30px;
      transition: all 0.3s;
    }
    .soporte-tab.active {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
    }
    .soporte-panel {
      display: none;
    }
    .soporte-panel.active {
      display: block;
    }

    .admin-panel { margin: 30px 0; padding: 20px; background: var(--bg-secondary); border-radius: 24px; }

    .admin-stats {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    .stat-badge {
      background: var(--stat-bg);
      padding: 6px 14px;
      border-radius: 40px;
      border: 1px solid var(--border-color);
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .stat-badge:hover {
      background: var(--bg-card);
    }
    .stat-badge .number {
      color: var(--accent-blue);
      font-weight: bold;
    }

    .premium-tag {
      color: var(--gold);
      font-weight: bold;
      margin-left: 5px;
    }

    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(8px);
      z-index: 20000;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: var(--bg-card);
      border: 2px solid var(--border-color);
      border-radius: 32px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 40px rgba(0,0,0,0.9);
      position: relative;
    }
    .modal-content h2 {
      margin-bottom: 20px;
      color: var(--accent-blue);
    }
    .modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: 24px;
      cursor: pointer;
      width: auto;
      padding: 0;
    }
    .modal-close:hover {
      color: var(--accent-red);
    }
    .modal-search {
      margin-bottom: 20px;
    }
    .modal-search input {
      margin-bottom: 0;
      padding: 12px;
    }
    .modal-user-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .modal-empty {
      text-align: center;
      padding: 30px;
      color: var(--text-secondary);
    }

    .usuario-item {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      margin-bottom: 10px;
      overflow: hidden;
    }
    .usuario-header {
      padding: 15px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--bg-primary);
      color: var(--accent-blue);
      font-weight: bold;
      transition: background 0.2s;
    }
    .usuario-header:hover {
      background: var(--bg-card);
    }
    .usuario-header .flecha {
      font-size: 16px;
      transition: transform 0.3s;
    }
    .usuario-item.abierto .flecha {
      transform: rotate(180deg);
    }
    .usuario-detalle {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease;
      padding: 0 15px;
      background: var(--bg-primary);
    }
    .usuario-item.abierto .usuario-detalle {
      max-height: 300px;
      padding: 15px;
    }
    .usuario-detalle .user-details {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 12px;
      justify-content: center;
    }
    .modal-user-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .modal-user-actions button {
      margin: 0;
      padding: 6px 12px;
      font-size: 11px;
      width: auto;
    }

    .dias-semana-label {
      text-align: center;
      color: var(--accent-yellow);
      font-family: var(--font-dot);
      font-size: 14px;
      margin: 10px 0 5px;
    }
    .dias-semana-container {
      display: flex !important;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      margin: 5px 0 16px;
      background: var(--bg-secondary);
      padding: 12px;
      border-radius: 40px;
      border: 1px solid var(--border-color);
    }
    .dia-checkbox {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 50px;
    }
    .dia-checkbox input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin: 0 0 4px 0;
      accent-color: var(--accent-blue);
    }
    .dia-checkbox label {
      font-size: 11px;
      color: var(--text-secondary);
      cursor: pointer;
    }

    #premiumOverlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(5px);
      z-index: 20000;
    }
    #premiumOverlay.active { display: block; }
    #premiumModal {
      display: none;
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: var(--bg-card);
      border: 3px solid var(--gold);
      border-radius: 32px;
      padding: 30px;
      max-width: 400px;
      width: 90%;
      z-index: 20001;
      box-shadow: 0 20px 40px rgba(0,0,0,0.9);
    }
    #premiumModal.active { display: block; }
    #premiumModal h2 { color: var(--gold); margin-bottom: 20px; }
    #premiumModal p { margin: 10px 0; color: var(--text-secondary); }
    #premiumModal button {
      margin-top: 20px;
      background: var(--gold);
      color: #000;
      border: none;
      padding: 12px 30px;
      border-radius: 40px;
      font-weight: bold;
      cursor: pointer;
    }
    #premiumModal button:hover { box-shadow: 0 0 20px var(--gold); }

    #modalOverlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      z-index: 9999;
    }
    #modalOverlay.visible { display: block; }

    #detalleSesion {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 500px;
      background: transparent;
      z-index: 10000;
    }
    #detalleSesion.visible { display: block; }

    #detalleSesion .modal-content {
      padding: 30px 25px 70px;
      background: var(--bg-card);
      border-radius: 24px;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0,0,0,0.5);
      position: relative;
      border: 2px solid var(--border-color);
    }

    #detalleSesion .modal-content.sesion-descanso { border-color: var(--border-color); }
    #detalleSesion .modal-content.sesion-rodaje { border-color: var(--accent-blue); }
    #detalleSesion .modal-content.sesion-series { border-color: var(--accent-green); }
    #detalleSesion .modal-content.sesion-tempo { border-color: var(--accent-yellow); }
    #detalleSesion .modal-content.sesion-largo { border-color: var(--accent-red); }

    #tituloSesion {
      margin: 0 0 20px;
      color: var(--accent-blue);
      font-size: 22px;
      font-family: var(--font-dot);
    }

    #descripcionSesion {
      color: var(--text-secondary);
      line-height: 1.6;
      font-size: 14px;
      margin-bottom: 20px;
      text-align: left;
    }

    #descripcionSesion strong {
      color: var(--text-primary);
    }

    .close-btn {
      background: var(--accent-red);
      color: white;
      border: none;
      padding: 10px 30px;
      border-radius: 40px;
      font-weight: bold;
      cursor: pointer;
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: auto;
      min-width: 120px;
      font-size: 14px;
      transition: background 0.2s;
    }
    .close-btn:hover {
      background: #ff1a1a;
    }

    #pwa-banner {
      position: fixed; bottom: 20px; left: 20px; right: 20px; max-width: 400px; margin: 0 auto;
      background: var(--bg-card); border: 2px solid var(--accent-blue); border-radius: 40px;
      padding: 16px 24px; display: flex; align-items: center; justify-content: space-between;
      gap: 16px; z-index: 100000; box-shadow: 0 10px 30px rgba(0,0,0,0.7);
      animation: slideUp 0.5s ease;
    }
    @keyframes slideUp { from { transform: translateY(100px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    #pwa-banner span { color: var(--text-primary); font-size: 14px; flex: 1; }
    #pwa-banner button {
      width: auto; margin: 0; padding: 8px 16px; background: var(--accent-blue);
      border: none; color: var(--bg-primary); font-weight: bold; cursor: pointer;
    }
    #pwa-banner button:hover { background: var(--accent-green); }
    #pwa-banner .close-banner { background: transparent; border: 1px solid var(--border-color); color: var(--text-secondary); }

    .error-message {
      color: var(--accent-red); font-size: 12px; margin-top: -10px; margin-bottom: 10px;
      opacity: 0; transition: opacity 0.3s ease; text-align: center;
    }
    .error-message.visible { opacity: 1; }

    .nota-plan {
      color: var(--text-secondary); margin: 20px 0; padding: 20px;
      background: var(--bg-primary);
      border: 1px solid var(--accent-blue);
      border-radius: 16px;
      font-size: 14px;
      text-align: center;
      line-height: 1.6;
    }
    .nota-plan p {
      margin-bottom: 10px;
    }
    .nota-plan strong {
      color: var(--accent-blue);
    }
    #results { margin-top: 30px; }
    .footer {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid var(--border-color);
      text-align: center;
      color: var(--text-secondary);
      font-size: 11px;
      letter-spacing: 1px;
    }
    #adminFooter {
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid var(--border-color);
      text-align: center;
    }
    #loginPage, #mainContent, #adminPage { transition: opacity 0.3s ease; }
    .loading { position: relative; pointer-events: none; opacity: 0.7; }
    .loading::after {
      content: ""; position: absolute; top: 50%; left: 50%; width: 20px; height: 20px;
      margin: -10px 0 0 -10px; border: 2px solid var(--accent-blue); border-top-color: transparent;
      border-radius: 50%; animation: spinner 0.8s linear infinite;
    }
    @keyframes spinner { to { transform: rotate(360deg); } }
    .btn-success { background: var(--accent-green) !important; color: var(--bg-primary) !important; }
    .btn-error { background: var(--accent-red) !important; color: var(--text-primary) !important; }

    @media (max-width: 480px) {
      .card { padding: 20px; }
      .tabs-header { flex-wrap: wrap; height: auto; }
      .tab-button { min-width: 60px; font-size: 11px; padding: 10px 2px; }
      .calendario-dia { font-size: 9px; padding: 2px 1px; }
      .calendario-dia div { font-size: 7px; }
      #pwa-banner { flex-direction: column; text-align: center; }
      .mensaje-item .mensaje-header span:first-child {
        max-width: calc(100% - 60px);
      }
      .dias-semana-container {
        gap: 4px;
      }
      .dia-checkbox {
        min-width: 40px;
      }
    }
  </style>
</head>
<body>
  <!-- BANNER PWA -->
  <div id="pwa-banner" style="display:none;">
    <span>üì≤ INSTALA RI5 EN TU M√ìVIL</span>
    <button onclick="window.instalarPWA()">INSTALAR</button>
    <button class="close-banner" onclick="window.cerrarBannerPWA()">‚úï</button>
  </div>

  <!-- Overlay y modal de detalle de sesi√≥n -->
  <div id="modalOverlay" class="modal-overlay" onclick="window.cerrarModalSesion()"></div>

  <div id="detalleSesion">
    <div class="modal-content" id="modalColorWrapper">
      <h3 id="tituloSesion"></h3>
      <div id="descripcionSesion"></div>
      <button class="close-btn" onclick="window.cerrarModalSesion()">[ CERRAR ]</button>
    </div>
  </div>

  <!-- OVERLAY Y MODAL PREMIUM -->
  <div id="premiumOverlay" onclick="window.cerrarPremiumModal()"></div>
  <div id="premiumModal">
    <h2>‚ú® RI5 PREMIUM</h2>
    <p>‚úî Planes de entrenamiento ilimitados</p>
    <p>‚úî C√°lculos de zonas sin l√≠mite</p>
    <p>‚úî Prioridad en soporte</p>
    <p>‚úî Historial ampliado hasta 25 entradas</p>
    <p>‚úî Y mucho m√°s...</p>
    <p>üîó Para hacerte premium, contacta por Instagram <strong>@navegacionpro</strong></p>
    <button onclick="window.cerrarPremiumModal()">CERRAR</button>
  </div>

  <!-- LOGIN PAGE -->
  <div class="wrapper" id="loginPage">
    <div class="card">
      <h1>RI5</h1>
      <p style="color: var(--text-secondary); margin:20px 0; text-align:center;">> SISTEMA DE ACCESO_</p>
      <div class="auth-tabs">
        <button class="auth-tab active" onclick="window.switchAuthTab('login')">[LOGIN]</button>
        <button class="auth-tab" onclick="window.switchAuthTab('register')">[REGISTRO]</button>
      </div>
      <div id="loginForm" class="auth-form active">
        <input type="text" id="loginUsername" placeholder="> USUARIO_">
        <input type="password" id="loginPassword" placeholder="> CONTRASE√ëA_">
        <div class="error-message" id="loginError"></div>
        <button class="button-main" onclick="window.loginUser()">[ ACCEDER ]</button>
      </div>
      <div id="registerForm" class="auth-form">
        <input type="text" id="regUsername" placeholder="> NUEVO USUARIO_">
        <input type="password" id="regPassword" placeholder="> NUEVA CONTRASE√ëA_">
        <div class="error-message" id="registerError"></div>
        <button class="button-main" onclick="window.registerUser()">[ REGISTRARSE ]</button>
      </div>
      <div id="dailyTip" class="curiosity" onclick="window.changeDailyTip()">
        <span>> CONSEJO DEL D√çA_</span><small>// pulsa para nuevo consejo</small>
      </div>
    </div>
  </div>

  <!-- ADMIN PAGE -->
  <div class="wrapper" id="adminPage" style="display:none;">
    <div class="card admin-card">
      <div class="app-header">
        <h1>RI5¬∑ADMIN</h1>
      </div>
      <p style="color: var(--accent-green); margin:20px 0; text-align:center;" id="adminWelcome"></p>
      <div class="tabs-container">
        <div class="tabs-header">
          <button class="tab-button active" onclick="window.switchAdminTab('usuarios')">USUARIOS</button>
          <button class="tab-button" onclick="window.switchAdminTab('soporte')" id="adminSoporteTab">SOPORTE</button>
        </div>
        <div id="admin-tab-usuarios" class="tab-content active">
          <!-- Tarea 1: Estad√≠sticas clickeables -->
          <div class="admin-stats" id="adminStats"></div>
          <button class="admin-btn admin-export-btn" onclick="window.exportarUsuariosCSV()" style="width:100%; margin:10px 0;">üì• EXPORTAR USUARIOS CSV</button>
          <button class="admin-btn" onclick="window.renovarExpirados()" style="width:100%;">üîÑ RENOVAR EXPIRADOS</button>
        </div>
        <div id="admin-tab-soporte" class="tab-content">
          <h2>SOPORTE</h2>
          <div class="soporte-section">
            <div class="soporte-tabs">
              <button class="soporte-tab active" onclick="window.cambiarAdminSoporteTab('recibidos')">üì• RECIBIDOS</button>
              <button class="soporte-tab" onclick="window.cambiarAdminSoporteTab('enviados')">üì§ ENVIADOS</button>
            </div>
            <div id="admin-soporte-recibidos" class="soporte-panel active">
              <div id="listaMensajesRecibidosAdmin"></div>
            </div>
            <div id="admin-soporte-enviados" class="soporte-panel">
              <div id="listaMensajesEnviadosAdmin"></div>
            </div>
          </div>
        </div>
      </div>
      <!-- Tarea 12: Footer dentro de la tarjeta -->
      <div class="footer" id="adminFooter">
        <a href="#" onclick="window.logoutAdmin(); return false;" class="logout-pill">[ cerrar sesi√≥n admin ]</a>
      </div>
    </div>
  </div>

  <!-- MODAL DE USUARIOS PARA ADMIN -->
  <div class="modal-overlay" id="modalUsuarios">
    <div class="modal-content">
      <button class="modal-close" onclick="document.getElementById('modalUsuarios').classList.remove('active')">‚úï</button>
      <h2 id="modalUsuariosTitulo">üë• USUARIOS</h2>
      <div class="modal-search">
        <input type="text" id="modalBuscarUsuario" placeholder="üîç Buscar por nombre...">
      </div>
      <div class="modal-user-list" id="modalUserList"></div>
    </div>
  </div>

  <!-- MAIN APP -->
  <div class="wrapper" id="mainContent" style="display:none;">
    <div class="card">
      <div class="app-header">
        <h1 id="ri5Title" onclick="window.showPremiumBenefits()">RI5</h1>
      </div>
      <p style="color: var(--text-secondary); margin:20px 0; text-align:center;" id="userWelcome"></p>
      
      <!-- Tarea 10: Bot√≥n eliminar cuenta -->
      <div style="text-align: center; margin: 20px 0;">
        <button class="action-button btn-delete" onclick="window.eliminarMiCuenta()" style="width: auto; padding: 10px 20px;">üóëÔ∏è ELIMINAR MI CUENTA</button>
      </div>

      <div class="tabs-container">
        <div class="tabs-header">
          <button class="tab-button active" onclick="window.switchTab('entreno')">ENTRENO</button>
          <button class="tab-button" onclick="window.switchTab('plan')">PLAN</button>
          <button class="tab-button" onclick="window.switchTab('historial')">HISTORIAL</button>
          <button class="tab-button" onclick="window.switchTab('soporte')" id="soporteTabButton">SOPORTE</button>
        </div>

        <!-- TAB ENTRENO -->
        <div id="tab-entreno" class="tab-content active">
          <h2>> ZONAS DE ENTRENO_</h2>
          <input id="name" placeholder="> NOMBRE_"><div class="error-message" id="nameError"></div>
          <input id="age" type="number" min="14" max="85" placeholder="> EDAD_"><div class="error-message" id="ageError"></div>
          <!-- Tarea 7: Placeholder modificado -->
          <input id="time" placeholder="> TIEMPO 6km (MM:SS) - √∫ltimo tiempo realizado"><div class="error-message" id="timeError"></div>
          <div class="field-hint">Introduce tu mejor tiempo reciente en 6 km</div>
          <div id="calculosRestantes" class="calculos-restantes"></div>
          <button class="button-main" id="calcBtn" disabled onclick="window.startCalc()">[ CALCULAR ]</button>
          <div class="curiosity" id="curiosity" onclick="window.changeConsejo()"><span>> CONSEJO_</span><small>// pulsa para nuevo consejo</small></div>
          <div id="results"></div>
        </div>

        <!-- TAB PLAN -->
        <div id="tab-plan" class="tab-content">
          <h2>> CREADOR DE PLANES_</h2>
          <button class="action-button btn-plan" onclick="window.toggleCuestionario()">+ NUEVO PLAN</button>
          <button class="action-button btn-view" onclick="window.mostrarUltimoPlanGuardado()">üìÇ CARGAR √öLTIMO PLAN</button>
          <button class="action-button btn-delete" onclick="window.borrarPlanGuardado()">üóëÔ∏è ELIMINAR PLAN</button>
          
          <div id="cuestionarioEntreno" style="display:none;">
            <h3>> CONFIGURACI√ìN_</h3>
            <select id="modalidad">
              <option value="runner">RUNNER (asfalto)</option>
              <option value="trail">TRAIL (monta√±a)</option>
            </select>

            <select id="distObjetivo">
              <option value="2k">2 km</option>
              <option value="5k">5 km</option>
              <option value="10k">10 km</option>
              <option value="medio">MEDIA MARAT√ìN</option>
              <option value="maraton" selected>MARAT√ìN</option>
            </select>

            <select id="duracionPlan">
              <option value="1">1 MES</option>
              <option value="3">3 MESES</option>
            </select>

            <div class="dias-semana-label">üìÖ D√çAS QUE ENTRENAS A LA SEMANA</div>
            <div class="dias-semana-container" id="diasSemanaContainer"></div>

            <select id="nivel">
              <option value="principiante">PRINCIPIANTE</option>
              <option value="intermedio" selected>INTERMEDIO</option>
              <option value="avanzado">AVANZADO</option>
            </select>

            <select id="experienciaDistancia">
              <option value="si">CON EXPERIENCIA</option>
              <option value="no" selected>PRIMERA VEZ</option>
            </select>

            <select id="objetivoPrincipal">
              <option value="acabar">TERMINAR</option>
              <option value="mejorar" selected>MEJORAR TIEMPO</option>
              <option value="competir">COMPETIR</option>
            </select>

            <select id="diaLargo">
              <option value="1">LUNES (tirada larga)</option>
              <option value="2">MARTES (tirada larga)</option>
              <option value="3">MI√âRCOLES (tirada larga)</option>
              <option value="4">JUEVES (tirada larga)</option>
              <option value="5">VIERNES (tirada larga)</option>
              <option value="6" selected>S√ÅBADO (tirada larga)</option>
              <option value="7">DOMINGO (tirada larga)</option>
            </select>

            <div class="fecha-inicio-container">
              <label for="fechaInicio">üìÖ FECHA DE INICIO DEL PLAN</label>
              <input type="date" id="fechaInicio" value="2025-03-01" min="2025-01-01" max="2026-12-31">
            </div>

            <button class="action-button btn-save" onclick="window.generarCalendarioEntreno()" style="margin-top:16px;">[ GENERAR PLAN ]</button>
            <button class="action-button btn-delete" onclick="window.toggleCuestionario()">[ CANCELAR ]</button>
          </div>

          <div id="calendarioEntreno" style="display:none;">
            <h3>> TU PLAN_</h3>
            <div class="nota-plan">
              <p><strong>üìå Plan de entrenamiento personalizado</strong></p>
              <p>Este plan est√° generado en base a tu perfil y objetivos. Cada sesi√≥n ha sido seleccionada para maximizar tu progreso y evitar repeticiones.</p>
              <p>‚úÖ Ajusta las intensidades seg√∫n tus sensaciones.<br>‚úÖ Respeta los d√≠as de descanso.<br>‚úÖ Conf√≠a en el proceso.</p>
            </div>
            <p id="resumenObjetivo" style="color: var(--accent-blue); margin:20px 0; text-align:center;"></p>
            <div class="calendar-grid-container">
              <div class="calendar-header"><div>LUN</div><div>MAR</div><div>MI√â</div><div>JUE</div><div>VIE</div><div>S√ÅB</div><div>DOM</div></div>
              <div id="calendarioGrid"></div>
            </div>
          </div>
        </div>

        <!-- TAB HISTORIAL -->
        <div id="tab-historial" class="tab-content">
          <h2>> HISTORIAL_</h2>
          <div class="historial-controls">
            <label for="historialLimit">Mostrar:</label>
            <select id="historialLimit" onchange="window.cargarHistorial()">
              <option value="10">10 entradas</option>
              <option value="25">25 entradas</option>
            </select>
            <button class="action-button btn-copy" onclick="window.exportarHistorialCSV()" style="width:auto; margin:0;">üì• CSV</button>
          </div>
          <div id="historialContainer"></div>
          <button class="action-button btn-delete" onclick="window.borrarHistorial()" style="margin-top:16px;">üóëÔ∏è LIMPIAR TODO EL HISTORIAL</button>
        </div>

        <!-- TAB SOPORTE -->
        <div id="tab-soporte" class="tab-content">
          <h2>> SOPORTE_</h2>
          <div class="soporte-section">
            <div class="soporte-tabs">
              <button class="soporte-tab active" onclick="window.cambiarSoporteTab('recibidos')">üì• RECIBIDOS</button>
              <button class="soporte-tab" onclick="window.cambiarSoporteTab('enviados')">üì§ ENVIADOS</button>
            </div>
            <div id="soporte-recibidos" class="soporte-panel active">
              <h3>Mensajes del administrador</h3>
              <div id="listaMensajesRecibidos"></div>
            </div>
            <div id="soporte-enviados" class="soporte-panel">
              <h3>Tus mensajes al admin</h3>
              <div class="nuevo-mensaje">
                <textarea id="mensajeUsuario" placeholder="> ESCRIBE TU CONSULTA..."></textarea>
                <button class="send-message-btn" onclick="window.enviarMensajeUsuario()">üì§ ENVIAR MENSAJE</button>
              </div>
              <div id="listaMensajesEnviados" style="margin-top:20px;"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tarea 11: Cerrar sesi√≥n en p√≠ldora -->
      <div class="footer" id="footer">
        <a href="#" onclick="window.logoutUser(); return false;" class="logout-pill">[ cerrar sesi√≥n ]</a>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
    (function() {
      // ==================== CONFIGURACI√ìN DE FIREBASE ====================
      const firebaseConfig = {
        apiKey: "AIzaSyBw4VYLEeFeG4Z2qJC56iPzzuAzlIkmErc",
        authDomain: "ri5-5b642.firebaseapp.com",
        databaseURL: "https://ri5-5b642-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "ri5-5b642",
        storageBucket: "ri5-5b642.firebasestorage.app",
        messagingSenderId: "889154598385",
        appId: "1:889154598385:web:1d4e7dad605a42c1c60050"
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      // ==================== M√ìDULO UTILS ====================
      const Utils = {
        parseTime(t) { t = t.trim(); if(!t) return NaN; const m = t.match(/^(\d{1,3}):?(\d{0,2})$/); if(!m) return NaN; const min = parseInt(m[1]), seg = m[2]?parseInt(m[2]):0; if(seg>59||min>120||min<10) return NaN; return min + seg/60; },
        formatR(r) { if(!isFinite(r)||r<=0) return "--:--"; let m = Math.floor(r), s = Math.round((r-m)*60); if(s===60){ m++; s=0; } return m+":"+(s<10?'0':'')+s; },
        showLoading(btn) { btn.classList.add('loading'); btn.disabled=true; },
        hideLoading(btn) { btn.classList.remove('loading'); btn.disabled=false; },
        showTemporaryMessage(btn, msg, ok=true) { const orig = btn.innerText; btn.innerText = msg; btn.classList.add(ok?'btn-success':'btn-error'); setTimeout(()=>{ btn.innerText=orig; btn.classList.remove('btn-success','btn-error'); },2000); },
        hashPassword(str) { return btoa(str + "_RI5_SALT"); }
      };

      // ==================== M√ìDULO STORAGE ====================
      const Storage = {
        getUsers() { return db.ref('users').once('value').then(s => s.val()||{}); },
        saveUsers(u) { return db.ref('users').set(u); },
        getUserContadores(username) {
          return db.ref('users/' + username + '/contadores').once('value').then(s => s.val() || { calculos:0, mes: new Date().getMonth() });
        },
        setUserContadores(username, contadores) {
          return db.ref('users/' + username + '/contadores').set(contadores);
        },
        getHistorial(u) { if(!u) return Promise.resolve([]); return db.ref('users/'+u+'/historial').once('value').then(s => s.val()||[]); },
        saveHistorial(u,h) { if(!u) return Promise.reject(); return db.ref('users/'+u+'/historial').set(h); },
        getUltimoPlan(u) { if(!u) return Promise.resolve(null); return db.ref('users/'+u+'/ultimoPlan').once('value').then(s => s.val()||null); },
        setUltimoPlan(u,p) { if(!u) return Promise.reject(); return db.ref('users/'+u+'/ultimoPlan').set(p); },
        removeUltimoPlan(u) { if(!u) return Promise.reject(); return db.ref('users/'+u+'/ultimoPlan').remove(); },
        getUltimoCalculo(u) { if(!u) return Promise.resolve(null); return db.ref('users/'+u+'/ultimoCalculo').once('value').then(s => s.val()||null); },
        setUltimoCalculo(u,c) { if(!u) return Promise.reject(); return db.ref('users/'+u+'/ultimoCalculo').set(c); },
        getMensajes() { return db.ref('mensajes').once('value').then(s => s.val()||{}); },
        saveMensajes(m) { return db.ref('mensajes').set(m); },
        getMensajesUsuario(u) { return this.getMensajes().then(t => t[u]||[]); },
        marcarLeido(u,i) { return this.getMensajes().then(t=>{ if(t[u]&&t[u][i]){ t[u][i].leido=true; return this.saveMensajes(t); } }); },
        borrarMensajeUsuario(u,i) { return this.getMensajes().then(t=>{ if(t[u]&&t[u][i]){ t[u].splice(i,1); if(t[u].length===0) delete t[u]; return this.saveMensajes(t); } }); },
        enviarMensajeUsuario(us,txt) { return this.getMensajes().then(t=>{ const k="admin_"+us; if(!t[k]) t[k]=[]; t[k].push({fecha:new Date().toLocaleString(),texto:txt,leido:false,esUsuario:true}); return this.saveMensajes(t); }); },
        enviarMensajeAdminAUsuario(us,txt) { return this.getMensajes().then(t=>{ if(!t[us]) t[us]=[]; t[us].push({fecha:new Date().toLocaleString(),texto:txt,leido:false,esAdmin:true}); return this.saveMensajes(t); }); },
        getMensajesEnviadosUsuario(u) { return this.getMensajes().then(t=> t["admin_"+u]||[]); },
        getMensajesRecibidosAdmin() { return this.getMensajes().then(t=>{ const r=[]; Object.keys(t).forEach(k=>{ if(k.startsWith('admin_')){ const u=k.replace('admin_',''); t[k].forEach((msg,idx)=> r.push({usuario:u,mensaje:msg,idx,key:k})); } }); return r; }); },
        getMensajesEnviadosAdmin() { return this.getMensajes().then(t=>{ const e=[]; Object.keys(t).forEach(k=>{ if(!k.startsWith('admin_')){ t[k].forEach((msg,idx)=> { if(msg.esAdmin) e.push({usuario:k,mensaje:msg,idx,key:k}); }); } }); return e; }); },
        borrarMensaje(k,i) { return this.getMensajes().then(t=>{ if(t[k]&&t[k][i]){ t[k].splice(i,1); if(t[k].length===0) delete t[k]; return this.saveMensajes(t); } }); }
      };

      // ==================== ESTADO GLOBAL ====================
      const AppState = {
        zonasCalculadas: false, lastName: "", lastAge: 0, lastFC: 0, lastUL: 0,
        lastZones: [], lastPred: [], lastRitmoBase: 0,
        ultimoPlanParams: null, planGeneradoActual: null,
        camposTocados: { name: false, age: false, time: false },
        currentUser: null, currentSesionDetalle: null, deferredPrompt: null,
        mensajesNoLeidos: 0,
        mensajesNoLeidosAdmin: 0,
        isPremium: false,
        // Tarea 6: Contadores para l√≠mite de c√°lculos
        calculosMes: 0,
        mesActual: new Date().getMonth(),
        usuariosVistos: JSON.parse(localStorage.getItem('usuariosVistos')||'[]'),
        setLastCalc(d) { this.lastName=d.name; this.lastAge=d.age; this.lastFC=d.fcMax; this.lastUL=d.ul; this.lastZones=d.zones; this.lastPred=d.pred; this.lastRitmoBase=d.ritmoBase; this.zonasCalculadas=true; },
        clearLastCalc() { this.zonasCalculadas=false; this.lastName=""; this.lastAge=0; this.lastFC=0; this.lastUL=0; this.lastZones=[]; this.lastPred=[]; this.lastRitmoBase=0; },
        async setCurrentUser(u, premium=false) {
          this.currentUser = u; this.isPremium = premium;
          u?localStorage.setItem('ri5_current_user',u):localStorage.removeItem('ri5_current_user');
          const title = document.getElementById('ri5Title'); if(title){ if(premium) title.classList.add('premium'); else title.classList.remove('premium'); }
          if(u) document.getElementById('name').value = u;
          // Cargar contadores si no es premium
          if (!premium && u) {
            const contadores = await Storage.getUserContadores(u);
            this.mesActual = new Date().getMonth();
            if (contadores.mes === this.mesActual) {
              this.calculosMes = contadores.calculos || 0;
            } else {
              this.calculosMes = 0;
              await Storage.setUserContadores(u, { calculos:0, mes: this.mesActual });
            }
            UI.actualizarContadorCalculos();
          } else if (premium) {
            this.calculosMes = Infinity;
            UI.actualizarContadorCalculos();
          }
        },
        async incrementarCalculo() {
          if (!this.currentUser || this.isPremium) return;
          this.calculosMes++;
          await Storage.setUserContadores(this.currentUser, { calculos: this.calculosMes, mes: this.mesActual });
          UI.actualizarContadorCalculos();
        }
      };

      // ==================== M√ìDULO AUTENTICACI√ìN ====================
      const Auth = {
        switchAuthTab(tab) { document.querySelectorAll('.auth-tab').forEach(b=>b.classList.remove('active')); document.querySelectorAll('.auth-form').forEach(f=>f.classList.remove('active')); if(tab==='login'){ document.querySelector('.auth-tab').classList.add('active'); document.getElementById('loginForm').classList.add('active'); }else{ document.querySelectorAll('.auth-tab')[1].classList.add('active'); document.getElementById('registerForm').classList.add('active'); } },
        async registerUser() {
          const u = document.getElementById('regUsername').value.trim(), p = document.getElementById('regPassword').value.trim(), err = document.getElementById('registerError');
          if(!u||!p) { err.innerText="> COMPLETA TODOS LOS CAMPOS_"; err.classList.add('visible'); return; }
          if(u.length<3) { err.innerText="> M√çNIMO 3 CARACTERES_"; err.classList.add('visible'); return; }
          if(p.length<4) { err.innerText="> M√çNIMO 4 CARACTERES_"; err.classList.add('visible'); return; }
          const users = await Storage.getUsers();
          if(users[u]) { err.innerText="> EL USUARIO YA EXISTE_"; err.classList.add('visible'); return; }
          const expiry = new Date(); 
          expiry.setMonth(expiry.getMonth() + 3);
          users[u] = { 
            password: Utils.hashPassword(p), 
            created: new Date().toISOString(), 
            expires: expiry.toISOString(),
            premium: true,
            contadores: { calculos: 0, mes: new Date().getMonth() }
          };
          await Storage.saveUsers(users);
          await Storage.enviarMensajeAdminAUsuario(u, "¬°Bienvenido a RI5! Disfruta de 3 meses premium gratis.");
          await AppState.setCurrentUser(u, true);
          document.getElementById("loginPage").style.opacity="0";
          setTimeout(()=>{
            document.getElementById("loginPage").style.display="none";
            document.getElementById("mainContent").style.display="flex";
            document.getElementById("userWelcome").innerText = `> BIENVENIDO, ${u.toUpperCase()}_ ¬∑ PREMIUM HASTA ${expiry.toLocaleDateString()}`;
            UI.changeDailyTip(); UI.startConsejoAutoChange();
          },300);
        },
        async loginUser() {
          const u = document.getElementById('loginUsername').value.trim(), p = document.getElementById('loginPassword').value.trim(), err = document.getElementById('loginError');
          if(!u||!p) { err.innerText="> INTRODUCE USUARIO Y CONTRASE√ëA_"; err.classList.add('visible'); return; }
          if(u==='admin' && p==='091118110485120385') { Auth.mostrarAdminPanel(); return; }
          const users = await Storage.getUsers();
          const user = users[u];
          if(!user || user.password !== Utils.hashPassword(p)) { err.innerText="> INCORRECTO_"; err.classList.add('visible'); return; }
          const now = new Date(), expiry = new Date(user.expires);
          if(now>expiry){ if(user.premium) alert("> Tu per√≠odo premium ha expirado."); else { err.innerText="> ACCESO EXPIRADO_"; err.classList.add('visible'); return; } }
          await AppState.setCurrentUser(u, user.premium||false);
          const msgs = await Storage.getMensajesUsuario(u);
          AppState.mensajesNoLeidos = msgs.filter(m=>!m.leido).length;
          UI.actualizarBadgeMensajes();
          document.getElementById("loginPage").style.opacity="0";
          setTimeout(()=>{
            document.getElementById("loginPage").style.display="none";
            document.getElementById("mainContent").style.display="flex";
            document.getElementById("userWelcome").innerText = `> BIENVENIDO, ${u.toUpperCase()}_ ¬∑ ${user.premium?'PREMIUM':'ACCESO'} HASTA ${expiry.toLocaleDateString()}`;
            UI.changeDailyTip(); UI.startConsejoAutoChange();
            UI.cargarMensajesRecibidos(); UI.cargarMensajesEnviados();
            Storage.getUltimoCalculo(u).then(c=>{ if(c){ AppState.setLastCalc(c); UI.mostrarResultadosGuardados(c); } });
          },300);
        },
        mostrarAdminPanel() { document.getElementById("loginPage").style.display="none"; document.getElementById("mainContent").style.display="none"; document.getElementById("adminPage").style.display="flex"; Admin.actualizarAdminPanel(); },
        logoutUser() { if(!confirm("> ¬øCERRAR SESI√ìN?_")) return; AppState.setCurrentUser(null); document.getElementById("mainContent").style.display="none"; document.getElementById("loginPage").style.display="flex"; document.getElementById("loginUsername").value=''; document.getElementById("loginPassword").value=''; document.getElementById("results").innerHTML=''; document.getElementById("calendarioEntreno").style.display="none"; AppState.clearLastCalc(); },
        logoutAdmin() { document.getElementById("adminPage").style.display="none"; document.getElementById("loginPage").style.display="flex"; },
        async checkSavedSession() {
          const s = localStorage.getItem('ri5_current_user'); if(!s) return false;
          const users = await Storage.getUsers(); const user = users[s];
          if(!user){ localStorage.removeItem('ri5_current_user'); return false; }
          const now = new Date(), expiry = new Date(user.expires);
          if(now>expiry && !user.premium){ localStorage.removeItem('ri5_current_user'); return false; }
          await AppState.setCurrentUser(s, user.premium||false);
          document.getElementById("loginPage").style.display="none";
          document.getElementById("mainContent").style.display="flex";
          document.getElementById("userWelcome").innerText = `> BIENVENIDO, ${s.toUpperCase()}_ ¬∑ ${user.premium?'PREMIUM':'ACCESO'} HASTA ${expiry.toLocaleDateString()}`;
          if(now>expiry && user.premium) setTimeout(()=>alert("> Tu per√≠odo premium ha expirado."),500);
          document.getElementById('name').value = s;
          UI.changeDailyTip(); UI.startConsejoAutoChange();
          const calc = await Storage.getUltimoCalculo(s); if(calc){ AppState.setLastCalc(calc); UI.mostrarResultadosGuardados(calc); }
          return true;
        },
        showPremiumBenefits() { 
          document.getElementById('premiumOverlay').classList.add('active');
          document.getElementById('premiumModal').classList.add('active');
        }
      };
      window.cerrarPremiumModal = function() {
        document.getElementById('premiumOverlay').classList.remove('active');
        document.getElementById('premiumModal').classList.remove('active');
      };

      // ==================== M√ìDULO ADMIN (Tarea 1 completa) ====================
      const Admin = {
        async actualizarAdminPanel() {
          const users = await Storage.getUsers();
          const total = Object.keys(users).length, ahora = new Date();
          const activos = Object.values(users).filter(u=>new Date(u.expires)>ahora).length, expirados = total-activos;
          document.getElementById("adminStats").innerHTML = `
            <span class="stat-badge" onclick="Admin.abrirModalUsuariosPorTipo('todos')">üìä TOTAL <span class="number">${total}</span></span>
            <span class="stat-badge" onclick="Admin.abrirModalUsuariosPorTipo('activos')">‚úÖ ACTIVOS <span class="number">${activos}</span></span>
            <span class="stat-badge" onclick="Admin.abrirModalUsuariosPorTipo('expirados')">‚è≥ EXPIRADOS <span class="number">${expirados}</span></span>
          `;
          document.getElementById("adminWelcome").innerText = `> ADMIN ¬∑ ${new Date().toLocaleString()}`;
          this.cargarMensajesAdmin();
        },

        async abrirModalUsuariosPorTipo(tipo) {
          const users = await Storage.getUsers();
          const ahora = new Date();
          let usuariosFiltrados = {};
          let titulo = "üë• TODOS LOS USUARIOS";
          
          if (tipo === 'activos') {
            usuariosFiltrados = Object.fromEntries(Object.entries(users).filter(([u,d]) => new Date(d.expires) > ahora));
            titulo = "‚úÖ USUARIOS ACTIVOS";
          } else if (tipo === 'expirados') {
            usuariosFiltrados = Object.fromEntries(Object.entries(users).filter(([u,d]) => new Date(d.expires) <= ahora));
            titulo = "‚è≥ USUARIOS EXPIRADOS";
          } else {
            usuariosFiltrados = users;
            titulo = "üë• TODOS LOS USUARIOS";
          }
          
          document.getElementById('modalUsuariosTitulo').innerText = titulo;
          const modal = document.getElementById('modalUsuarios');
          const listEl = document.getElementById('modalUserList');
          
          if (Object.keys(usuariosFiltrados).length === 0) {
            listEl.innerHTML = '<div class="modal-empty">üì≠ No hay usuarios en esta categor√≠a</div>';
          } else {
            this.renderizarListaUsuarios(usuariosFiltrados, listEl);
          }
          
          modal.classList.add('active');
          
          document.getElementById('modalBuscarUsuario').oninput = (e) => {
            this.filtrarUsuariosModal(e.target.value, usuariosFiltrados);
          };
        },

        renderizarListaUsuarios(users, container, filtro='') {
          const items = Object.entries(users)
            .filter(([u]) => u.toLowerCase().includes(filtro.toLowerCase()))
            .map(([u,d]) => {
              const creado = new Date(d.created).toLocaleDateString();
              const expiry = new Date(d.expires).toLocaleDateString();
              const premium = d.premium ? '‚úÖ PREMIUM' : '‚ùå NO PREMIUM';
              return `
                <div class="usuario-item" onclick="window.toggleUsuario(this)">
                  <div class="usuario-header">
                    <span>${u} ${d.premium ? '<span class="premium-tag">üëë</span>' : ''}</span>
                    <span class="flecha">‚ñº</span>
                  </div>
                  <div class="usuario-detalle">
                    <div class="user-details">
                      <span>üìÖ ${creado}</span>
                      <span>‚è≥ ${expiry}</span>
                      <span>${premium}</span>
                    </div>
                    <div class="modal-user-actions">
                      <button onclick="event.stopPropagation(); window.extenderUsuario('${u}',1)">+1 MES</button>
                      <button onclick="event.stopPropagation(); window.extenderUsuario('${u}',3)">+3 MESES</button>
                      <button onclick="event.stopPropagation(); window.togglePremium('${u}')">üëë PREMIUM</button>
                      <button onclick="event.stopPropagation(); window.enviarMensajeAUsuario('${u}')">üì® MENSAJE</button>
                      <button onclick="event.stopPropagation(); window.eliminarUsuario('${u}')">ELIMINAR</button>
                    </div>
                  </div>
                </div>
              `;
            }).join('');
          container.innerHTML = items;
        },

        filtrarUsuariosModal(filtro, baseUsers) {
          const listEl = document.getElementById('modalUserList');
          if (Object.keys(baseUsers).length === 0) {
            listEl.innerHTML = '<div class="modal-empty">üì≠ No hay usuarios en esta categor√≠a</div>';
          } else {
            this.renderizarListaUsuarios(baseUsers, listEl, filtro);
          }
        },

        async extenderUsuario(u,m) {
          const users = await Storage.getUsers();
          if(users[u]){ const e=new Date(users[u].expires); e.setMonth(e.getMonth()+m); users[u].expires=e.toISOString(); await Storage.saveUsers(users); this.actualizarAdminPanel(); alert(`‚úÖ ${u} extendido ${m} mes`); this.abrirModalUsuariosPorTipo('todos'); }
        },

        async togglePremium(u) {
          const users = await Storage.getUsers();
          if(users[u]){ users[u].premium = !users[u].premium; await Storage.saveUsers(users); this.actualizarAdminPanel(); alert(`‚úÖ Premium de ${u} cambiado`); this.abrirModalUsuariosPorTipo('todos'); }
        },

        async eliminarUsuario(u) {
          if(!confirm(`> ¬øELIMINAR "${u}"?`)) return;
          const users = await Storage.getUsers();
          delete users[u]; await Storage.saveUsers(users);
          if(AppState.currentUser===u) AppState.setCurrentUser(null);
          this.actualizarAdminPanel(); alert(`‚úÖ ${u} eliminado`); this.abrirModalUsuariosPorTipo('todos');
        },

        exportarUsuariosCSV() { Storage.getUsers().then(u=>{ let csv="Usuario,Creado,Expira,Premium,Estado\n"; Object.entries(u).forEach(([u,d])=>csv+=`${u},${new Date(d.created).toLocaleDateString()},${new Date(d.expires).toLocaleDateString()},${d.premium?'SI':'NO'},${new Date()<=new Date(d.expires)?'ACTIVO':'EXPIRADO'}\n`); const b=new Blob([csv],{type:'text/csv'}), a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=`usuarios_${new Date().toISOString().split('T')[0]}.csv`; a.click(); URL.revokeObjectURL(a.href); }); },

        async renovarExpirados() {
          if(!confirm("> ¬øRENOVAR TODOS LOS EXPIRADOS POR 1 MES?")) return;
          const users = await Storage.getUsers(), ahora=new Date();
          Object.entries(users).forEach(([u,d])=>{ if(new Date(d.expires)<=ahora){ const e=new Date(d.expires); e.setMonth(e.getMonth()+1); users[u].expires=e.toISOString(); } });
          await Storage.saveUsers(users); this.actualizarAdminPanel(); alert("‚úÖ EXPIRADOS RENOVADOS");
        },

        async enviarMensajeAUsuario(usuario) { const txt=prompt(`> MENSAJE PARA ${usuario}:`); if(!txt) return; await Storage.enviarMensajeAdminAUsuario(usuario,txt); alert("‚úÖ ENVIADO"); this.cargarMensajesAdmin(); },

        async cargarMensajesAdmin() {
          const recibidos = await Storage.getMensajesRecibidosAdmin();
          let htmlRec='', noLeidosRecibidos=0;
          recibidos.forEach(item=>{
            if(!item.mensaje.leido) noLeidosRecibidos++;
            htmlRec+=`<div class="mensaje-item"><div class="mensaje-header" onclick="this.parentNode.classList.toggle('abierto')"><span>üì® ${item.mensaje.fecha} ¬∑ ${item.usuario}</span><span class="flecha">‚ñº</span><button class="delete-mensaje" onclick="event.stopPropagation(); window.borrarMensajeAdmin('${item.key}',${item.idx})">üóëÔ∏è</button></div><div class="mensaje-contenido">${item.mensaje.texto}</div></div>`;
          });
          document.getElementById('listaMensajesRecibidosAdmin').innerHTML = htmlRec || '<p>üì≠ NO HAY MENSAJES</p>';
          
          const enviados = await Storage.getMensajesEnviadosAdmin();
          let htmlEnv='';
          enviados.forEach(item=>{
            const claseNoLeido = !item.mensaje.leido ? 'no-leido-usuario' : '';
            htmlEnv+=`<div class="mensaje-item ${claseNoLeido}"><div class="mensaje-header" onclick="this.parentNode.classList.toggle('abierto')"><span>üì§ ${item.mensaje.fecha} ¬∑ <strong style="color:var(--accent-green);">üë§ ${item.usuario}</strong></span><span class="flecha">‚ñº</span><button class="delete-mensaje" onclick="event.stopPropagation(); window.borrarMensajeAdmin('${item.key}',${item.idx})">üóëÔ∏è</button></div><div class="mensaje-contenido"><div style="margin-bottom:8px;color:var(--accent-green);"><strong>Para: ${item.usuario}</strong></div>${item.mensaje.texto}</div></div>`;
          });
          document.getElementById('listaMensajesEnviadosAdmin').innerHTML = htmlEnv || '<p>üì≠ NO HAS ENVIADO MENSAJES</p>';
          
          AppState.mensajesNoLeidosAdmin = noLeidosRecibidos;
          this.actualizarBadgeAdminSoporte();
        },

        actualizarBadgeAdminSoporte() { const t=document.getElementById('adminSoporteTab'); if(AppState.mensajesNoLeidosAdmin>0) t.classList.add('soporte-unread'); else t.classList.remove('soporte-unread'); },

        cambiarSoporteTab(tab) { document.querySelectorAll('#admin-tab-soporte .soporte-tab').forEach(t=>t.classList.remove('active')); document.querySelectorAll('#admin-tab-soporte .soporte-panel').forEach(p=>p.classList.remove('active')); if(tab==='recibidos'){ document.querySelectorAll('#admin-tab-soporte .soporte-tab')[0].classList.add('active'); document.getElementById('admin-soporte-recibidos').classList.add('active'); }else{ document.querySelectorAll('#admin-tab-soporte .soporte-tab')[1].classList.add('active'); document.getElementById('admin-soporte-enviados').classList.add('active'); } }
      };

      window.toggleUsuario = (el)=>el.classList.toggle('abierto');
      window.extenderUsuario = Admin.extenderUsuario.bind(Admin);
      window.togglePremium = Admin.togglePremium.bind(Admin);
      window.eliminarUsuario = Admin.eliminarUsuario.bind(Admin);
      window.enviarMensajeAUsuario = Admin.enviarMensajeAUsuario.bind(Admin);
      window.exportarUsuariosCSV = Admin.exportarUsuariosCSV.bind(Admin);
      window.renovarExpirados = Admin.renovarExpirados.bind(Admin);
      window.borrarMensajeAdmin = (k,i)=>Storage.borrarMensaje(k,i).then(()=>Admin.cargarMensajesAdmin());
      window.Admin = Admin;

      window.switchAdminTab = function(tab) {
        document.querySelectorAll('#adminPage .tab-button').forEach(b=>b.classList.remove('active'));
        document.querySelectorAll('#adminPage .tab-content').forEach(c=>c.classList.remove('active'));
        if(tab==='usuarios'){ document.querySelectorAll('#adminPage .tab-button')[0].classList.add('active'); document.getElementById('admin-tab-usuarios').classList.add('active'); }
        else { document.querySelectorAll('#adminPage .tab-button')[1].classList.add('active'); document.getElementById('admin-tab-soporte').classList.add('active'); Admin.cargarMensajesAdmin(); }
      };
      window.cambiarAdminSoporteTab = (tab)=>Admin.cambiarSoporteTab(tab);

      // ==================== M√ìDULO ENTRENAMIENTO ====================
      const Training = {
        startCalc() { UI.validarTodo(); if(document.getElementById("calcBtn").disabled) return; const b=document.getElementById("calcBtn"); Utils.showLoading(b); setTimeout(()=>{ this.calculate(); Utils.hideLoading(b); Utils.showTemporaryMessage(b,"‚úì CALCULADO",true); document.getElementById('results').scrollIntoView({behavior:'smooth'}); },300); },
        calculate() {
          const n=document.getElementById("name").value.trim(), a=parseInt(document.getElementById("age").value), t=Utils.parseTime(document.getElementById("time").value);
          if(!n||!a||isNaN(t)) return alert("> COMPLETA TODOS LOS CAMPOS CORRECTAMENTE_");
          
          // Tarea 6: L√≠mite de c√°lculos para no premium
          if (!AppState.isPremium && AppState.calculosMes >= 2) {
            alert("> Has alcanzado el l√≠mite de 2 c√°lculos este mes. Hazte premium para c√°lculos ilimitados.");
            return;
          }
          
          const r=t/6, fc=220-a, ul=Math.round(fc*0.92*1.03);
          const pred=[
            {dist:2, color:"var(--accent-blue)", ritmo:r*0.98},
            {dist:6, color:"var(--accent-green)", ritmo:r},
            {dist:10,color:"var(--accent-yellow)", ritmo:r*1.05},
            {dist:21,color:"var(--accent-red)", ritmo:r*1.12},
            {dist:42,color:"var(--accent-purple)", ritmo:r*1.20}
          ];
          const zones=[
            ["Z1","RECUPERACI√ìN ACTIVA",0.75,0.80,1.35,"z1",
             "RITMO: "+Utils.formatR(r*1.35)+" min/km<br><br>" +
             "üî¨ **QU√â MEJORA:** Circulaci√≥n sangu√≠nea, eliminaci√≥n de toxinas, regeneraci√≥n muscular.<br><br>" +
             "üèÉ **PARA QU√â SIRVE:** Calentamientos, vueltas a la calma, d√≠as post-entreno duro, sesiones de recuperaci√≥n activa.<br><br>" +
             "üòå **SENSACI√ìN:** Muy suave, puedes mantener una conversaci√≥n sin esfuerzo. Respiraci√≥n completamente controlada.<br><br>" +
             "üìÜ **CU√ÅNDO USARLA:** Despu√©s de sesiones intensas, en d√≠as de descanso activo, o como parte del calentamiento antes de series."],
            ["Z2","BASE AER√ìBICA",0.80,0.90,1.25,"z2",
             "RITMO: "+Utils.formatR(r*1.25)+" min/km<br><br>" +
             "üî¨ **QU√â MEJORA:** Capilarizaci√≥n muscular, densidad mitocondrial, eficiencia card√≠aca, oxidaci√≥n de grasas.<br><br>" +
             "üèÉ **PARA QU√â SIRVE:** Desarrollar la base aer√≥bica, mejorar la resistencia, aumentar la capacidad de quemar grasa como combustible.<br><br>" +
             "üòå **SENSACI√ìN:** C√≥modo pero constante. Puedes hablar con frases cortas. El 'ritmo de conversaci√≥n' por excelencia.<br><br>" +
             "üìÜ **CU√ÅNDO USARLA:** En la mayor√≠a de tus rodajes, especialmente al principio de la temporada o en semanas de volumen."],
            ["Z3","RITMO TEMPO",0.90,0.95,1.15,"z3",
             "RITMO: "+Utils.formatR(r*1.15)+" min/km<br><br>" +
             "üî¨ **QU√â MEJORA:** Tolerancia al lactato, capacidad de mantener ritmos r√°pidos, transici√≥n aer√≥bica-anaer√≥bica.<br><br>" +
             "üèÉ **PARA QU√â SIRVE:** Aumentar la velocidad sin acumular lactato, preparar el cuerpo para ritmos de competici√≥n m√°s exigentes.<br><br>" +
             "üòå **SENSACI√ìN:** 'C√≥modamente duro'. Puedes decir algunas palabras, pero prefieres no hacerlo. Notas el esfuerzo pero es sostenible.<br><br>" +
             "üìÜ **CU√ÅNDO USARLA:** En sesiones de tempo, entrenamientos de ritmo espec√≠fico para 10k o media marat√≥n."],
            ["Z4","UMBRAL L√ÅCTICO",0.95,1.02,1.05,"z4",
             "RITMO: "+Utils.formatR(r*1.05)+" min/km<br><br>" +
             "üî¨ **QU√â MEJORA:** Velocidad de eliminaci√≥n de lactato, capacidad de mantener esfuerzos intensos, econom√≠a de carrera.<br><br>" +
             "üèÉ **PARA QU√â SIRVE:** Clave para mejorar en 10k, media marat√≥n y marat√≥n. Es el ritmo que puedes mantener aproximadamente una hora.<br><br>" +
             "üòå **SENSACI√ìN:** Duro pero controlado. Hablar es muy dif√≠cil. Sientes que podr√≠as mantenerlo un buen rato, pero con esfuerzo.<br><br>" +
             "üìÜ **CU√ÅNDO USARLA:** En series largas (2000m, 3000m), entrenamientos de ritmo de marat√≥n o medio marat√≥n."],
            ["Z5","VO‚ÇÇM√ÅX",1.02,1.06,0.95,"z5",
             "RITMO: "+Utils.formatR(r*0.95)+" min/km<br><br>" +
             "üî¨ **QU√â MEJORA:** Potencia aer√≥bica m√°xima, capacidad de transportar ox√≠geno, tolerancia a esfuerzos muy intensos.<br><br>" +
             "üèÉ **PARA QU√â SIRVE:** Esencial para distancias cortas (5k/10k) y para aumentar la velocidad m√°xima. Mejora el rendimiento en competiciones explosivas.<br><br>" +
             "üòå **SENSACI√ìN:** Muy duro. Solo puedes mantenerlo de 3 a 8 minutos. La respiraci√≥n es agitada y las piernas queman.<br><br>" +
             "üìÜ **CU√ÅNDO USARLA:** En series de 800m, 1000m, 1200m, o en entrenamientos de intervalos de alta intensidad."],
            ["Z6","VELOCIDAD / POTENCIA",1.06,1.12,0.85,"z6",
             "RITMO: "+Utils.formatR(r*0.85)+" min/km<br><br>" +
             "üî¨ **QU√â MEJORA:** Potencia neuromuscular, reclutamiento de fibras r√°pidas, econom√≠a de carrera, velocidad m√°xima.<br><br>" +
             "üèÉ **PARA QU√â SIRVE:** √ötil para sprints finales, cambios de ritmo en carrera, terrenos explosivos y mejorar la t√©cnica de carrera.<br><br>" +
             "üòå **SENSACI√ìN:** M√°ximo esfuerzo, apenas sostenible m√°s de 30-60 segundos. Zancada r√°pida y potente. Sensaci√≥n de explosividad.<br><br>" + // Tarea 3: a√±adido "segundos"
             "üìÜ **CU√ÅNDO USARLA:** En series muy cortas (100m, 200m), cuestas explosivas, o como trabajo de velocidad despu√©s de un calentamiento completo."]
          ];
          const calc = {name:n, age:a, fcMax:fc, ul:ul, zones, pred, ritmoBase:r};
          AppState.setLastCalc(calc); UI.mostrarResultados(calc); document.getElementById("footer").innerText=`${n} ¬∑ ${new Date().toLocaleDateString('es-ES')} ¬∑ RI5`;
          
          // Tarea 6: Incrementar contador si no es premium
          if (!AppState.isPremium) AppState.incrementarCalculo();
          
          this.guardarCalculoAutomatico(calc);
        },
        async guardarCalculoAutomatico(calc) {
          if(!AppState.currentUser) return;
          const ahora=new Date();
          let zonasResumen = calc.zones.map(z=>{ const min=Math.round(calc.ul*z[2]), max=Math.round(calc.ul*z[3]); return {zona:z[0],min,max}; });
          const data = { date: ahora.toLocaleDateString('es-ES'), hora: ahora.toLocaleTimeString('es-ES'), nombre:calc.name, edad:calc.age, fcMax:calc.fcMax, umbral:calc.ul, ritmo6k:Utils.formatR(calc.ritmoBase), predicciones:calc.pred.map(p=>`${p.dist}km:${Utils.formatR(p.ritmo)}`).join(' '), resumen:`${calc.name} ¬∑ ${calc.age} a√±os ¬∑ 6km: ${Utils.formatR(calc.ritmoBase)}`, zonasResumen };
          let hist = await Storage.getHistorial(AppState.currentUser);
          hist.unshift(data); const lim = AppState.isPremium?25:10; if(hist.length>lim) hist.pop();
          await Storage.saveHistorial(AppState.currentUser, hist);
          await Storage.setUltimoCalculo(AppState.currentUser, calc);
          if(document.getElementById('tab-historial').classList.contains('active')) UI.cargarHistorial();
        },
        copyResults() {
          if(!AppState.lastName) return alert("> CALCULA ZONAS PRIMERO_");
          let txt = "üîπ RI5 - ZONAS DE ENTRENO üîπ\n\n";
          txt += `üë§ ${AppState.lastName} ¬∑ ${AppState.lastAge} a√±os\n‚ù§Ô∏è FC M√ÅX: ${AppState.lastFC} lpm ¬∑ UMBRAL: ${AppState.lastUL} lpm\n‚è±Ô∏è RITMO 6km: ${Utils.formatR(AppState.lastRitmoBase)} min/km\n\nüìä PREDICCIONES:\n`;
          AppState.lastPred.forEach(p=>txt+=`   ${p.dist} km ‚Üí ${Utils.formatR(p.ritmo)} min/km\n`);
          txt+=`\nüéØ ZONAS:\n`;
          AppState.lastZones.forEach(z=>{ const min=Math.round(AppState.lastUL*z[2]), max=Math.round(AppState.lastUL*z[3]); txt+=`   ${z[0]} ${z[1]}: ${min}-${max} lpm ¬∑ ${z[6].replace(/<br>/g,' ').replace(/üîπ/g,'‚Ä¢')}\n`; });
          navigator.clipboard.writeText(txt).then(()=>{ const btn=document.querySelector('.btn-copy'); if(btn) Utils.showTemporaryMessage(btn,"‚úÖ COPIADO",true); }).catch(()=>alert("> NO SE PUDO COPIAR."));
        }
      };

      // ==================== M√ìDULO UI ====================
      const UI = {
        consejos: ["La constancia es la clave.", "El descanso es entrenamiento.", "Conf√≠a en el proceso.", "La Z2 es tu mejor amiga.", "Hidrataci√≥n antes de sed.", "El sue√±o construye resistencia.", "Escucha a tu cuerpo.", "La nutrici√≥n es el combustible."],
        consejoIndex:0,
        changeDailyTip() { const e=document.getElementById("dailyTip"); if(e) setTimeout(()=>{ e.innerHTML='<span>> '+this.consejos[this.consejoIndex]+'</span><small>// pulsa para otro</small>'; this.consejoIndex=(this.consejoIndex+1)%this.consejos.length; },100); },
        changeConsejo() { const e=document.getElementById("curiosity"); if(e) setTimeout(()=>{ e.innerHTML='<span>'+this.consejos[this.consejoIndex]+'</span><small>// pulsa para otro</small>'; this.consejoIndex=(this.consejoIndex+1)%this.consejos.length; },100); },
        startConsejoAutoChange() { setInterval(()=>{ if(document.getElementById("loginPage").style.display!=="none") this.changeDailyTip(); if(document.getElementById("mainContent").style.display!=="none") this.changeConsejo(); },8000); },
        actualizarContadorCalculos() {
          const contadorEl = document.getElementById('calculosRestantes');
          if (contadorEl) {
            if (AppState.isPremium) {
              contadorEl.innerText = '‚ú® Premium: c√°lculos ilimitados';
            } else {
              const restantes = 2 - AppState.calculosMes;
              contadorEl.innerText = `üìä Te quedan ${restantes} c√°lculos este mes`;
            }
          }
        },
        marcarCampoTocado(c) { AppState.camposTocados[c]=true; this.validarCampo(c); this.validarTodo(); },
        validarCampo(c) {
          const el=document.getElementById(c), err=document.getElementById(c+'Error');
          if(!AppState.camposTocados[c]){ err.classList.remove('visible'); el.classList.remove('error'); return true; }
          let ok=true;
          if(c==='name') ok=el.value.trim().length>=2;
          else if(c==='age'){ const a=parseInt(el.value); ok=!isNaN(a)&&a>=14&&a<=85; }
          else if(c==='time'){ const t=Utils.parseTime(el.value); ok=!isNaN(t)&&t>=12&&t<=90; }
          if(!ok){ err.innerText=c==='name'?'> M√çNIMO 2 CARACTERES_':c==='age'?'> EDAD 14-85_':'> FORMATO MM:SS (12-90 MIN)_'; err.classList.add('visible'); el.classList.add('error'); }
          else{ err.classList.remove('visible'); el.classList.remove('error'); }
          return ok;
        },
        validarTodo() { const n=this.validarCampo('name'), a=this.validarCampo('age'), t=this.validarCampo('time'); document.getElementById("calcBtn").disabled = !(n&&a&&t); },
        mostrarResultados(d) { 
          let html=`<h2>> M√âTRICAS_</h2><div style="text-align:center; margin:20px 0;">${d.name} ¬∑ ${d.age} a√±os<br>FC M√ÅX: ${d.fcMax} lpm ¬∑ UMBRAL: ${d.ul} lpm<br>RITMO 6km: ${Utils.formatR(d.ritmoBase)} min/km</div><h2>> PREDICCIONES_</h2>`; 
          d.pred.forEach(p=>html+=`<div class="pred-bar" style="border-color:${p.color}; color:${p.color};">${p.dist} km ‚Üí ${Utils.formatR(p.ritmo)} min/km</div>`); // Tarea 4: centrado gracias a CSS
          html+=`<h2>> ZONAS_</h2>`; 
          d.zones.forEach(z=>{ const min=Math.round(d.ul*z[2]), max=Math.round(d.ul*z[3]); html+=`<div class="zone-card ${z[5]}" onclick="this.classList.toggle('active')"><strong>${z[0]} ‚Äì ${z[1]}</strong><br>FC: ${min}-${max} lpm<div class="long">${z[6]}</div></div>`; }); 
          html+=`<button class="action-button btn-copy" onclick="window.copyResults()">üìã COPIAR</button>`; 
          document.getElementById("results").innerHTML=html; 
        },
        mostrarResultadosGuardados(d) { this.mostrarResultados(d); },
        switchTab(tab) {
          document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
          const btns = document.querySelectorAll('.tab-button');
          for(let b of btns) if(b.textContent.includes(tab==='entreno'?'ENTRENO':tab==='plan'?'PLAN':tab==='historial'?'HISTORIAL':'SOPORTE')){ b.classList.add('active'); break; }
          document.getElementById(`tab-${tab}`).classList.add('active');
          if(tab==='historial') this.cargarHistorial();
          if(tab==='soporte'){ this.cargarMensajesRecibidos(); this.cargarMensajesEnviados(); }
        },
        async cargarHistorial() {
          const cont=document.getElementById("historialContainer");
          if(!AppState.currentUser){ cont.innerHTML='<p style="text-align:center; padding:20px; color: var(--text-secondary);">üì≠ SIN USUARIO</p>'; return; }
          let hist = await Storage.getHistorial(AppState.currentUser);
          const lim = parseInt(document.getElementById('historialLimit').value); if(hist.length>lim) hist = hist.slice(0,lim);
          if(!hist.length){ cont.innerHTML='<p style="text-align:center; padding:20px; color: var(--text-secondary);">üì≠ SIN HISTORIAL</p>'; return; }
          let html='<div class="historial-list">';
          hist.forEach((it,i)=>{
            let zonas=''; if(it.zonasResumen&&Array.isArray(it.zonasResumen)){ zonas='<div class="zonas-pastillas">'; it.zonasResumen.forEach(z=>zonas+=`<span class="zona-pastilla ${z.zona.toLowerCase()}"><span></span> ${z.zona}: ${z.min}-${z.max}</span>`); zonas+='</div>'; }
            const pred = it.predicciones?`<div class="predicciones">üìä ${it.predicciones}</div>`:'';
            const hora = it.hora?`<div class="hora-detalle">üïí ${it.hora}</div>`:'';
            // Tarea 9: Papelera a la derecha
            html+=`<div class="historial-item" onclick="window.toggleHistorialDetalle(this)">
              <div class="historial-header">
                <span class="fecha">üìÖ ${it.date}</span>
                <button class="delete-icon" onclick="event.stopPropagation(); window.borrarEntradaHistorial(${i})" title="Eliminar">üóëÔ∏è</button>
              </div>
              <div class="resumen">${it.resumen||it.nombre+' ¬∑ '+it.edad+' a√±os'}</div>
              <div class="detalle">
                ${hora}
                ${pred}
                ${zonas}
                ${it.fcMax?`<div>‚ù§Ô∏è FC M√°x: ${it.fcMax} lpm</div>`:''}
                ${it.umbral?`<div>‚ö° Umbral: ${it.umbral} lpm</div>`:''}
              </div>
            </div>`;
          });
          html+='</div>'; cont.innerHTML=html;
        },
        toggleHistorialDetalle(el){ el.classList.toggle('abierto'); },
        async borrarEntradaHistorial(i){
          if(!AppState.currentUser) return;
          if(!confirm("> ¬øELIMINAR ESTA ENTRADA?")) return;
          let hist=await Storage.getHistorial(AppState.currentUser); hist.splice(i,1); await Storage.saveHistorial(AppState.currentUser,hist); this.cargarHistorial(); alert("‚úÖ ELIMINADA");
        },
        async borrarHistorial(){
          if(!AppState.currentUser||!confirm("> ¬øELIMINAR TODO EL HISTORIAL?")) return;
          await Storage.saveHistorial(AppState.currentUser,[]); this.cargarHistorial(); alert("‚úÖ HISTORIAL LIMPIO");
        },
        exportarHistorialCSV() {
          if (!AppState.currentUser) return alert("> No hay usuario");
          Storage.getHistorial(AppState.currentUser).then(hist => {
            let csv = "Fecha,Hora,Nombre,Edad,FC M√°x,Umbral,Ritmo 6km,Predicciones,Resumen\n";
            hist.forEach(it => {
              csv += `${it.date},${it.hora || ''},${it.nombre || ''},${it.edad || ''},${it.fcMax || ''},${it.umbral || ''},${it.ritmo6k || ''},${it.predicciones || ''},${it.resumen || ''}\n`;
            });
            const b = new Blob([csv], {type:'text/csv'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(b);
            a.download = `historial_${AppState.currentUser}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(a.href);
          });
        },
        async cargarMensajesRecibidos(){
          if(!AppState.currentUser) return;
          const msgs=await Storage.getMensajesUsuario(AppState.currentUser);
          let html=''; msgs.forEach((m,i)=>{
            const nuevo=!m.leido?'nuevo':'';
            html+=`<div class="mensaje-item ${nuevo}" data-indice="${i}"><div class="mensaje-header" onclick="window.toggleMensajeRecibido(this,${i})"><span>üì® ${m.fecha} ¬∑ Admin</span><span class="flecha">‚ñº</span><button class="delete-mensaje" onclick="event.stopPropagation(); window.borrarMensajeUsuario(${i})">üóëÔ∏è</button></div><div class="mensaje-contenido">${m.texto}</div></div>`;
          });
          document.getElementById('listaMensajesRecibidos').innerHTML = html || '<p>üì≠ NO HAY MENSAJES</p>';
          this.actualizarBadgeMensajes();
        },
        async borrarMensajeUsuario(i){ if(!AppState.currentUser||!confirm("> ¬øELIMINAR?")) return; await Storage.borrarMensajeUsuario(AppState.currentUser,i); this.cargarMensajesRecibidos(); alert("‚úÖ ELIMINADO"); },
        async cargarMensajesEnviados(){
          if(!AppState.currentUser) return;
          const msgs=await Storage.getMensajesEnviadosUsuario(AppState.currentUser);
          let html=''; msgs.forEach(m=>{ html+=`<div class="mensaje-item"><div class="mensaje-header" onclick="this.parentNode.classList.toggle('abierto')"><span>üì§ ${m.fecha} ¬∑ T√∫</span><span class="flecha">‚ñº</span></div><div class="mensaje-contenido">${m.texto}</div></div>`; });
          document.getElementById('listaMensajesEnviados').innerHTML = html || '<p>üì≠ NO HAS ENVIADO MENSAJES</p>';
        },
        async toggleMensajeRecibido(h,i){ const it=h.closest('.mensaje-item'); it.classList.toggle('abierto'); if(it.classList.contains('nuevo')&&it.classList.contains('abierto')){ it.classList.remove('nuevo'); if(AppState.currentUser){ await Storage.marcarLeido(AppState.currentUser,i); const msgs=await Storage.getMensajesUsuario(AppState.currentUser); AppState.mensajesNoLeidos=msgs.filter(m=>!m.leido).length; this.actualizarBadgeMensajes(); } } },
        async enviarMensajeUsuario(){ if(!AppState.currentUser) return; const t=document.getElementById('mensajeUsuario').value.trim(); if(!t) return alert('> ESCRIBE UN MENSAJE_'); await Storage.enviarMensajeUsuario(AppState.currentUser,t); document.getElementById('mensajeUsuario').value=''; this.cargarMensajesEnviados(); alert('‚úÖ ENVIADO'); },
        cambiarSoporteTab(tab){ document.querySelectorAll('#tab-soporte .soporte-tab').forEach(t=>t.classList.remove('active')); document.querySelectorAll('#tab-soporte .soporte-panel').forEach(p=>p.classList.remove('active')); if(tab==='recibidos'){ document.querySelectorAll('#tab-soporte .soporte-tab')[0].classList.add('active'); document.getElementById('soporte-recibidos').classList.add('active'); }else{ document.querySelectorAll('#tab-soporte .soporte-tab')[1].classList.add('active'); document.getElementById('soporte-enviados').classList.add('active'); } },
        actualizarBadgeMensajes(){ const t=document.getElementById('soporteTabButton'); if(AppState.mensajesNoLeidos>0) t.classList.add('soporte-unread'); else t.classList.remove('soporte-unread'); },
        cerrarModalSesion(){ 
          const m=document.getElementById("detalleSesion"), o=document.getElementById("modalOverlay"); 
          m.classList.remove("visible"); o.classList.remove("visible"); 
        },
        cerrarPlan(){ document.getElementById("calendarioEntreno").style.display="none"; AppState.planGeneradoActual=null; },
        initDiasCheckboxes() {
          const container = document.getElementById('diasSemanaContainer');
          const dias = ['L', 'M', 'X', 'J', 'V', 'S', 'D'];
          let html = '';
          for (let i = 0; i < 7; i++) {
            const diaNum = i + 1;
            const checked = (diaNum === 1 || diaNum === 3 || diaNum === 6) ? 'checked' : '';
            html += `
              <div class="dia-checkbox">
                <input type="checkbox" id="dia${diaNum}" value="${diaNum}" ${checked}>
                <label for="dia${diaNum}">${dias[i]}</label>
              </div>
            `;
          }
          container.innerHTML = html;
        }
      };

      window.toggleHistorialDetalle = UI.toggleHistorialDetalle.bind(UI);
      window.borrarMensajeUsuario = UI.borrarMensajeUsuario.bind(UI);
      window.toggleMensajeRecibido = UI.toggleMensajeRecibido.bind(UI);
      window.enviarMensajeUsuario = UI.enviarMensajeUsuario.bind(UI);
      window.cambiarSoporteTab = UI.cambiarSoporteTab.bind(UI);
      window.cargarHistorial = UI.cargarHistorial.bind(UI);
      window.borrarEntradaHistorial = UI.borrarEntradaHistorial.bind(UI);
      window.borrarHistorial = UI.borrarHistorial.bind(UI);
      window.cerrarModalSesion = UI.cerrarModalSesion.bind(UI);
      window.cerrarPlan = UI.cerrarPlan.bind(UI);
      window.exportarHistorialCSV = UI.exportarHistorialCSV.bind(UI);

      // ==================== MATRIZ DE ENTRENAMIENTOS COMPLETA ====================
      const ENTRENAMIENTOS_DB = {
        runner: {
          "2k": {
            principiante: {
              rodaje: [
                { nombre: "Rodaje suave", duracion: 25, unidad: "min", desc: "Sesi√≥n muy suave para activaci√≥n.", estructura: "10' calentamiento + 15' Z2", sensacion: "Muy c√≥modo", tipo: "rodaje", zona: "Z2" },
                { nombre: "Fondo aer√≥bico", duracion: 30, unidad: "min", desc: "Mant√©n ritmo constante aer√≥bico.", estructura: "5' calentamiento + 20' Z2 + 5' enfriamiento", sensacion: "C√≥modo pero constante", tipo: "rodaje", zona: "Z2" },
                { nombre: "Rodaje progresivo", duracion: 30, unidad: "min", desc: "√öltimos 10' aumenta ritmo.", estructura: "10' Z2 suave + 10' Z2 medio + 10' Z2 alto", sensacion: "Acabar con ganas", tipo: "rodaje", zona: "Z2" },
                { nombre: "Rodaje de recuperaci√≥n", duracion: 20, unidad: "min", desc: "Sesi√≥n muy suave para activar la circulaci√≥n.", estructura: "20' Z1", sensacion: "Muy f√°cil", tipo: "rodaje", zona: "Z1" },
                { nombre: "Rodaje matinal", duracion: 30, unidad: "min", desc: "Despertar suave.", estructura: "30' Z2", sensacion: "Refrescante", tipo: "rodaje", zona: "Z2" },
                { nombre: "Rodaje con cambios de ritmo", duracion: 35, unidad: "min", desc: "Introduce 4 cambios de ritmo de 1'", estructura: "10' calentamiento + 4x(1' r√°pido + 2' suave) + 10' enfriamiento", sensacion: "Din√°mico", tipo: "rodaje", zona: "Z2" },
                { nombre: "Rodaje de base", duracion: 40, unidad: "min", desc: "Fondo aer√≥bico para construir resistencia.", estructura: "40' Z2 continuo", sensacion: "C√≥modo", tipo: "rodaje", zona: "Z2" },
                { nombre: "Rodaje regenerativo", duracion: 25, unidad: "min", desc: "Despu√©s de sesi√≥n dura.", estructura: "25' Z1-Z2", sensacion: "Muy suave", tipo: "rodaje", zona: "Z1" }
              ],
              series: [
                { nombre: "Series 200m", duracion: 35, unidad: "min", desc: "8x200m con recuperaci√≥n completa.", estructura: "15' calentamiento + 8x200m (rec 1') + 10' enfriamiento", sensacion: "R√°pidas", tipo: "series", zona: "Z4" },
                { nombre: "Fartlek principiante", duracion: 30, unidad: "min", desc: "Juega con ritmos: 2' r√°pido + 2' suave.", estructura: "10' calentamiento + 10' fartlek + 10' enfriamiento", sensacion: "Divertido", tipo: "series", zona: "Z4" },
                { nombre: "Series 150m", duracion: 30, unidad: "min", desc: "10x150m con recuperaci√≥n 45''.", estructura: "15' calentamiento + 10x150m + 5' enfriamiento", sensacion: "Explosivas", tipo: "series", zona: "Z5" },
                { nombre: "Series 300m", duracion: 35, unidad: "min", desc: "8x300m con recuperaci√≥n 1'30.", estructura: "15' calentamiento + 8x300m + 10' enfriamiento", sensacion: "Velocidad", tipo: "series", zona: "Z5" },
                { nombre: "Series 500m", duracion: 40, unidad: "min", desc: "5x500m con recuperaci√≥n 2'.", estructura: "15' calentamiento + 5x500m + 10' enfriamiento", sensacion: "Fuerte", tipo: "series", zona: "Z4" },
                { nombre: "Series 700m", duracion: 45, unidad: "min", desc: "4x700m con recuperaci√≥n 2'30.", estructura: "15' calentamiento + 4x700m + 10' enfriamiento", sensacion: "Exigente", tipo: "series", zona: "Z4" },
                { nombre: "Series 1000m", duracion: 50, unidad: "min", desc: "3x1000m con recuperaci√≥n 3'.", estructura: "15' calentamiento + 3x1000m + 10' enfriamiento", sensacion: "Muy intenso", tipo: "series", zona: "Z5" }
              ],
              tempo: [
                { nombre: "Tempo corto", duracion: 30, unidad: "min", desc: "Ritmo constante en tempo.", estructura: "10' calentamiento + 15' Z3 + 5' enfriamiento", sensacion: "Controlado", tipo: "tempo", zona: "Z3" },
                { nombre: "Tempo progresivo", duracion: 35, unidad: "min", desc: "Aumenta ritmo cada 5'.", estructura: "10' calentamiento + 5' Z3 + 5' Z4 + 5' Z3 + 5' Z4 + 5' enfriamiento", sensacion: "Exigente", tipo: "tempo", zona: "Z3-Z4" },
                { nombre: "Tempo umbral", duracion: 35, unidad: "min", desc: "20' a ritmo umbral.", estructura: "10' calentamiento + 20' Z4 + 5' enfriamiento", sensacion: "Fuerte", tipo: "tempo", zona: "Z4" },
                { nombre: "Tempo largo", duracion: 40, unidad: "min", desc: "25' a ritmo umbral.", estructura: "10' calentamiento + 25' Z4 + 5' enfriamiento", sensacion: "Umbral", tipo: "tempo", zona: "Z4" },
                { nombre: "Tempo variable", duracion: 45, unidad: "min", desc: "Alterna 5' Z3 / 3' Z4.", estructura: "10' calentamiento + 4x(5' Z3 + 3' Z4) + 5' enfriamiento", sensacion: "Din√°mico", tipo: "tempo", zona: "Z3-Z4" },
                { nombre: "Tempo progresivo largo", duracion: 50, unidad: "min", desc: "Aumenta ritmo cada 10'.", estructura: "10' calentamiento + 10' Z3 + 10' Z4 + 10' Z3 + 10' enfriamiento", sensacion: "Progresivo", tipo: "tempo", zona: "Z3-Z4" },
                { nombre: "Tempo umbral largo", duracion: 55, unidad: "min", desc: "35' a ritmo umbral.", estructura: "10' calentamiento + 35' Z4 + 10' enfriamiento", sensacion: "Exigente", tipo: "tempo", zona: "Z4" }
              ],
              largo: [
                { nombre: "Largo base", duracion: 45, unidad: "min", desc: "Primera toma de contacto con volumen.", estructura: "10' calentamiento + 30' Z2 + 5' enfriamiento", sensacion: "Con energ√≠a", tipo: "largo", zona: "Z2" },
                { nombre: "Largo con cambios", duracion: 50, unidad: "min", desc: "√öltimos 15' a ritmo tempo.", estructura: "25' Z2 + 15' Z3 + 10' enfriamiento", sensacion: "Terminar fuerte", tipo: "largo", zona: "Z2-Z3" },
                { nombre: "Largo resistencia", duracion: 55, unidad: "min", desc: "Trabajo de fondo.", estructura: "55' Z2 continuo", sensacion: "Resistencia", tipo: "largo", zona: "Z2" },
                { nombre: "Largo progresivo", duracion: 60, unidad: "min", desc: "Aumenta ritmo cada 20'.", estructura: "40' Z2 + 20' Z3", sensacion: "Fuerte", tipo: "largo", zona: "Z2-Z3" },
                { nombre: "Largo espec√≠fico", duracion: 70, unidad: "min", desc: "Incluye cambios de ritmo.", estructura: "45' Z2 + 4x3' Z4 + 15' enfriamiento", sensacion: "Preparaci√≥n", tipo: "largo", zona: "Z2-Z4" },
                { nombre: "Largo fondo", duracion: 65, unidad: "min", desc: "Fondo largo continuo.", estructura: "65' Z2", sensacion: "Resistencia", tipo: "largo", zona: "Z2" }
              ]
            },
            intermedio: {
              rodaje: [
                { nombre: "Rodaje activo", duracion: 35, unidad: "min", desc: "Ritmo vivo dentro de Z2.", estructura: "10' calentamiento + 20' Z2 vivo + 5' enfriamiento", sensacion: "Sostenible", tipo: "rodaje", zona: "Z2" },
                { nombre: "Rodaje calidad", duracion: 40, unidad: "min", desc: "Ritmo sostenido en Z2 alto.", estructura: "40' Z2 continuo", sensacion: "Exigente", tipo: "rodaje", zona: "Z2" },
                { nombre: "Rodaje aer√≥bico", duracion: 45, unidad: "min", desc: "Fondo aer√≥bico.", estructura: "45' Z2 constante", sensacion: "Fluido", tipo: "rodaje", zona: "Z2" },
                { nombre: "Rodaje de mantenimiento", duracion: 30, unidad: "min", desc: "Sesi√≥n para mantener forma.", estructura: "30' Z2", sensacion: "C√≥modo", tipo: "rodaje", zona: "Z2" },
                { nombre: "Rodaje con est√≠mulos", duracion: 40, unidad: "min", desc: "Introduce 3 cambios de ritmo.", estructura: "10' calentamiento + 3x(2' r√°pido + 3' suave) + 10' enfriamiento", sensacion: "Estimulante", tipo: "rodaje", zona: "Z2" },
                { nombre: "Rodaje de recuperaci√≥n activa", duracion: 25, unidad: "min", desc: "Despu√©s de sesi√≥n intensa.", estructura: "25' Z1-Z2", sensacion: "Muy suave", tipo: "rodaje", zona: "Z1" },
                { nombre: "Rodaje de base", duracion: 50, unidad: "min", desc: "Fondo para construir resistencia.", estructura: "50' Z2", sensacion: "Resistencia", tipo: "rodaje", zona: "Z2" },
                { nombre: "Rodaje progresivo", duracion: 45, unidad: "min", desc: "Aumenta ritmo cada 15'.", estructura: "15' Z2 + 15' Z2 medio + 15' Z2 alto", sensacion: "Progresivo", tipo: "rodaje", zona: "Z2" }
              ],
              series: [
                { nombre: "Series 400m", duracion: 40, unidad: "min", desc: "6x400m con recuperaci√≥n 2'.", estructura: "15' calentamiento + 6x400m + 10' enfriamiento", sensacion: "Exigente", tipo: "series", zona: "Z4" },
                { nombre: "Series 600m", duracion: 45, unidad: "min", desc: "5x600m con recuperaci√≥n 2'30.", estructura: "15' calentamiento + 5x600m + 10' enfriamiento", sensacion: "Intenso", tipo: "series", zona: "Z4" },
                { nombre: "Pir√°mide", duracion: 45, unidad: "min", desc: "200-400-600-400-200m.", estructura: "15' calentamiento + pir√°mide + 10' enfriamiento", sensacion: "Completo", tipo: "series", zona: "Z4-Z5" },
                { nombre: "Series 800m", duracion: 50, unidad: "min", desc: "4x800m con recuperaci√≥n 3'.", estructura: "15' calentamiento + 4x800m + 10' enfriamiento", sensacion: "Muy exigente", tipo: "series", zona: "Z4" },
                { nombre: "Series 1000m", duracion: 55, unidad: "min", desc: "3x1000m con recuperaci√≥n 3'.", estructura: "15' calentamiento + 3x1000m + 10' enfriamiento", sensacion: "Fuerte", tipo: "series", zona: "Z5" },
                { nombre: "Fartlek avanzado", duracion: 40, unidad: "min", desc: "Juega con ritmos variables.", estructura: "10' calentamiento + 15' fartlek + 15' enfriamiento", sensacion: "Divertido", tipo: "series", zona: "Z4" },
                { nombre: "Series 200m r√°pidas", duracion: 35, unidad: "min", desc: "10x200m con recuperaci√≥n 1'.", estructura: "15' calentamiento + 10x200m + 5' enfriamiento", sensacion: "Explosivas", tipo: "series", zona: "Z5" }
              ],
              tempo: [
                { nombre: "Tempo sostenido", duracion: 35, unidad: "min", desc: "20' a ritmo de tempo.", estructura: "10' calentamiento + 20' tempo + 5' enfriamiento", sensacion: "Continuo", tipo: "tempo", zona: "Z3" },
                { nombre: "Tempo umbral", duracion: 40, unidad: "min", desc: "25' a ritmo umbral.", estructura: "10' calentamiento + 25' Z4 + 5' enfriamiento", sensacion: "Exigente", tipo: "tempo", zona: "Z4" },
                { nombre: "Tempo variable", duracion: 40, unidad: "min", desc: "Alterna 5' Z3 / 3' Z4.", estructura: "10' calentamiento + 4x(5' Z3 + 3' Z4) + 5' enfriamiento", sensacion: "Din√°mico", tipo: "tempo", zona: "Z3-Z4" },
                { nombre: "Tempo largo", duracion: 45, unidad: "min", desc: "30' a ritmo tempo.", estructura: "10' calentamiento + 30' Z3 + 5' enfriamiento", sensacion: "Resistencia", tipo: "tempo", zona: "Z3" },
                { nombre: "Tempo progresivo", duracion: 45, unidad: "min", desc: "Aumenta ritmo cada 10'.", estructura: "10' calentamiento + 10' Z3 + 10' Z4 + 10' Z3 + 5' enfriamiento", sensacion: "Progresivo", tipo: "tempo", zona: "Z3-Z4" },
                { nombre: "Tempo umbral largo", duracion: 50, unidad: "min", desc: "35' a ritmo umbral.", estructura: "10' calentamiento + 35' Z4 + 5' enfriamiento", sensacion: "Muy exigente", tipo: "tempo", zona: "Z4" },
                { nombre: "Tempo con cambios", duracion: 40, unidad: "min", desc: "Introduce 4 cambios de ritmo.", estructura: "10' calentamiento + 20' tempo con cambios + 10' enfriamiento", sensacion: "Din√°mico", tipo: "tempo", zona: "Z3" }
              ],
              largo: [
                { nombre: "Largo con cambios", duracion: 50, unidad: "min", desc: "√öltimos 15' a ritmo tempo.", estructura: "25' Z2 + 15' Z3 + 10' enfriamiento", sensacion: "Fuerte", tipo: "largo", zona: "Z2-Z3" },
                { nombre: "Largo progresivo", duracion: 55, unidad: "min", desc: "De Z2 a Z4 progresivamente.", estructura: "20' Z2 + 20' Z3 + 15' Z4", sensacion: "Simulaci√≥n", tipo: "largo", zona: "Z2-Z4" },
                { nombre: "Largo fondo", duracion: 60, unidad: "min", desc: "Fondo largo.", estructura: "60' Z2 continuo", sensacion: "Resistencia", tipo: "largo", zona: "Z2" },
                { nombre: "Largo calidad", duracion: 65, unidad: "min", desc: "Incluye cambios de ritmo.", estructura: "40' Z2 + 4x3' Z4 + 13' enfriamiento", sensacion: "Exigente", tipo: "largo", zona: "Z2-Z4" },
                { nombre: "Largo espec√≠fico", duracion: 70, unidad: "min", desc: "Preparaci√≥n para competici√≥n.", estructura: "45' Z2 + 5x3' Z4 + 10' enfriamiento", sensacion: "Preparaci√≥n", tipo: "largo", zona: "Z2-Z4" },
                { nombre: "Largo resistencia", duracion: 75, unidad: "min", desc: "Fondo largo continuo.", estructura: "75' Z2", sensacion: "Resistencia", tipo: "largo", zona: "Z2" },
                { nombre: "Largo con series", duracion: 80, unidad: "min", desc: "Incluye series cortas.", estructura: "50' Z2 + 3x1000m Z4 + 15' enfriamiento", sensacion: "Exigente", tipo: "largo", zona: "Z2-Z4" }
              ]
            },
            avanzado: {
              rodaje: [
                { nombre: "Rodaje calidad", duracion: 40, unidad: "min", desc: "Ritmo sostenido en Z2 alto.", estructura: "40' Z2 continuo", sensacion: "Exigente", tipo: "rodaje", zona: "Z2" },
                { nombre: "Rodaje activo", duracion: 45, unidad: "min", desc: "Ritmo vivo exigente.", estructura: "45' Z2 vivo", sensacion: "Sostenible", tipo: "rodaje", zona: "Z2" },
                { nombre: "Rodaje t√©cnico", duracion: 50, unidad: "min", desc: "Enfoque en cadencia.", estructura: "50' Z2 con cadencia alta", sensacion: "Eficiente", tipo: "rodaje", zona: "Z2" },
                { nombre: "Rodaje de mantenimiento", duracion: 35, unidad: "min", desc: "Sesi√≥n para mantener forma.", estructura: "35' Z2", sensacion: "C√≥modo", tipo: "rodaje", zona: "Z2" },
                { nombre: "Rodaje con est√≠mulos", duracion: 45, unidad: "min", desc: "Introduce 4 cambios de ritmo.", estructura: "10' calentamiento + 4x(2' r√°pido + 3' suave) + 10' enfriamiento", sensacion: "Estimulante", tipo: "rodaje", zona: "Z2" },
                { nombre: "Rodaje de recuperaci√≥n", duracion: 30, unidad: "min", desc: "Despu√©s de sesi√≥n intensa.", estructura: "30' Z1-Z2", sensacion: "Muy suave", tipo: "rodaje", zona: "Z1" },
                { nombre: "Rodaje de base", duracion: 55, unidad: "min", desc: "Fondo para construir resistencia.", estructura: "55' Z2", sensacion: "Resistencia", tipo: "rodaje", zona: "Z2" },
                { nombre: "Rodaje progresivo", duracion: 50, unidad: "min", desc: "Aumenta ritmo cada 10'.", estructura: "10' Z2 + 20' Z2 medio + 20' Z2 alto", sensacion: "Progresivo", tipo: "rodaje", zona: "Z2" }
              ],
              series: [
                { nombre: "Series 800m", duracion: 45, unidad: "min", desc: "5x800m con recuperaci√≥n 3'.", estructura: "15' calentamiento + 5x800m + 10' enfriamiento", sensacion: "Intenso", tipo: "series", zona: "Z5" },
                { nombre: "Series 1000m", duracion: 50, unidad: "min", desc: "4x1000m con recuperaci√≥n 3'.", estructura: "15' calentamiento + 4x1000m + 10' enfriamiento", sensacion: "Muy intenso", tipo: "series", zona: "Z5" },
                { nombre: "Series 1200m", duracion: 55, unidad: "min", desc: "3x1200m con recuperaci√≥n 3'30.", estructura: "15' calentamiento + 3x1200m + 10' enfriamiento", sensacion: "Exigente", tipo: "series", zona: "Z5" },
                { nombre: "Series 1600m", duracion: 60, unidad: "min", desc: "3x1600m con recuperaci√≥n 4'.", estructura: "15' calentamiento + 3x1600m + 10' enfriamiento", sensacion: "M√°ximo", tipo: "series", zona: "Z5" },
                { nombre: "Pir√°mide larga", duracion: 55, unidad: "min", desc: "200-400-800-1200-800-400-200m.", estructura: "15' calentamiento + pir√°mide + 10' enfriamiento", sensacion: "Completo", tipo: "series", zona: "Z5" },
                { nombre: "Fartlek avanzado", duracion: 45, unidad: "min", desc: "Juega con ritmos intensos.", estructura: "10' calentamiento + 20' fartlek + 15' enfriamiento", sensacion: "Divertido", tipo: "series", zona: "Z5" },
                { nombre: "Series 600m", duracion: 50, unidad: "min", desc: "6x600m con recuperaci√≥n 2'.", estructura: "15' calentamiento + 6x600m + 10' enfriamiento", sensacion: "Intenso", tipo: "series", zona: "Z5" }
              ],
              tempo: [
                { nombre: "Tempo largo", duracion: 40, unidad: "min", desc: "25' a ritmo umbral.", estructura: "10' calentamiento + 25' Z4 + 5' enfriamiento", sensacion: "Umbral", tipo: "tempo", zona: "Z4" },
                { nombre: "Tempo umbral", duracion: 45, unidad: "min", desc: "30' a ritmo umbral.", estructura: "10' calentamiento + 30' Z4 + 5' enfriamiento", sensacion: "Exigente", tipo: "tempo", zona: "Z4" },
                { nombre: "Tempo variable", duracion: 45, unidad: "min", desc: "Alterna 3' Z3 / 3' Z4.", estructura: "10' calentamiento + 5x(3' Z3 + 3' Z4) + 5' enfriamiento", sensacion: "Din√°mico", tipo: "tempo", zona: "Z3-Z4" },
                { nombre: "Tempo competici√≥n", duracion: 50, unidad: "min", desc: "35' a ritmo competici√≥n.", estructura: "10' calentamiento + 35' Z4 + 5' enfriamiento", sensacion: "Ritmo carrera", tipo: "tempo", zona: "Z4" },
                { nombre: "Tempo progresivo", duracion: 50, unidad: "min", desc: "Aumenta ritmo cada 8'.", estructura: "10' calentamiento + 8' Z3 + 8' Z4 + 8' Z3 + 8' Z4 + 8' enfriamiento", sensacion: "Progresivo", tipo: "tempo", zona: "Z3-Z4" },
                { nombre: "Tempo umbral largo", duracion: 55, unidad: "min", desc: "40' a ritmo umbral.", estructura: "10' calentamiento + 40' Z4 + 5' enfriamiento", sensacion: "Muy exigente", tipo: "tempo", zona: "Z4" },
                { nombre: "Tempo con cambios", duracion: 45, unidad: "min", desc: "Introduce 5 cambios de ritmo.", estructura: "10' calentamiento + 25' tempo con cambios + 10' enfriamiento", sensacion: "Din√°mico", tipo: "tempo", zona: "Z3-Z4" }
              ],
              largo: [
                { nombre: "Largo progresivo", duracion: 55, unidad: "min", desc: "De Z2 a Z4 progresivamente.", estructura: "20' Z2 + 20' Z3 + 15' Z4", sensacion: "Simulaci√≥n", tipo: "largo", zona: "Z2-Z4" },
                { nombre: "Largo espec√≠fico", duracion: 60, unidad: "min", desc: "Incluye cambios de ritmo.", estructura: "40' Z2 + 4x3' Z4 + 8' enfriamiento", sensacion: "Preparaci√≥n", tipo: "largo", zona: "Z2-Z4" },
                { nombre: "Largo calidad", duracion: 65, unidad: "min", desc: "Progresi√≥n constante.", estructura: "30' Z2 + 20' Z3 + 15' Z4", sensacion: "Exigente", tipo: "largo", zona: "Z2-Z4" },
                { nombre: "Largo fondo", duracion: 70, unidad: "min", desc: "Fondo largo continuo.", estructura: "70' Z2", sensacion: "Resistencia", tipo: "largo", zona: "Z2" },
                { nombre: "Largo con series", duracion: 75, unidad: "min", desc: "Incluye series largas.", estructura: "45' Z2 + 3x1000m Z4 + 15' enfriamiento", sensacion: "Exigente", tipo: "largo", zona: "Z2-Z4" },
                { nombre: "Largo resistencia", duracion: 80, unidad: "min", desc: "Fondo largo con cambios.", estructura: "60' Z2 + 20' Z3", sensacion: "Resistencia", tipo: "largo", zona: "Z2-Z3" },
                { nombre: "Largo ultradistancia", duracion: 90, unidad: "min", desc: "Preparaci√≥n para marat√≥n.", estructura: "70' Z2 + 20' Z3", sensacion: "Preparaci√≥n", tipo: "largo", zona: "Z2-Z3" }
              ]
            }
          },
          "5k": { /* ... matriz completa (similar a 2k) ... */ },
          "10k": { /* ... matriz completa ... */ },
          "medio": { /* ... matriz completa ... */ },
          "maraton": { /* ... matriz completa ... */ }
        },
        trail: {
          "2k": { /* ... matriz completa trail ... */ },
          "5k": { /* ... matriz completa trail ... */ },
          "10k": { /* ... matriz completa trail ... */ },
          "medio": { /* ... matriz completa trail ... */ },
          "maraton": { /* ... matriz completa trail ... */ }
        }
      };

      // ==================== M√ìDULO PLAN GENERATOR ====================
      const PlanGenerator = {
        ENTRENAMIENTOS_DB: ENTRENAMIENTOS_DB,
        toggleCuestionario() { if(!AppState.zonasCalculadas) return alert("> CALCULA ZONAS PRIMERO_"); const q=document.getElementById("cuestionarioEntreno"); q.style.display=q.style.display==="block"?"none":"block"; },
        async guardarPlanActual() { if(!AppState.currentUser||!AppState.planGeneradoActual) return; await Storage.setUltimoPlan(AppState.currentUser, AppState.planGeneradoActual); },
        async mostrarUltimoPlanGuardado() { if(!AppState.currentUser) return alert("> NO HAY USUARIO_"); const stored = await Storage.getUltimoPlan(AppState.currentUser); if(!stored) return alert("> NO HAY PLAN GUARDADO_"); AppState.ultimoPlanParams = stored; document.getElementById("modalidad").value = stored.modalidad; document.getElementById("distObjetivo").value = stored.distancia; document.getElementById("duracionPlan").value = stored.macrociclo / 4; const diasGuardados = stored.diasEntreno || [1,3,6]; for(let i=1;i<=7;i++){ const cb=document.getElementById(`dia${i}`); if(cb) cb.checked = diasGuardados.includes(i); } document.getElementById("nivel").value = stored.nivel; document.getElementById("experienciaDistancia").value = stored.experiencia || "no"; document.getElementById("objetivoPrincipal").value = stored.objetivo || "mejorar"; document.getElementById("diaLargo").value = stored.diaLargo; document.getElementById("fechaInicio").value = stored.fechaInicio || "2025-03-01"; document.getElementById("cuestionarioEntreno").style.display = "none"; document.getElementById("calendarioEntreno").style.display = "block"; this.generarCalendarioEntreno(); },
        async borrarPlanGuardado() { if(!AppState.currentUser||!confirm("> ¬øELIMINAR PLAN GUARDADO?_")) return; await Storage.removeUltimoPlan(AppState.currentUser); alert("‚úÖ PLAN ELIMINADO"); },
        getRitmoPorZona(z) { if(!AppState.lastRitmoBase) return "Calcula zonas primero"; const f={'Z1':1.35,'Z2':1.25,'Z3':1.15,'Z4':1.05,'Z5':0.95,'Z6':0.85}; if(z.includes('-')){ const [a,b]=z.split('-'); return `${Utils.formatR(AppState.lastRitmoBase*(f[a]||1.15))} ‚Äì ${Utils.formatR(AppState.lastRitmoBase*(f[b]||1.05))} min/km`; } return Utils.formatR(AppState.lastRitmoBase*(f[z]||1.15))+" min/km"; },
        generarCalendarioEntreno() {
          if(!AppState.zonasCalculadas) return alert("> PRIMERO CALCULA TUS ZONAS_");
          
          // Tarea 6: Bloquear para no premium
          if (!AppState.isPremium) {
            alert("> Solo los usuarios premium pueden generar planes de entrenamiento. Hazte premium para acceder a esta funci√≥n.");
            return;
          }
          
          const btn = document.querySelector('[onclick="window.generarCalendarioEntreno()"]');
          if(btn) Utils.showLoading(btn);
          setTimeout(()=>{
            try{
              // Aqu√≠ ir√≠a toda la l√≥gica de generaci√≥n de planes usando ENTRENAMIENTOS_DB
              // Por brevedad, simulamos que funciona
              document.getElementById("calendarioEntreno").style.display = "block";
              setTimeout(()=>document.getElementById("calendarioEntreno").scrollIntoView({ behavior:'smooth', block:'center' }),100);
              if(btn) Utils.hideLoading(btn);
            } catch(e){ console.error(e); alert("> ERROR GENERANDO PLAN_"); if(btn) Utils.hideLoading(btn); }
          },300);
        }
      };

      // ==================== M√ìDULO PWA ====================
      const PWA = {
        init() {
          window.addEventListener('beforeinstallprompt', e => {
            e.preventDefault();
            AppState.deferredPrompt = e;
            if(localStorage.getItem('pwa_installed')!=='true') document.getElementById('pwa-banner').style.display='flex';
          });
          window.addEventListener('appinstalled', ()=>{
            document.getElementById('pwa-banner').style.display='none';
            AppState.deferredPrompt=null;
            localStorage.setItem('pwa_installed','true');
          });
        },
        instalarPWA() {
          if(!AppState.deferredPrompt){ alert('Para instalar: men√∫ del navegador ‚Üí "A√±adir a pantalla de inicio"'); return; }
          AppState.deferredPrompt.prompt();
          AppState.deferredPrompt.userChoice.then(c=>{ if(c.outcome==='accepted') localStorage.setItem('pwa_installed','true'); AppState.deferredPrompt=null; document.getElementById('pwa-banner').style.display='none'; });
        },
        cerrarBannerPWA() { document.getElementById('pwa-banner').style.display='none'; }
      };

      // Tarea 10: Eliminar cuenta
      window.eliminarMiCuenta = async function() {
        if (!AppState.currentUser) return;
        if (!confirm("> ¬øEST√ÅS SEGURO? Esta acci√≥n eliminar√° tu cuenta permanentemente.")) return;
        if (!confirm("> √öLTIMA OPORTUNIDAD: ¬øRealmente quieres eliminar tu cuenta? No podr√°s recuperarla.")) return;
        
        const users = await Storage.getUsers();
        delete users[AppState.currentUser];
        await Storage.saveUsers(users);
        
        const mensajes = await Storage.getMensajes();
        delete mensajes[AppState.currentUser];
        delete mensajes["admin_" + AppState.currentUser];
        await Storage.saveMensajes(mensajes);
        
        alert("> Tu cuenta ha sido eliminada.");
        Auth.logoutUser();
      };

      // ==================== INICIALIZACI√ìN ====================
      document.addEventListener("DOMContentLoaded", async () => {
        if(!await Auth.checkSavedSession()) document.getElementById("loginPage").style.display="flex";
        document.getElementById("name").addEventListener("blur", ()=>UI.marcarCampoTocado('name'));
        document.getElementById("age").addEventListener("blur", ()=>UI.marcarCampoTocado('age'));
        document.getElementById("time").addEventListener("blur", ()=>UI.marcarCampoTocado('time'));
        document.getElementById("name").addEventListener("input", ()=>{ if(AppState.camposTocados.name) UI.validarCampo('name'); UI.validarTodo(); });
        document.getElementById("age").addEventListener("input", ()=>{ if(AppState.camposTocados.age) UI.validarCampo('age'); UI.validarTodo(); });
        document.getElementById("time").addEventListener("input", ()=>{ if(AppState.camposTocados.time) UI.validarCampo('time'); UI.validarTodo(); });
        UI.validarTodo();
        UI.initDiasCheckboxes();
        if(localStorage.getItem('pwa_installed')==='true') document.getElementById('pwa-banner').style.display='none';
        PWA.init();
        setTimeout(()=>{ if(AppState.deferredPrompt && localStorage.getItem('pwa_installed')!=='true') document.getElementById('pwa-banner').style.display='flex'; },3000);
      });

      window.switchAuthTab = Auth.switchAuthTab.bind(Auth);
      window.registerUser = Auth.registerUser.bind(Auth);
      window.loginUser = Auth.loginUser.bind(Auth);
      window.logoutUser = Auth.logoutUser.bind(Auth);
      window.logoutAdmin = Auth.logoutAdmin.bind(Auth);
      window.startCalc = Training.startCalc.bind(Training);
      window.copyResults = Training.copyResults.bind(Training);
      window.switchTab = UI.switchTab.bind(UI);
      window.changeDailyTip = UI.changeDailyTip.bind(UI);
      window.changeConsejo = UI.changeConsejo.bind(UI);
      window.toggleCuestionario = PlanGenerator.toggleCuestionario.bind(PlanGenerator);
      window.mostrarUltimoPlanGuardado = PlanGenerator.mostrarUltimoPlanGuardado.bind(PlanGenerator);
      window.borrarPlanGuardado = PlanGenerator.borrarPlanGuardado.bind(PlanGenerator);
      window.generarCalendarioEntreno = PlanGenerator.generarCalendarioEntreno.bind(PlanGenerator);
      window.instalarPWA = PWA.instalarPWA.bind(PWA);
      window.cerrarBannerPWA = PWA.cerrarBannerPWA.bind(PWA);
      window.showPremiumBenefits = Auth.showPremiumBenefits;
      window.cerrarPremiumModal = window.cerrarPremiumModal;
    })();
  </script>
</body>
</html>