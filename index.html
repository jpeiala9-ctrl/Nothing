<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  <title>RI5 ¬∑ NOTHING OS ¬∑ VERSI√ìN COMPLETA</title>
  
  <!-- MANIFEST -->
  <link rel="manifest" href="data:application/manifest+json,%7B%22name%22%3A%22RI5%22%2C%22short_name%22%3A%22RI5%22%2C%22description%22%3A%22Entrenamiento%20runner%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%23000000%22%2C%22theme_color%22%3A%22%23ffffff%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20100%20100%22%3E%3Crect%20width%3D%22100%25%22%20height%3D%22100%25%22%20fill%3D%22%23000000%22%2F%3E%3Ctext%20x%3D%2250%22%20y%3D%2268%22%20font-size%3D%2260%22%20text-anchor%3D%22middle%22%20fill%3D%22%23ffffff%22%20font-family%3D%22Inter%2C%20sans-serif%22%3ERI5%3C%2Ftext%3E%3C%2Fsvg%3E%22%2C%22sizes%22%3A%22192x192%22%2C%22type%22%3A%22image%2Fsvg%2Bxml%22%7D%5D%7D">
  
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="RI5">
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20100%20100%22%3E%3Crect%20width%3D%22100%25%22%20height%3D%22100%25%22%20fill%3D%22%23000000%22%2F%3E%3Ctext%20x%3D%2250%22%20y%3D%2268%22%20font-size%3D%2260%22%20text-anchor%3D%22middle%22%20fill%3D%22%23ffffff%22%20font-family%3D%22Inter%2C%20sans-serif%22%3ERI5%3C%2Ftext%3E%3C%2Fsvg%3E">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    /* ==================== RESET Y VARIABLES NOTHING OS ==================== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #000000;
      --bg-secondary: #111111;
      --bg-card: #1a1a1a;
      --text-primary: #ffffff;
      --text-secondary: #aaaaaa;
      --accent-red: #ff3b30;
      --accent-green: #30d158;
      --accent-blue: #0a84ff;
      --accent-yellow: #ffd60a;
      --accent-purple: #bf5af2;
      --border-color: #2c2c2c;
      --glow-color: rgba(255, 255, 255, 0.05);
      --font-main: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      --font-mono: 'SF Mono', 'Menlo', 'Monaco', 'Courier New', monospace;
      --dot-color: rgba(255, 255, 255, 0.03);
      --gold: #ffd700;
      --new-user-bg: rgba(10, 132, 255, 0.15);
      --new-user-border: #0a84ff;
    }

    body {
      background: var(--bg-primary);
      color: var(--text-primary);
      font-family: var(--font-main);
      line-height: 1.5;
      letter-spacing: 0.2px;
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: "";
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: repeating-radial-gradient(circle at 20px 20px, var(--dot-color) 1px, transparent 1px, transparent 30px);
      background-size: 60px 60px;
      pointer-events: none;
      z-index: 9999;
      opacity: 0.3;
    }

    h1, h2, h3, h4 {
      font-weight: 400;
      letter-spacing: -0.02em;
      text-transform: uppercase;
      position: relative;
      display: inline-block;
      width: 100%;
      text-align: center;
    }
    h1 {
      font-size: 28px;
      font-weight: 500;
    }
    h1::after {
      content: "";
      position: absolute;
      bottom: -4px;
      left: 50%;
      transform: translateX(-50%);
      width: 40px;
      height: 2px;
      background: var(--accent-blue);
    }

    .wrapper {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 20px;
    }

    #loginPage.wrapper {
      align-items: center;
    }

    .card {
      width: 100%;
      max-width: 540px;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 24px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
      position: relative;
      overflow: hidden;
      margin: 0 auto;
      backdrop-filter: blur(10px);
    }

    .card.admin-card {
      max-width: 800px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
    }
    .card.admin-card .tabs-container {
      flex: 1;
      overflow-y: auto;
      padding-right: 5px;
    }

    /* ==================== HEADER ==================== */
    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 28px;
    }
    .logout-btn {
      padding: 6px 16px;
      background: transparent;
      border: 1px solid var(--accent-red);
      border-radius: 40px;
      color: var(--accent-red);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    .logout-btn:hover {
      background: var(--accent-red);
      color: #000;
    }

    /* ==================== TABS SIN SLIDER ==================== */
    .tabs-container { margin: 20px 0; }
    .tabs-header {
      display: flex;
      gap: 4px;
      margin-bottom: 24px;
      background: var(--bg-secondary);
      padding: 4px;
      border-radius: 40px;
      border: 1px solid var(--border-color);
      align-items: center;
    }
    .tab-button {
      flex: 1;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 4px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 500;
      letter-spacing: 0.3px;
      cursor: pointer;
      border-radius: 30px;
      transition: all 0.2s;
    }
    .tab-button.active {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Pesta√±a SOPORTE con mensajes no le√≠dos */
    .tab-button.soporte-unread {
      color: var(--accent-red) !important;
      animation: pulseText 1.5s infinite;
    }
    @keyframes pulseText {
      0% { opacity: 1; }
      50% { opacity: 0.6; }
      100% { opacity: 1; }
    }

    /* ==================== INPUTS Y BOTONES ==================== */
    input, button, select, textarea {
      width: 100%;
      padding: 14px 18px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 40px;
      color: var(--text-primary);
      font-family: var(--font-main);
      font-size: 15px;
      margin-bottom: 16px;
      transition: all 0.2s;
      outline: none;
    }
    textarea {
      border-radius: 24px;
      resize: vertical;
      min-height: 100px;
    }
    input:focus, select:focus, textarea:focus {
      border-color: var(--accent-blue);
    }
    input::placeholder, textarea::placeholder {
      color: var(--text-secondary);
      font-weight: 300;
    }
    input.error { border-color: var(--accent-red); }

    .button-main {
      background: transparent;
      border: 1px solid var(--accent-blue);
      color: var(--accent-blue);
      font-weight: 600;
      padding: 14px 28px;
      width: auto;
      min-width: 160px;
      margin: 20px auto !important;
      display: block;
      cursor: pointer;
      transition: all 0.2s;
    }
    .button-main:hover {
      background: var(--accent-blue);
      color: #000;
    }

    /* ==================== MODALES ==================== */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
      z-index: 10000;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.active {
      display: flex;
    }
    .modal-content {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 32px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 40px rgba(0,0,0,0.9);
      position: relative;
      text-align: center;
    }
    .modal-content h2 {
      margin-bottom: 20px;
      font-size: 22px;
    }
    .modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: 24px;
      cursor: pointer;
      width: auto;
      padding: 0;
    }
    .modal-close:hover {
      color: var(--accent-red);
    }

    /* ==================== ADMIN STATS (badges clickeables) ==================== */
    .admin-stats {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    .stat-badge {
      background: var(--bg-secondary);
      padding: 8px 18px;
      border-radius: 40px;
      border: 1px solid var(--border-color);
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .stat-badge:hover {
      background: var(--bg-card);
    }
    .stat-badge .number {
      color: var(--accent-blue);
      font-weight: 600;
    }

    /* ==================== LISTA DE USUARIOS (modal) ==================== */
    .user-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 20px;
    }
    .user-item {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 15px;
      text-align: center;
    }
    .user-item .user-name {
      font-weight: 600;
      color: var(--accent-blue);
      margin-bottom: 5px;
    }
    .user-item .user-details {
      font-size: 12px;
      color: var(--text-secondary);
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }
    .search-box {
      margin-bottom: 15px;
    }
    .search-box input {
      margin-bottom: 0;
    }

    /* ==================== HISTORIAL CON PASTILLAS Y GR√ÅFICA ==================== */
    .historial-controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    .historial-controls select {
      width: auto;
      padding: 8px 16px;
    }
    .historial-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 30px;
    }
    .historial-item {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 20px;
      padding: 18px;
      cursor: pointer;
      transition: background 0.2s;
      text-align: center;
    }
    .historial-item:hover {
      background: var(--bg-card);
    }
    .historial-item .fecha {
      font-size: 14px;
      color: var(--accent-blue);
      margin-bottom: 8px;
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    .historial-item .resumen {
      font-size: 13px;
      color: var(--text-secondary);
    }
    .zonas-pastillas {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 12px 0 0;
      justify-content: center;
    }
    .zona-pastilla {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 4px 12px;
      border-radius: 40px;
      font-size: 11px;
      font-weight: 500;
      background: var(--bg-primary);
      border: 1px solid;
    }
    .zona-pastilla.z1 { border-color: var(--accent-blue); color: var(--accent-blue); }
    .zona-pastilla.z2 { border-color: var(--accent-green); color: var(--accent-green); }
    .zona-pastilla.z3 { border-color: var(--accent-yellow); color: var(--accent-yellow); }
    .zona-pastilla.z4 { border-color: var(--accent-red); color: var(--accent-red); }
    .zona-pastilla.z5 { border-color: var(--accent-purple); color: var(--accent-purple); }
    .zona-pastilla.z6 { border-color: var(--accent-blue); color: var(--accent-blue); }
    .zona-pastilla span {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
    }

    /* Gr√°fica */
    .chart-container {
      margin: 30px 0;
      padding: 20px;
      background: var(--bg-secondary);
      border-radius: 24px;
    }

    /* ==================== CALENDARIO ==================== */
    #calendarioEntreno {
      margin: 30px 0;
      padding: 20px;
      background: var(--bg-secondary);
      border-radius: 24px;
    }
    .calendar-grid-container {
      width: 100%;
    }
    .calendar-header {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      margin-bottom: 8px;
    }
    .calendar-header div {
      text-align: center;
      color: var(--text-secondary);
      font-size: 12px;
      font-weight: 500;
      text-transform: uppercase;
    }
    #calendarioGrid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }
    .calendario-dia {
      aspect-ratio: 1;
      background: var(--bg-primary);
      border: 2px solid var(--border-color);
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 11px;
      transition: all 0.2s;
    }
    .calendario-dia:hover {
      border-color: var(--accent-blue);
      transform: scale(1.05);
    }
    .sesion-descanso { border-color: var(--border-color); background: var(--bg-secondary); }
    .sesion-rodaje { border-color: var(--accent-blue); background: #0a1a2a; }
    .sesion-series { border-color: var(--accent-green); background: #0a2a0a; }
    .sesion-tempo { border-color: var(--accent-yellow); background: #2a2a0a; }
    .sesion-largo { border-color: var(--accent-red); background: #2a0a0a; }

    /* Modal de sesi√≥n centrado */
    #detalleSesion.modal-overlay .modal-content {
      max-width: 400px;
      text-align: center;
    }

    /* ==================== BOTONES DE ACCI√ìN ==================== */
    .action-button {
      padding: 14px;
      background: transparent;
      border: 1px solid var(--border-color);
      border-radius: 40px;
      color: var(--text-primary);
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    .action-button:hover {
      border-color: var(--accent-blue);
    }

    /* ==================== AJUSTES VARIOS ==================== */
    .error-message {
      color: var(--accent-red);
      font-size: 12px;
      margin-top: -10px;
      margin-bottom: 10px;
      opacity: 0;
      transition: opacity 0.2s;
      text-align: center;
    }
    .error-message.visible { opacity: 1; }

    .nota-plan {
      color: var(--text-secondary);
      margin: 20px 0;
      padding: 16px;
      border: 1px dashed var(--border-color);
      border-radius: 16px;
      font-size: 14px;
      text-align: center;
    }

    /* ==================== MEDIA QUERIES PARA M√ìVIL ==================== */
    @media (max-width: 600px) {
      .wrapper {
        padding: 0;
      }
      .card {
        border-radius: 0;
        border-left: none;
        border-right: none;
        max-width: 100%;
        margin: 0;
      }
      .app-header {
        flex-direction: column;
        gap: 10px;
      }
      .tabs-header {
        flex-wrap: wrap;
        height: auto;
        padding: 8px;
      }
      .tab-button {
        flex: 1 0 auto;
        min-width: 70px;
      }
    }

    /* ==================== DIAS SEMANA CHECKBOXES ==================== */
    #diasSemanaContainer {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin: 15px 0;
    }
    .dia-checkbox {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
    }
    .dia-checkbox input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin: 0;
    }

    html {
      scroll-behavior: smooth;
    }
  </style>
</head>
<body>
  <!-- MODALES GLOBALES -->
  <div class="modal-overlay" id="modalUsuarios">
    <div class="modal-content">
      <button class="modal-close" onclick="document.getElementById('modalUsuarios').classList.remove('active')">‚úï</button>
      <h2>üë• Usuarios registrados</h2>
      <div class="search-box">
        <input type="text" id="searchUsuariosModal" placeholder="Buscar usuario..." onkeyup="filtrarUsuariosModal()">
      </div>
      <div class="user-list" id="modalUserList"></div>
    </div>
  </div>

  <div class="modal-overlay" id="modalActivos">
    <div class="modal-content">
      <button class="modal-close" onclick="document.getElementById('modalActivos').classList.remove('active')">‚úï</button>
      <h2>‚úÖ Usuarios activos</h2>
      <div class="search-box">
        <input type="text" id="searchActivosModal" placeholder="Buscar activo..." onkeyup="filtrarActivosModal()">
      </div>
      <div class="user-list" id="modalActivosList"></div>
    </div>
  </div>

  <!-- BANNER PWA -->
  <div id="pwa-banner" style="display:none; position:fixed; bottom:20px; left:20px; right:20px; max-width:400px; margin:0 auto; background:var(--bg-card); border:1px solid var(--border-color); border-radius:40px; padding:12px 20px; display:flex; align-items:center; justify-content:space-between; z-index:20000;">
    <span>üì≤ Instalar RI5</span>
    <button onclick="instalarPWA()" style="width:auto; padding:6px 16px; margin:0;">Instalar</button>
    <button class="close-banner" onclick="cerrarBannerPWA()" style="width:auto; padding:6px; background:transparent; border:none;">‚úï</button>
  </div>

  <!-- LOGIN PAGE -->
  <div class="wrapper" id="loginPage">
    <div class="card">
      <h1>RI5</h1>
      <div class="auth-tabs tabs-header" style="margin:30px 0;">
        <button class="auth-tab tab-button active" onclick="switchAuthTab('login')">LOGIN</button>
        <button class="auth-tab tab-button" onclick="switchAuthTab('register')">REGISTRO</button>
      </div>
      <div id="loginForm" class="auth-form active">
        <input type="text" id="loginUsername" placeholder="usuario">
        <input type="password" id="loginPassword" placeholder="contrase√±a">
        <div class="error-message" id="loginError"></div>
        <button class="button-main" onclick="loginUser()">ACCEDER</button>
      </div>
      <div id="registerForm" class="auth-form">
        <input type="text" id="regUsername" placeholder="nuevo usuario">
        <input type="password" id="regPassword" placeholder="nueva contrase√±a">
        <div class="error-message" id="registerError"></div>
        <button class="button-main" onclick="registerUser()">REGISTRARSE</button>
      </div>
    </div>
  </div>

  <!-- ADMIN PAGE -->
  <div class="wrapper" id="adminPage" style="display:none;">
    <div class="card admin-card">
      <div class="app-header">
        <h1>RI5¬∑ADMIN</h1>
        <button class="logout-btn" onclick="logoutAdmin()">CERRAR SESI√ìN</button>
      </div>
      <p style="color:var(--accent-green); text-align:center;" id="adminWelcome"></p>
      <div class="tabs-container">
        <div class="tabs-header">
          <button class="tab-button active" onclick="switchAdminTab('usuarios')">USUARIOS</button>
          <button class="tab-button" onclick="switchAdminTab('soporte')">SOPORTE</button>
        </div>
        <div id="admin-tab-usuarios" class="tab-content active">
          <!-- Estad√≠sticas en badges clickeables -->
          <div class="admin-stats" id="adminStats"></div>
          <button class="admin-btn" onclick="exportarUsuariosCSV()" style="width:100%; margin:10px 0;">üì• EXPORTAR CSV</button>
          <button class="admin-btn" onclick="renovarExpirados()" style="width:100%;">üîÑ RENOVAR EXPIRADOS</button>
        </div>
        <div id="admin-tab-soporte" class="tab-content">
          <h2>SOPORTE</h2>
          <div class="soporte-tabs" style="display:flex; gap:4px; margin-bottom:20px; background:var(--bg-secondary); padding:4px; border-radius:40px;">
            <button class="soporte-tab tab-button active" onclick="cambiarAdminSoporteTab('recibidos')">RECIBIDOS</button>
            <button class="soporte-tab tab-button" onclick="cambiarAdminSoporteTab('enviados')">ENVIADOS</button>
          </div>
          <div id="admin-soporte-recibidos" class="soporte-panel active">
            <div id="listaMensajesRecibidosAdmin"></div>
          </div>
          <div id="admin-soporte-enviados" class="soporte-panel">
            <div id="listaMensajesEnviadosAdmin"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MAIN APP -->
  <div class="wrapper" id="mainContent" style="display:none;">
    <div class="card">
      <div class="app-header">
        <h1 id="ri5Title" onclick="showPremiumBenefits()">RI5</h1>
        <button class="logout-btn" onclick="logoutUser()">CERRAR SESI√ìN</button>
      </div>
      <p style="color:var(--text-secondary); text-align:center;" id="userWelcome"></p>
      <div class="tabs-container">
        <div class="tabs-header">
          <button class="tab-button active" onclick="switchTab('entreno')">ENTRENO</button>
          <button class="tab-button" onclick="switchTab('plan')">PLAN</button>
          <button class="tab-button" onclick="switchTab('historial')">HISTORIAL</button>
          <button class="tab-button" onclick="switchTab('soporte')" id="soporteTabButton">SOPORTE</button>
        </div>

        <!-- TAB ENTRENO -->
        <div id="tab-entreno" class="tab-content active">
          <h2>ZONAS DE ENTRENO</h2>
          <input id="name" placeholder="nombre"><div class="error-message" id="nameError"></div>
          <input id="age" type="number" min="14" max="85" placeholder="edad"><div class="error-message" id="ageError"></div>
          <input id="time" placeholder="tiempo 6km (MM:SS)"><div class="error-message" id="timeError"></div>
          <button class="button-main" id="calcBtn" disabled onclick="startCalc()">CALCULAR</button>
          <div id="results"></div>
        </div>

        <!-- TAB PLAN -->
        <div id="tab-plan" class="tab-content">
          <h2>CREADOR DE PLANES</h2>
          <button class="action-button" onclick="toggleCuestionario()">+ NUEVO PLAN</button>
          <button class="action-button" onclick="mostrarUltimoPlanGuardado()">üìÇ CARGAR √öLTIMO PLAN</button>
          <button class="action-button" onclick="borrarPlanGuardado()">üóëÔ∏è ELIMINAR PLAN</button>
          
          <div id="cuestionarioEntreno" style="display:none;">
            <select id="modalidad">
              <option value="runner">RUNNER</option>
              <option value="trail">TRAIL</option>
            </select>
            <select id="distObjetivo">
              <option value="2k">2 km</option>
              <option value="5k">5 km</option>
              <option value="10k">10 km</option>
              <option value="medio">MEDIA MARAT√ìN</option>
              <option value="maraton" selected>MARAT√ìN</option>
            </select>
            <select id="duracionPlan">
              <option value="1">1 MES</option>
              <option value="3">3 MESES</option>
            </select>
            <div style="color:var(--accent-yellow); margin:10px 0;">D√çAS DE ENTRENO</div>
            <div class="dias-semana-container" id="diasSemanaContainer"></div>
            <select id="nivel">
              <option value="principiante">PRINCIPIANTE</option>
              <option value="intermedio" selected>INTERMEDIO</option>
              <option value="avanzado">AVANZADO</option>
            </select>
            <select id="experienciaDistancia">
              <option value="si">CON EXPERIENCIA</option>
              <option value="no" selected>PRIMERA VEZ</option>
            </select>
            <select id="objetivoPrincipal">
              <option value="acabar">TERMINAR</option>
              <option value="mejorar" selected>MEJORAR TIEMPO</option>
              <option value="competir">COMPETIR</option>
            </select>
            <select id="diaLargo">
              <option value="1">LUNES</option><option value="2">MARTES</option><option value="3">MI√âRCOLES</option>
              <option value="4">JUEVES</option><option value="5">VIERNES</option><option value="6">S√ÅBADO</option>
              <option value="7" selected>DOMINGO</option>
            </select>
            <div class="fecha-inicio-container">
              <label>FECHA DE INICIO</label>
              <input type="date" id="fechaInicio" value="2025-03-01">
            </div>
            <button class="action-button" onclick="generarCalendarioEntreno()">GENERAR PLAN</button>
            <button class="action-button" onclick="toggleCuestionario()">CANCELAR</button>
          </div>

          <div id="calendarioEntreno" style="display:none;">
            <h3>TU PLAN</h3>
            <div class="nota-plan">Plan optimizado para tu rendimiento. Conf√≠a en el proceso.</div>
            <p id="resumenObjetivo" style="color:var(--accent-blue); text-align:center;"></p>
            <div class="calendar-grid-container">
              <div class="calendar-header">
                <div>L</div><div>M</div><div>X</div><div>J</div><div>V</div><div>S</div><div>D</div>
              </div>
              <div id="calendarioGrid"></div>
            </div>
          </div>
        </div>

        <!-- TAB HISTORIAL -->
        <div id="tab-historial" class="tab-content">
          <h2>HISTORIAL</h2>
          <div class="historial-controls">
            <label>Mostrar:</label>
            <select id="historialLimit" onchange="cargarHistorial()">
              <option value="10">10</option>
              <option value="25">25</option>
            </select>
          </div>
          <!-- Gr√°fica de progreso -->
          <div class="chart-container">
            <canvas id="progresoChart"></canvas>
          </div>
          <div id="historialContainer"></div>
          <button class="action-button" onclick="borrarHistorial()">LIMPIAR HISTORIAL</button>
        </div>

        <!-- TAB SOPORTE -->
        <div id="tab-soporte" class="tab-content">
          <h2>SOPORTE</h2>
          <div class="soporte-tabs" style="display:flex; gap:4px; margin-bottom:20px; background:var(--bg-secondary); padding:4px; border-radius:40px;">
            <button class="soporte-tab tab-button active" onclick="cambiarSoporteTab('recibidos')">RECIBIDOS</button>
            <button class="soporte-tab tab-button" onclick="cambiarSoporteTab('enviados')">ENVIADOS</button>
          </div>
          <div id="soporte-recibidos" class="soporte-panel active">
            <div id="listaMensajesRecibidos"></div>
          </div>
          <div id="soporte-enviados" class="soporte-panel">
            <textarea id="mensajeUsuario" placeholder="Escribe tu consulta..."></textarea>
            <button class="send-message-btn" onclick="enviarMensajeUsuario()">ENVIAR</button>
            <div id="listaMensajesEnviados" style="margin-top:20px;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL DETALLE SESI√ìN (centrado) -->
  <div class="modal-overlay" id="detalleSesion">
    <div class="modal-content" id="modalColorWrapper">
      <h3 id="tituloSesion"></h3>
      <div id="descripcionSesion"></div>
      <button class="close-btn" onclick="cerrarModalSesion()" style="margin-top:20px; background:var(--accent-red); border:none; padding:10px 30px; border-radius:40px; color:#fff;">CERRAR</button>
    </div>
  </div>

  <!-- FIREBASE -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
    // ==================== CONFIGURACI√ìN FIREBASE ====================
    const firebaseConfig = {
      apiKey: "AIzaSyBw4VYLEeFeG4Z2qJC56iPzzuAzlIkmErc",
      authDomain: "ri5-5b642.firebaseapp.com",
      databaseURL: "https://ri5-5b642-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "ri5-5b642",
      storageBucket: "ri5-5b642.firebasestorage.app",
      messagingSenderId: "889154598385",
      appId: "1:889154598385:web:1d4e7dad605a42c1c60050"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ==================== M√ìDULO UTILS (funciones auxiliares) ====================
    const Utils = {
      parseTime: function(t) {
        t = t.trim();
        if (!t) return NaN;
        const match = t.match(/^(\d{1,3}):?(\d{0,2})$/);
        if (!match) return NaN;
        const m = parseInt(match[1]);
        const s = match[2] ? parseInt(match[2]) : 0;
        if (s > 59 || m > 120 || m < 10) return NaN;
        return m + s / 60;
      },
      formatR: function(r) {
        if (!isFinite(r) || r <= 0) return "--:--";
        let m = Math.floor(r);
        let s = Math.round((r - m) * 60);
        if (s === 60) {
          m++;
          s = 0;
        }
        return m + ":" + (s < 10 ? '0' : '') + s;
      },
      showLoading: function(btn) {
        btn.classList.add('loading');
        btn.disabled = true;
      },
      hideLoading: function(btn) {
        btn.classList.remove('loading');
        btn.disabled = false;
      },
      showTemporaryMessage: function(btn, msg, ok = true) {
        const orig = btn.innerText;
        btn.innerText = msg;
        btn.classList.add(ok ? 'btn-success' : 'btn-error');
        setTimeout(() => {
          btn.innerText = orig;
          btn.classList.remove('btn-success', 'btn-error');
        }, 2000);
      },
      hashPassword: function(str) {
        return btoa(str + "_RI5_SALT");
      }
    };

    // ==================== M√ìDULO STORAGE (FIREBASE) ====================
    const Storage = {
      getUsers: function() {
        return db.ref('users').once('value').then(snapshot => snapshot.val() || {});
      },
      saveUsers: function(u) {
        return db.ref('users').set(u);
      },
      getHistorial: function(username) {
        if (!username) return Promise.resolve([]);
        return db.ref('users/' + username + '/historial').once('value').then(snapshot => snapshot.val() || []);
      },
      saveHistorial: function(username, h) {
        if (!username) return Promise.reject('No user');
        return db.ref('users/' + username + '/historial').set(h);
      },
      getUltimoPlan: function(username) {
        if (!username) return Promise.resolve(null);
        return db.ref('users/' + username + '/ultimoPlan').once('value').then(snapshot => snapshot.val() || null);
      },
      setUltimoPlan: function(username, p) {
        if (!username) return Promise.reject('No user');
        return db.ref('users/' + username + '/ultimoPlan').set(p);
      },
      removeUltimoPlan: function(username) {
        if (!username) return Promise.reject('No user');
        return db.ref('users/' + username + '/ultimoPlan').remove();
      },
      getUltimoCalculo: function(username) {
        if (!username) return Promise.resolve(null);
        return db.ref('users/' + username + '/ultimoCalculo').once('value').then(snapshot => snapshot.val() || null);
      },
      setUltimoCalculo: function(username, calc) {
        if (!username) return Promise.reject('No user');
        return db.ref('users/' + username + '/ultimoCalculo').set(calc);
      },
      getMensajes: function() {
        return db.ref('mensajes').once('value').then(snapshot => snapshot.val() || {});
      },
      saveMensajes: function(m) {
        return db.ref('mensajes').set(m);
      },
      getMensajesUsuario: function(u) {
        return this.getMensajes().then(todos => todos[u] || []);
      },
      marcarLeido: function(u, index) {
        return this.getMensajes().then(todos => {
          if (todos[u] && todos[u][index]) {
            todos[u][index].leido = true;
            return this.saveMensajes(todos);
          }
        });
      },
      borrarMensajeUsuario: function(u, index) {
        return this.getMensajes().then(todos => {
          if (todos[u] && todos[u][index]) {
            todos[u].splice(index, 1);
            if (todos[u].length === 0) delete todos[u];
            return this.saveMensajes(todos);
          }
        });
      },
      enviarMensajeUsuario: function(usuario, texto) {
        return this.getMensajes().then(todos => {
          const adminKey = "admin_" + usuario;
          if (!todos[adminKey]) todos[adminKey] = [];
          todos[adminKey].push({
            fecha: new Date().toLocaleString(),
            texto: texto,
            leido: false,
            esUsuario: true
          });
          return this.saveMensajes(todos);
        });
      },
      enviarMensajeAdminAUsuario: function(usuario, texto) {
        return this.getMensajes().then(todos => {
          if (!todos[usuario]) todos[usuario] = [];
          todos[usuario].push({
            fecha: new Date().toLocaleString(),
            texto: texto,
            leido: false,
            esAdmin: true
          });
          return this.saveMensajes(todos);
        });
      },
      getMensajesEnviadosUsuario: function(u) {
        return this.getMensajes().then(todos => {
          const adminKey = "admin_" + u;
          return todos[adminKey] || [];
        });
      },
      getMensajesRecibidosAdmin: function() {
        return this.getMensajes().then(todos => {
          const recibidos = [];
          Object.keys(todos).forEach(key => {
            if (key.startsWith('admin_')) {
              const usuario = key.replace('admin_', '');
              todos[key].forEach((msg, idx) => {
                recibidos.push({ usuario, mensaje: msg, idx, key });
              });
            }
          });
          return recibidos;
        });
      },
      getMensajesEnviadosAdmin: function() {
        return this.getMensajes().then(todos => {
          const enviados = [];
          Object.keys(todos).forEach(key => {
            if (!key.startsWith('admin_')) {
              todos[key].forEach((msg, idx) => {
                if (msg.esAdmin) {
                  enviados.push({ usuario: key, mensaje: msg, idx, key });
                }
              });
            }
          });
          return enviados;
        });
      },
      borrarMensaje: function(key, idx) {
        return this.getMensajes().then(todos => {
          if (todos[key] && todos[key][idx]) {
            todos[key].splice(idx, 1);
            if (todos[key].length === 0) delete todos[key];
            return this.saveMensajes(todos);
          }
        });
      }
    };

    // ==================== MATRIZ DE ENTRENAMIENTOS COMPLETA (TODAS LAS COMBINACIONES) ====================
    // ... (el contenido de ENTRENAMIENTOS_DB es enorme, se mantiene igual que en el c√≥digo original)
    // Por brevedad, aqu√≠ no se repite, pero en el c√≥digo final debe estar completo.
    const ENTRENAMIENTOS_DB = { ... }; // (mantener igual)

    // ==================== ESTADO GLOBAL ====================
    const AppState = {
      zonasCalculadas: false,
      lastName: "",
      lastAge: 0,
      lastFC: 0,
      lastUL: 0,
      lastZones: [],
      lastPred: [],
      lastRitmoBase: 0,
      ultimoPlanParams: null,
      planGeneradoActual: null,
      camposTocados: { name: false, age: false, time: false },
      currentUser: null,
      currentSesionDetalle: null,
      deferredPrompt: null,
      mensajesNoLeidos: 0,
      isPremium: false,
      usuariosVistos: JSON.parse(localStorage.getItem('usuariosVistos') || '[]'),
      setLastCalc: function(d) {
        this.lastName = d.name;
        this.lastAge = d.age;
        this.lastFC = d.fcMax;
        this.lastUL = d.ul;
        this.lastZones = d.zones;
        this.lastPred = d.pred;
        this.lastRitmoBase = d.ritmoBase;
        this.zonasCalculadas = true;
      },
      clearLastCalc: function() {
        this.zonasCalculadas = false;
        this.lastName = "";
        this.lastAge = 0;
        this.lastFC = 0;
        this.lastUL = 0;
        this.lastZones = [];
        this.lastPred = [];
        this.lastRitmoBase = 0;
      },
      setCurrentUser: function(u, premium = false) {
        this.currentUser = u;
        this.isPremium = premium;
        u ? localStorage.setItem('ri5_current_user', u) : localStorage.removeItem('ri5_current_user');
        const title = document.getElementById('ri5Title');
        if (title) {
          if (premium) title.classList.add('premium');
          else title.classList.remove('premium');
        }
      }
    };

    // ==================== M√ìDULO AUTENTICACI√ìN ====================
    const Auth = {
      switchAuthTab: function(tab) {
        document.querySelectorAll('.auth-tab').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
        if (tab === 'login') {
          document.querySelector('.auth-tab').classList.add('active');
          document.getElementById('loginForm').classList.add('active');
        } else {
          document.querySelectorAll('.auth-tab')[1].classList.add('active');
          document.getElementById('registerForm').classList.add('active');
        }
      },
      registerUser: async function() {
        const username = document.getElementById('regUsername').value.trim();
        const password = document.getElementById('regPassword').value.trim();
        const err = document.getElementById('registerError');
        if (!username || !password) {
          err.innerText = "> COMPLETA TODOS LOS CAMPOS_";
          err.classList.add('visible');
          return;
        }
        if (username.length < 3) {
          err.innerText = "> M√çNIMO 3 CARACTERES_";
          err.classList.add('visible');
          return;
        }
        if (password.length < 4) {
          err.innerText = "> M√çNIMO 4 CARACTERES_";
          err.classList.add('visible');
          return;
        }
        const users = await Storage.getUsers();
        if (users[username]) {
          err.innerText = "> EL USUARIO YA EXISTE_";
          err.classList.add('visible');
          return;
        }
        const expiry = new Date();
        expiry.setMonth(expiry.getMonth() + 3);
        users[username] = {
          password: Utils.hashPassword(password),
          created: new Date().toISOString(),
          expires: expiry.toISOString(),
          premium: true
        };
        await Storage.saveUsers(users);
        await Storage.enviarMensajeAdminAUsuario(username, "¬°Bienvenido a RI5! Disfruta de 3 meses premium.");
        AppState.setCurrentUser(username, true);
        document.getElementById("loginPage").style.opacity = "0";
        setTimeout(() => {
          document.getElementById("loginPage").style.display = "none";
          document.getElementById("mainContent").style.display = "flex";
          document.getElementById("userWelcome").innerText = `> BIENVENIDO, ${username.toUpperCase()}_ ¬∑ PREMIUM HASTA ${expiry.toLocaleDateString()}`;
          document.getElementById("mainContent").style.opacity = "1";
          UI.changeDailyTip();
          UI.startConsejoAutoChange();
        }, 300);
      },
      loginUser: async function() {
        const username = document.getElementById('loginUsername').value.trim();
        const password = document.getElementById('loginPassword').value.trim();
        const err = document.getElementById('loginError');
        if (!username || !password) {
          err.innerText = "> INTRODUCE USUARIO Y CONTRASE√ëA_";
          err.classList.add('visible');
          return;
        }
        if (username === 'admin' && password === '091118110485120385') {
          Auth.mostrarAdminPanel();
          return;
        }
        const users = await Storage.getUsers();
        const user = users[username];
        if (!user || user.password !== Utils.hashPassword(password)) {
          err.innerText = "> INCORRECTO_";
          err.classList.add('visible');
          return;
        }
        const now = new Date();
        const expiry = new Date(user.expires);
        if (now > expiry) {
          if (user.premium) {
            alert("> Tu per√≠odo premium ha expirado. Algunas funciones pueden estar limitadas.");
          } else {
            err.innerText = "> ACCESO EXPIRADO_";
            err.classList.add('visible');
            return;
          }
        }
        AppState.setCurrentUser(username, user.premium || false);
        const mensajes = await Storage.getMensajesUsuario(username);
        AppState.mensajesNoLeidos = mensajes.filter(m => !m.leido).length;
        UI.actualizarBadgeMensajes();
        document.getElementById("loginPage").style.opacity = "0";
        setTimeout(() => {
          document.getElementById("loginPage").style.display = "none";
          document.getElementById("mainContent").style.display = "flex";
          document.getElementById("userWelcome").innerText = `> BIENVENIDO, ${username.toUpperCase()}_ ¬∑ ${user.premium ? 'PREMIUM' : 'ACCESO'} HASTA ${expiry.toLocaleDateString()}`;
          document.getElementById("mainContent").style.opacity = "1";
          UI.changeDailyTip();
          UI.startConsejoAutoChange();
          UI.cargarMensajesRecibidos();
          UI.cargarMensajesEnviados();
          Storage.getUltimoCalculo(username).then(calc => {
            if (calc) {
              AppState.setLastCalc(calc);
              UI.mostrarResultadosGuardados(calc);
            }
          });
        }, 300);
      },
      mostrarAdminPanel: function() {
        document.getElementById("loginPage").style.display = "none";
        document.getElementById("mainContent").style.display = "none";
        document.getElementById("adminPage").style.display = "flex";
        Admin.actualizarAdminPanel();
      },
      logoutUser: function() {
        if (!confirm("> ¬øCERRAR SESI√ìN?_")) return;
        AppState.setCurrentUser(null);
        document.getElementById("mainContent").style.display = "none";
        document.getElementById("loginPage").style.display = "flex";
        document.getElementById("loginUsername").value = '';
        document.getElementById("loginPassword").value = '';
        document.getElementById("results").innerHTML = '';
        document.getElementById("calendarioEntreno").style.display = "none";
        AppState.clearLastCalc();
      },
      logoutAdmin: function() {
        document.getElementById("adminPage").style.display = "none";
        document.getElementById("loginPage").style.display = "flex";
      },
      checkSavedSession: async function() {
        const saved = localStorage.getItem('ri5_current_user');
        if (!saved) return false;
        const users = await Storage.getUsers();
        const user = users[saved];
        if (!user) {
          localStorage.removeItem('ri5_current_user');
          return false;
        }
        if (new Date() > new Date(user.expires) && !user.premium) {
          localStorage.removeItem('ri5_current_user');
          return false;
        }
        AppState.currentUser = saved;
        AppState.isPremium = user.premium || false;
        document.getElementById("loginPage").style.display = "none";
        document.getElementById("mainContent").style.display = "flex";
        document.getElementById("userWelcome").innerText = `> BIENVENIDO, ${saved.toUpperCase()}_ ¬∑ ${user.premium ? 'PREMIUM' : 'ACCESO'} HASTA ${new Date(user.expires).toLocaleDateString()}`;
        const title = document.getElementById('ri5Title');
        if (title) {
          if (AppState.isPremium) title.classList.add('premium');
          else title.classList.remove('premium');
        }
        UI.changeDailyTip();
        UI.startConsejoAutoChange();
        const calc = await Storage.getUltimoCalculo(saved);
        if (calc) {
          AppState.setLastCalc(calc);
          UI.mostrarResultadosGuardados(calc);
        }
        return true;
      },
      isUserPremium: function() {
        return AppState.isPremium;
      },
      showPremiumBenefits: function() {
        alert("Beneficios premium: planes de 3 meses, historial ampliado, prioridad en soporte. Contacta por Instagram @navegacionpro");
      }
    };

    // ==================== M√ìDULO ADMIN ====================
    const Admin = {
      actualizarAdminPanel: async function() {
        const users = await Storage.getUsers();
        const total = Object.keys(users).length;
        const ahora = new Date();
        const activos = Object.values(users).filter(u => new Date(u.expires) > ahora).length;
        const expirados = total - activos;
        document.getElementById("adminStats").innerHTML = `
          <span class="stat-badge" onclick="Admin.abrirModalUsuarios('todos')">üìä TOTAL <span class="number">${total}</span></span>
          <span class="stat-badge" onclick="Admin.abrirModalUsuarios('activos')">‚úÖ ACTIVOS <span class="number">${activos}</span></span>
          <span class="stat-badge" onclick="Admin.abrirModalUsuarios('expirados')">‚è≥ EXPIRADOS <span class="number">${expirados}</span></span>
        `;
        document.getElementById("adminWelcome").innerText = `> ADMIN ¬∑ ${new Date().toLocaleString()}`;
        Admin.cargarMensajesAdmin();
      },
      abrirModalUsuarios: function(tipo) {
        Storage.getUsers().then(users => {
          let lista = [];
          const ahora = new Date();
          if (tipo === 'todos') lista = Object.entries(users);
          else if (tipo === 'activos') lista = Object.entries(users).filter(([u, d]) => new Date(d.expires) > ahora);
          else lista = Object.entries(users).filter(([u, d]) => new Date(d.expires) <= ahora);
          const modal = document.getElementById(tipo === 'activos' ? 'modalActivos' : 'modalUsuarios');
          const listEl = document.getElementById(tipo === 'activos' ? 'modalActivosList' : 'modalUserList');
          listEl.innerHTML = lista.map(([u, d]) => `
            <div class="user-item">
              <div class="user-name">${u}</div>
              <div class="user-details">
                <span>üìÖ ${new Date(d.created).toLocaleDateString()}</span>
                <span>‚è≥ ${new Date(d.expires).toLocaleDateString()}</span>
                <span>${d.premium ? 'üëë' : ''}</span>
              </div>
            </div>
          `).join('');
          modal.classList.add('active');
        });
      },
      filtrarUsuariosModal: function(tipo) {
        const search = document.getElementById(tipo === 'activos' ? 'searchActivosModal' : 'searchUsuariosModal').value.toLowerCase();
        const items = document.querySelectorAll(`#${tipo === 'activos' ? 'modalActivosList' : 'modalUserList'} .user-item`);
        items.forEach(item => {
          const nombre = item.querySelector('.user-name').textContent.toLowerCase();
          item.style.display = nombre.includes(search) ? 'block' : 'none';
        });
      },
      extenderUsuario: async function(u, m) {
        const users = await Storage.getUsers();
        if (users[u]) {
          const expiry = new Date(users[u].expires);
          expiry.setMonth(expiry.getMonth() + m);
          users[u].expires = expiry.toISOString();
          await Storage.saveUsers(users);
          this.actualizarAdminPanel();
          alert(`‚úÖ Usuario ${u} extendido ${m} mes(es)`);
        }
      },
      togglePremium: async function(u) {
        const users = await Storage.getUsers();
        if (users[u]) {
          users[u].premium = !users[u].premium;
          await Storage.saveUsers(users);
          this.actualizarAdminPanel();
          alert(`‚úÖ Premium de ${u} cambiado`);
        }
      },
      eliminarUsuario: async function(u) {
        if (!confirm(`> ¬øELIMINAR USUARIO "${u}"?`)) return;
        const users = await Storage.getUsers();
        delete users[u];
        await Storage.saveUsers(users);
        this.actualizarAdminPanel();
      },
      exportarUsuariosCSV: function() {
        Storage.getUsers().then(users => {
          let csv = "Usuario,Creado,Expira,Premium,Estado\n";
          Object.entries(users).forEach(([u, d]) => {
            const creado = new Date(d.created).toLocaleDateString();
            const expiry = new Date(d.expires).toLocaleDateString();
            const estado = new Date() <= new Date(d.expires) ? "ACTIVO" : "EXPIRADO";
            csv += `${u},${creado},${expiry},${d.premium ? 'SI' : 'NO'},${estado}\n`;
          });
          const blob = new Blob([csv], { type: 'text/csv' });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = `usuarios_${new Date().toISOString().split('T')[0]}.csv`;
          a.click();
          URL.revokeObjectURL(a.href);
        });
      },
      renovarExpirados: async function() {
        if (!confirm("> ¬øRENOVAR TODOS LOS USUARIOS EXPIRADOS POR 1 MES?")) return;
        const users = await Storage.getUsers();
        const ahora = new Date();
        Object.entries(users).forEach(([u, d]) => {
          if (new Date(d.expires) <= ahora) {
            const expiry = new Date(d.expires);
            expiry.setMonth(expiry.getMonth() + 1);
            users[u].expires = expiry.toISOString();
          }
        });
        await Storage.saveUsers(users);
        this.actualizarAdminPanel();
        alert("‚úÖ USUARIOS EXPIRADOS RENOVADOS");
      },
      enviarMensajeAUsuario: async function(usuario) {
        const texto = prompt(`> MENSAJE PARA ${usuario}:`);
        if (!texto) return;
        await Storage.enviarMensajeAdminAUsuario(usuario, texto);
        alert("‚úÖ MENSAJE ENVIADO");
        this.cargarMensajesAdmin();
      },
      cargarMensajesAdmin: async function() {
        const recibidos = await Storage.getMensajesRecibidosAdmin();
        let htmlRec = '';
        recibidos.forEach(item => {
          htmlRec += `
            <div class="mensaje-item">
              <div class="mensaje-header" onclick="this.parentNode.classList.toggle('abierto')">
                <span>üì® ${item.mensaje.fecha} ¬∑ ${item.usuario}</span>
                <span class="flecha">‚ñº</span>
                <button class="delete-mensaje" onclick="event.stopPropagation(); Storage.borrarMensaje('${item.key}', ${item.idx}).then(()=>Admin.cargarMensajesAdmin())">üóëÔ∏è</button>
              </div>
              <div class="mensaje-contenido">${item.mensaje.texto}</div>
            </div>
          `;
        });
        document.getElementById('listaMensajesRecibidosAdmin').innerHTML = htmlRec || '<p>üì≠ NO HAY MENSAJES</p>';

        const enviados = await Storage.getMensajesEnviadosAdmin();
        let htmlEnv = '';
        enviados.forEach(item => {
          htmlEnv += `
            <div class="mensaje-item">
              <div class="mensaje-header" onclick="this.parentNode.classList.toggle('abierto')">
                <span>üì§ ${item.mensaje.fecha} ¬∑ Para ${item.usuario}</span>
                <span class="flecha">‚ñº</span>
                <button class="delete-mensaje" onclick="event.stopPropagation(); Storage.borrarMensaje('${item.key}', ${item.idx}).then(()=>Admin.cargarMensajesAdmin())">üóëÔ∏è</button>
              </div>
              <div class="mensaje-contenido">${item.mensaje.texto}</div>
            </div>
          `;
        });
        document.getElementById('listaMensajesEnviadosAdmin').innerHTML = htmlEnv || '<p>üì≠ NO HAS ENVIADO MENSAJES</p>';
      },
      cambiarSoporteTab: function(tab) {
        document.querySelectorAll('#admin-tab-soporte .soporte-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('#admin-tab-soporte .soporte-panel').forEach(p => p.classList.remove('active'));
        if (tab === 'recibidos') {
          document.querySelectorAll('#admin-tab-soporte .soporte-tab')[0].classList.add('active');
          document.getElementById('admin-soporte-recibidos').classList.add('active');
        } else {
          document.querySelectorAll('#admin-tab-soporte .soporte-tab')[1].classList.add('active');
          document.getElementById('admin-soporte-enviados').classList.add('active');
        }
      }
    };

    window.filtrarUsuariosModal = () => Admin.filtrarUsuariosModal('todos');
    window.filtrarActivosModal = () => Admin.filtrarUsuariosModal('activos');

    // ==================== M√ìDULO UI ====================
    const UI = {
      consejos: [
        "La constancia es la clave.",
        "El descanso es entrenamiento.",
        "Conf√≠a en el proceso.",
        "La Z2 es tu mejor amiga.",
        "Hidrataci√≥n antes de sed.",
        "El sue√±o construye resistencia.",
        "Escucha a tu cuerpo.",
        "La nutrici√≥n es el combustible."
      ],
      consejoIndex: 0,
      changeDailyTip: function() {
        const el = document.getElementById("dailyTip");
        if (el) el.innerHTML = '<span>> ' + this.consejos[this.consejoIndex] + '</span><small>// pulsa para otro</small>';
        this.consejoIndex = (this.consejoIndex + 1) % this.consejos.length;
      },
      changeConsejo: function() {
        const el = document.getElementById("curiosity");
        if (el) el.innerHTML = '<span>' + this.consejos[this.consejoIndex] + '</span><small>// pulsa para otro</small>';
        this.consejoIndex = (this.consejoIndex + 1) % this.consejos.length;
      },
      startConsejoAutoChange: function() {
        setInterval(() => {
          if (document.getElementById("loginPage").style.display !== "none") this.changeDailyTip();
          if (document.getElementById("mainContent").style.display !== "none") this.changeConsejo();
        }, 10000);
      },
      marcarCampoTocado: function(c) {
        AppState.camposTocados[c] = true;
        this.validarCampo(c);
        this.validarTodo();
      },
      validarCampo: function(c) {
        const el = document.getElementById(c);
        const err = document.getElementById(c + 'Error');
        if (!AppState.camposTocados[c]) {
          err.classList.remove('visible');
          el.classList.remove('error');
          return true;
        }
        let ok = true;
        if (c === 'name') ok = el.value.trim().length >= 2;
        else if (c === 'age') {
          const a = parseInt(el.value);
          ok = !isNaN(a) && a >= 14 && a <= 85;
        } else if (c === 'time') {
          const t = Utils.parseTime(el.value);
          ok = !isNaN(t) && t >= 12 && t <= 90;
        }
        if (!ok) {
          err.innerText = '> INV√ÅLIDO_';
          err.classList.add('visible');
          el.classList.add('error');
        } else {
          err.classList.remove('visible');
          el.classList.remove('error');
        }
        return ok;
      },
      validarTodo: function() {
        const n = this.validarCampo('name');
        const a = this.validarCampo('age');
        const t = this.validarCampo('time');
        document.getElementById("calcBtn").disabled = !(n && a && t);
      },
      mostrarResultados: function(calcData) {
        let html = `<h2>M√âTRICAS</h2><div style="text-align:center; margin:20px 0;">
          ${calcData.name} ¬∑ ${calcData.age} a√±os<br>
          FC M√ÅX: ${calcData.fcMax} lpm ¬∑ UMBRAL: ${calcData.ul} lpm<br>
          RITMO 6km: ${Utils.formatR(calcData.ritmoBase)} min/km
        </div>`;
        html += `<h2>PREDICCIONES</h2>`;
        calcData.pred.forEach(p => html += `<div class="pred-bar" style="border-color:${p.color}; color:${p.color};">${p.dist} km ‚Üí ${Utils.formatR(p.ritmo)} min/km</div>`);
        html += `<h2>ZONAS</h2>`;
        calcData.zones.forEach(z => {
          const min = Math.round(calcData.ul * z[2]);
          const max = Math.round(calcData.ul * z[3]);
          html += `<div class="zone-card ${z[5]}" onclick="this.classList.toggle('active')"><strong>${z[0]} ‚Äì ${z[1]}</strong><br>FC: ${min}-${max} lpm<div class="long">${z[6]}</div></div>`;
        });
        html += `<button class="action-button btn-copy" onclick="window.copyResults()">üìã COPIAR</button>`;
        document.getElementById("results").innerHTML = html;
      },
      mostrarResultadosGuardados: function(calcData) {
        this.mostrarResultados(calcData);
      },
      switchTab: function(tab) {
        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        const btns = document.querySelectorAll('.tab-button');
        for (let b of btns) {
          if (b.textContent.includes(tab === 'entreno' ? 'ENTRENO' : tab === 'plan' ? 'PLAN' : tab === 'historial' ? 'HISTORIAL' : 'SOPORTE')) {
            b.classList.add('active');
            break;
          }
        }
        document.getElementById(`tab-${tab}`).classList.add('active');
        if (tab === 'historial') this.cargarHistorial();
        if (tab === 'soporte') {
          this.cargarMensajesRecibidos();
          this.cargarMensajesEnviados();
        }
      },
      cargarHistorial: async function() {
        if (!AppState.currentUser) return;
        let hist = await Storage.getHistorial(AppState.currentUser);
        const limite = parseInt(document.getElementById('historialLimit').value);
        if (hist.length > limite) hist = hist.slice(0, limite);
        const cont = document.getElementById("historialContainer");
        if (!hist.length) {
          cont.innerHTML = '<p>üì≠ SIN HISTORIAL</p>';
          this.actualizarGrafica([]);
          return;
        }
        let html = '<div class="historial-list">';
        hist.forEach((it, i) => {
          let zonasHtml = '';
          if (it.zonasResumen && Array.isArray(it.zonasResumen)) {
            zonasHtml = '<div class="zonas-pastillas">';
            it.zonasResumen.forEach(z => {
              zonasHtml += `<span class="zona-pastilla ${z.zona.toLowerCase()}"><span></span> ${z.zona}: ${z.min}-${z.max}</span>`;
            });
            zonasHtml += '</div>';
          }
          html += `<div class="historial-item">
            <div class="fecha">üìÖ ${it.date} ¬∑ ${it.hora || ''}</div>
            <div class="resumen">${it.resumen}</div>
            ${zonasHtml}
          </div>`;
        });
        html += '</div>';
        cont.innerHTML = html;
        this.actualizarGrafica(hist);
      },
      actualizarGrafica: function(historial) {
        const ctx = document.getElementById('progresoChart').getContext('2d');
        if (window.miGrafica) window.miGrafica.destroy();
        if (historial.length === 0) {
          ctx.font = "14px Inter";
          ctx.fillStyle = "#aaa";
          ctx.fillText("No hay datos", 10, 50);
          return;
        }
        const labels = historial.map(h => h.date.split('/')[0]);
        const datos = historial.map(h => h.fcMax || 180);
        window.miGrafica = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'FC M√°x',
              data: datos,
              borderColor: '#0a84ff',
              backgroundColor: 'rgba(10,132,255,0.1)',
              tension: 0.2
            }]
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false } }
          }
        });
      },
      cargarMensajesRecibidos: async function() {
        if (!AppState.currentUser) return;
        const msgs = await Storage.getMensajesUsuario(AppState.currentUser);
        let html = '';
        msgs.forEach((m, idx) => {
          html += `
            <div class="mensaje-item ${!m.leido ? 'nuevo' : ''}">
              <div class="mensaje-header" onclick="this.parentNode.classList.toggle('abierto')">
                <span>üì® ${m.fecha} ¬∑ Admin</span>
                <span class="flecha">‚ñº</span>
                <button class="delete-mensaje" onclick="event.stopPropagation(); Storage.borrarMensajeUsuario('${AppState.currentUser}', ${idx}).then(()=>UI.cargarMensajesRecibidos())">üóëÔ∏è</button>
              </div>
              <div class="mensaje-contenido">${m.texto}</div>
            </div>
          `;
        });
        document.getElementById('listaMensajesRecibidos').innerHTML = html || '<p>üì≠ NO HAY MENSAJES</p>';
        this.actualizarBadgeMensajes();
      },
      cargarMensajesEnviados: async function() {
        if (!AppState.currentUser) return;
        const msgs = await Storage.getMensajesEnviadosUsuario(AppState.currentUser);
        let html = '';
        msgs.forEach((m, idx) => {
          html += `
            <div class="mensaje-item">
              <div class="mensaje-header" onclick="this.parentNode.classList.toggle('abierto')">
                <span>üì§ ${m.fecha} ¬∑ T√∫</span>
                <span class="flecha">‚ñº</span>
              </div>
              <div class="mensaje-contenido">${m.texto}</div>
            </div>
          `;
        });
        document.getElementById('listaMensajesEnviados').innerHTML = html || '<p>üì≠ NO HAS ENVIADO MENSAJES</p>';
      },
      actualizarBadgeMensajes: function() {
        const soporteTab = document.getElementById('soporteTabButton');
        if (AppState.mensajesNoLeidos > 0) {
          soporteTab.classList.add('soporte-unread');
        } else {
          soporteTab.classList.remove('soporte-unread');
        }
      },
      enviarMensajeUsuario: async function() {
        if (!AppState.currentUser) return;
        const texto = document.getElementById('mensajeUsuario').value.trim();
        if (!texto) return alert('> ESCRIBE UN MENSAJE_');
        await Storage.enviarMensajeUsuario(AppState.currentUser, texto);
        document.getElementById('mensajeUsuario').value = '';
        this.cargarMensajesEnviados();
      },
      cambiarSoporteTab: function(tab) {
        document.querySelectorAll('#tab-soporte .soporte-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('#tab-soporte .soporte-panel').forEach(p => p.classList.remove('active'));
        if (tab === 'recibidos') {
          document.querySelectorAll('#tab-soporte .soporte-tab')[0].classList.add('active');
          document.getElementById('soporte-recibidos').classList.add('active');
        } else {
          document.querySelectorAll('#tab-soporte .soporte-tab')[1].classList.add('active');
          document.getElementById('soporte-enviados').classList.add('active');
        }
      },
      cerrarModalSesion: function() {
        document.getElementById('detalleSesion').classList.remove('active');
      },
      initDiasCheckboxes: function() {
        const container = document.getElementById('diasSemanaContainer');
        const dias = ['L', 'M', 'X', 'J', 'V', 'S', 'D'];
        let html = '';
        for (let i = 0; i < 7; i++) {
          const diaNum = i + 1;
          html += `
            <div class="dia-checkbox">
              <input type="checkbox" id="dia${diaNum}" value="${diaNum}" ${diaNum === 4 || diaNum === 6 ? 'checked' : ''}>
              <label for="dia${diaNum}">${dias[i]}</label>
            </div>
          `;
        }
        container.innerHTML = html;
      }
    };

    // ==================== M√ìDULO ENTRENAMIENTO ====================
    const Training = {
      startCalc: function() {
        UI.validarTodo();
        if (document.getElementById("calcBtn").disabled) return;
        const btn = document.getElementById("calcBtn");
        Utils.showLoading(btn);
        setTimeout(() => {
          this.calculate();
          Utils.hideLoading(btn);
          Utils.showTemporaryMessage(btn, "‚úì CALCULADO", true);
          document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }, 300);
      },
      calculate: function() {
        const name = document.getElementById("name").value.trim();
        const age = parseInt(document.getElementById("age").value);
        const t = Utils.parseTime(document.getElementById("time").value);
        if (!name || !age || isNaN(t)) return alert("> COMPLETA TODOS LOS CAMPOS CORRECTAMENTE_");
        const ritmoBase = t / 6;
        const fcMax = 220 - age;
        const UL = Math.round(fcMax * 0.92 * 1.03);
        const pred = [
          { dist: 2, color: "var(--accent-blue)", ritmo: ritmoBase * 0.98 },
          { dist: 6, color: "var(--accent-green)", ritmo: ritmoBase },
          { dist: 10, color: "var(--accent-yellow)", ritmo: ritmoBase * 1.05 },
          { dist: 21, color: "var(--accent-red)", ritmo: ritmoBase * 1.12 },
          { dist: 42, color: "var(--accent-purple)", ritmo: ritmoBase * 1.20 }
        ];
        const zones = [
          ["Z1", "RECUPERACI√ìN", 0.75, 0.80, 1.35, "z1", "RITMO: " + Utils.formatR(ritmoBase * 1.35) + "<br><br>üîπ Recuperaci√≥n activa."],
          ["Z2", "BASE", 0.80, 0.90, 1.25, "z2", "RITMO: " + Utils.formatR(ritmoBase * 1.25) + "<br><br>üîπ Mejora eficiencia metab√≥lica."],
          ["Z3", "TEMPO", 0.90, 0.95, 1.15, "z3", "RITMO: " + Utils.formatR(ritmoBase * 1.15) + "<br><br>üîπ Tolerancia al lactato."],
          ["Z4", "UMBRAL", 0.95, 1.02, 1.05, "z4", "RITMO: " + Utils.formatR(ritmoBase * 1.05) + "<br><br>üîπ Limpieza de lactato."],
          ["Z5", "VO‚ÇÇM√ÅX", 1.02, 1.06, 0.95, "z5", "RITMO: " + Utils.formatR(ritmoBase * 0.95) + "<br><br>üîπ Potencia aer√≥bica m√°xima."],
          ["Z6", "VELOCIDAD", 1.06, 1.12, 0.85, "z6", "RITMO: " + Utils.formatR(ritmoBase * 0.85) + "<br><br>üîπ Potencia neuromuscular."]
        ];
        const calcData = { name, age, fcMax, ul: UL, zones, pred, ritmoBase };
        AppState.setLastCalc(calcData);
        UI.mostrarResultados(calcData);
        this.guardarCalculoAutomatico(calcData);
      },
      guardarCalculoAutomatico: async function(calcData) {
        if (!AppState.currentUser) return;
        const ahora = new Date();
        let zonasResumen = [];
        if (calcData.zones && calcData.zones.length) {
          zonasResumen = calcData.zones.map(z => {
            const min = Math.round(calcData.ul * z[2]);
            const max = Math.round(calcData.ul * z[3]);
            return { zona: z[0], min, max };
          });
        }
        const data = {
          date: ahora.toLocaleDateString('es-ES'),
          hora: ahora.toLocaleTimeString('es-ES'),
          nombre: calcData.name,
          edad: calcData.age,
          fcMax: calcData.fcMax,
          umbral: calcData.ul,
          ritmo6k: Utils.formatR(calcData.ritmoBase),
          resumen: `${calcData.name} ¬∑ ${calcData.age} a√±os ¬∑ 6km: ${Utils.formatR(calcData.ritmoBase)}`,
          zonasResumen: zonasResumen
        };
        let hist = await Storage.getHistorial(AppState.currentUser);
        hist.unshift(data);
        const limite = AppState.isPremium ? 25 : 10;
        if (hist.length > limite) hist.pop();
        await Storage.saveHistorial(AppState.currentUser, hist);
        await Storage.setUltimoCalculo(AppState.currentUser, calcData);
      },
      copyResults: function() {
        if (!AppState.lastName) return alert("> CALCULA ZONAS PRIMERO_");
        let text = "üîπ RI5 - ZONAS DE ENTRENO üîπ\n\n";
        text += `üë§ ${AppState.lastName} ¬∑ ${AppState.lastAge} a√±os\n`;
        text += `‚ù§Ô∏è FC M√ÅX: ${AppState.lastFC} lpm ¬∑ UMBRAL: ${AppState.lastUL} lpm\n`;
        text += `‚è±Ô∏è RITMO 6km: ${Utils.formatR(AppState.lastRitmoBase)} min/km\n\nüìä PREDICCIONES:\n`;
        AppState.lastPred.forEach(p => text += `   ${p.dist} km ‚Üí ${Utils.formatR(p.ritmo)} min/km\n`);
        text += `\nüéØ ZONAS:\n`;
        AppState.lastZones.forEach(z => {
          const min = Math.round(AppState.lastUL * z[2]);
          const max = Math.round(AppState.lastUL * z[3]);
          text += `   ${z[0]} ${z[1]}: ${min}-${max} lpm\n`;
        });
        navigator.clipboard.writeText(text).then(() => alert("‚úÖ COPIADO"));
      }
    };

    // ==================== M√ìDULO PLAN GENERATOR ====================
    const PlanGenerator = {
      ENTRENAMIENTOS_DB: ENTRENAMIENTOS_DB,
      toggleCuestionario: function() {
        if (!AppState.zonasCalculadas) return alert("> CALCULA ZONAS PRIMERO_");
        const q = document.getElementById("cuestionarioEntreno");
        q.style.display = q.style.display === "block" ? "none" : "block";
      },
      guardarPlanActual: async function() {
        if (!AppState.currentUser || !AppState.planGeneradoActual) return;
        await Storage.setUltimoPlan(AppState.currentUser, AppState.planGeneradoActual);
      },
      mostrarUltimoPlanGuardado: async function() {
        if (!AppState.currentUser) return alert("> NO HAY USUARIO_");
        const stored = await Storage.getUltimoPlan(AppState.currentUser);
        if (!stored) return alert("> NO HAY PLAN GUARDADO_");
        AppState.ultimoPlanParams = stored;
        document.getElementById("modalidad").value = stored.modalidad;
        document.getElementById("distObjetivo").value = stored.distancia;
        document.getElementById("duracionPlan").value = stored.macrociclo / 4;
        const diasGuardados = stored.diasEntreno || [4, 6];
        for (let i = 1; i <= 7; i++) {
          const cb = document.getElementById(`dia${i}`);
          if (cb) cb.checked = diasGuardados.includes(i);
        }
        document.getElementById("nivel").value = stored.nivel;
        document.getElementById("experienciaDistancia").value = stored.experiencia || "no";
        document.getElementById("objetivoPrincipal").value = stored.objetivo || "mejorar";
        document.getElementById("diaLargo").value = stored.diaLargo;
        document.getElementById("fechaInicio").value = stored.fechaInicio || "2025-03-01";
        document.getElementById("cuestionarioEntreno").style.display = "none";
        document.getElementById("calendarioEntreno").style.display = "block";
        this.generarCalendarioEntreno();
      },
      borrarPlanGuardado: async function() {
        if (!AppState.currentUser) return;
        if (!confirm("> ¬øELIMINAR PLAN GUARDADO?_")) return;
        await Storage.removeUltimoPlan(AppState.currentUser);
        alert("‚úÖ PLAN ELIMINADO");
      },
      getRitmoPorZona: function(z) {
        if (!AppState.lastRitmoBase) return "Calcula zonas primero";
        const f = { 'Z1': 1.35, 'Z2': 1.25, 'Z3': 1.15, 'Z4': 1.05, 'Z5': 0.95, 'Z6': 0.85 };
        if (z.includes('-')) {
          const [a, b] = z.split('-');
          return `${Utils.formatR(AppState.lastRitmoBase * (f[a] || 1.15))} ‚Äì ${Utils.formatR(AppState.lastRitmoBase * (f[b] || 1.05))} min/km`;
        }
        return Utils.formatR(AppState.lastRitmoBase * (f[z] || 1.15)) + " min/km";
      },
      generarCalendarioEntreno: function() {
        if (!AppState.zonasCalculadas) return alert("> PRIMERO CALCULA TUS ZONAS_");
        const btn = document.querySelector('[onclick="window.generarCalendarioEntreno()"]');
        if (btn) Utils.showLoading(btn);
        setTimeout(() => {
          try {
            const modalidad = document.getElementById("modalidad").value;
            const distancia = document.getElementById("distObjetivo").value;
            const meses = parseInt(document.getElementById("duracionPlan").value);
            const nivel = document.getElementById("nivel").value;
            const exp = document.getElementById("experienciaDistancia").value;
            const obj = document.getElementById("objetivoPrincipal").value;
            const diaLargo = parseInt(document.getElementById("diaLargo").value);
            const fechaInicio = document.getElementById("fechaInicio").value;
            if (!fechaInicio) return alert("> SELECCIONA UNA FECHA DE INICIO_");

            const diasEntreno = [];
            for (let i = 1; i <= 7; i++) {
              const cb = document.getElementById(`dia${i}`);
              if (cb && cb.checked) diasEntreno.push(i);
            }
            if (diasEntreno.length === 0) return alert("> SELECCIONA AL MENOS UN D√çA DE ENTRENO_");
            if (!diasEntreno.includes(diaLargo)) {
              if (confirm("> El d√≠a de tirada larga no est√° seleccionado. ¬øA√±adirlo autom√°ticamente?")) {
                diasEntreno.push(diaLargo);
                document.getElementById(`dia${diaLargo}`).checked = true;
              } else {
                return;
              }
            }
            diasEntreno.sort((a, b) => a - b);

            const fecha = new Date(fechaInicio + "T00:00:00");
            const macrociclo = meses * 4;
            const mapa = { "2k": "2 km", "5k": "5 km", "10k": "10 km", "medio": "MEDIA", "maraton": "MARAT√ìN" };
            const diaNombre = ["", "LUN", "MAR", "MI√â", "JUE", "VIE", "S√ÅB", "DOM"][diaLargo];
            document.getElementById("resumenObjetivo").innerText = `${mapa[distancia]} ¬∑ ${diasEntreno.length} D√çAS/SEM ¬∑ ${nivel.toUpperCase()} ¬∑ ${exp === 'si' ? 'CON EXPERIENCIA' : 'PRIMERA VEZ'} ¬∑ ${obj === 'acabar' ? 'OBJ: TERMINAR' : obj === 'mejorar' ? 'OBJ: MEJORAR' : 'OBJ: COMPETIR'} ¬∑ LARGO: ${diaNombre} ¬∑ ${modalidad === 'runner' ? 'ASFALTO' : 'MONTA√ëA'} ¬∑ ${meses} MES(ES) ¬∑ INICIO: ${fecha.toLocaleDateString()}`;

            const grid = document.getElementById("calendarioGrid");
            grid.innerHTML = "";
            const totalDias = macrociclo * 7;

            const tipoPorDia = {};
            tipoPorDia[diaLargo] = 'largo';

            const otrosDias = diasEntreno.filter(d => d !== diaLargo);
            const posiblesTipos = ['series', 'tempo', 'rodaje'];
            otrosDias.forEach((dia, index) => {
              tipoPorDia[dia] = posiblesTipos[index % posiblesTipos.length];
            });

            const usados = { rodaje: 0, series: 0, tempo: 0, largo: 0 };
            const fragment = document.createDocumentFragment();

            for (let dia = 1; dia <= totalDias; dia++) {
              const semana = Math.floor((dia - 1) / 7);
              const diaSem = (dia - 1) % 7 + 1;
              let color = "sesion-descanso", breve = "D", detalle = null;

              if (diasEntreno.includes(diaSem)) {
                let tipo = tipoPorDia[diaSem];

                const esDescarga = (semana + 1) % 4 === 0;
                let factorPersonal = 1.0;
                if (AppState.lastRitmoBase) {
                  const ritmoRef = 5.0;
                  factorPersonal = Math.min(1.2, Math.max(0.8, ritmoRef / AppState.lastRitmoBase));
                }
                if (esDescarga) factorPersonal *= 0.8;

                let opts = [];
                if (tipo === 'largo') {
                  opts = this.ENTRENAMIENTOS_DB[modalidad]?.[distancia]?.[nivel]?.largo || [];
                  if (opts.length) {
                    const idx = (semana * 2 + usados.largo) % opts.length;
                    detalle = { ...opts[idx], tipo: "largo" };
                    detalle.duracion = Math.round(detalle.duracion * factorPersonal);
                    color = "sesion-largo";
                    breve = "L";
                    usados.largo++;
                  }
                } else if (tipo === 'series') {
                  opts = this.ENTRENAMIENTOS_DB[modalidad]?.[distancia]?.[nivel]?.series || [];
                  if (opts.length) {
                    const idx = (semana * 3 + usados.series) % opts.length;
                    detalle = { ...opts[idx], tipo: "series" };
                    detalle.duracion = Math.round(detalle.duracion * factorPersonal);
                    color = "sesion-series";
                    breve = "S";
                    usados.series++;
                  }
                } else if (tipo === 'tempo') {
                  opts = this.ENTRENAMIENTOS_DB[modalidad]?.[distancia]?.[nivel]?.tempo || [];
                  if (opts.length) {
                    const idx = (semana * 4 + usados.tempo) % opts.length;
                    detalle = { ...opts[idx], tipo: "tempo" };
                    detalle.duracion = Math.round(detalle.duracion * factorPersonal);
                    color = "sesion-tempo";
                    breve = "T";
                    usados.tempo++;
                  }
                } else {
                  opts = this.ENTRENAMIENTOS_DB[modalidad]?.[distancia]?.[nivel]?.rodaje || [];
                  if (opts.length) {
                    const idx = (semana * 5 + usados.rodaje) % opts.length;
                    detalle = { ...opts[idx], tipo: "rodaje" };
                    detalle.duracion = Math.round(detalle.duracion * factorPersonal);
                    color = "sesion-rodaje";
                    breve = "R";
                    usados.rodaje++;
                  }
                }
              }

              const div = document.createElement("div");
              div.className = `calendario-dia ${color}`;
              if (detalle) div.dataset.detalle = JSON.stringify(detalle);
              div.innerHTML = `<div style="font-size:10px;">S${semana + 1}</div><strong>${breve}</strong>${detalle ? `<div style="font-size:8px;">${detalle.duracion}${detalle.unidad}</div>` : ''}`;
              div.dataset.letra = breve;
              div.dataset.semana = semana + 1;
              div.dataset.colorClass = color;

              div.onclick = function() {
                const modal = document.getElementById("detalleSesion");
                const wrapper = document.getElementById("modalColorWrapper");
                wrapper.className = "modal-content";
                wrapper.classList.add(this.dataset.colorClass);
                const det = this.dataset.detalle ? JSON.parse(this.dataset.detalle) : null;
                AppState.currentSesionDetalle = det;
                let tit = "", cont = "";
                if (this.dataset.letra === "D") {
                  tit = "D√çA DE DESCANSO";
                  cont = "<strong>> OBJETIVO_</strong> Recuperaci√≥n completa<br><br><strong>> RECOMENDADO_</strong><br>‚Ä¢ No correr<br>‚Ä¢ Estiramientos suaves<br>‚Ä¢ Buena nutrici√≥n";
                } else if (det) {
                  tit = det.nombre || `${this.dataset.letra} ¬∑ Semana ${this.dataset.semana}`;
                  const ritmo = PlanGenerator.getRitmoPorZona(det.zona);
                  cont = `<strong>üèÉ ${det.nombre}</strong><br><br><strong>‚è±Ô∏è DURACI√ìN:</strong> ${det.duracion} ${det.unidad}<br><strong>üìä ZONA:</strong> ${det.zona}<br><strong>‚ö° RITMO:</strong> ${ritmo}<br><br><strong>üìã ESTRUCTURA:</strong><br>${det.estructura}<br><br><strong>üí¨ DESCRIPCI√ìN:</strong><br>${det.desc}<br><br><strong>üòå SENSACI√ìN:</strong> ${det.sensacion}`;
                } else {
                  cont = "> SELECCIONA UN D√çA PARA VER DETALLES_";
                }
                document.getElementById("tituloSesion").innerText = tit;
                document.getElementById("descripcionSesion").innerHTML = cont;
                modal.classList.add('active');
              };
              fragment.appendChild(div);
            }
            grid.appendChild(fragment);
            AppState.planGeneradoActual = { modalidad, distancia, macrociclo, diasPorSemana: diasEntreno.length, nivel, experiencia: exp, objetivo: obj, diaLargo, fechaInicio, diasEntreno };
            document.getElementById("calendarioEntreno").style.display = "block";
            setTimeout(() => document.getElementById("calendarioEntreno").scrollIntoView({ behavior: 'smooth' }), 100);
            this.guardarPlanActual();
            if (btn) Utils.hideLoading(btn);
          } catch (e) {
            console.error(e);
            alert("> ERROR GENERANDO PLAN_");
            if (btn) Utils.hideLoading(btn);
          }
        }, 300);
      }
    };

    // ==================== M√ìDULO PWA ====================
    const PWA = {
      init: function() {
        window.addEventListener('beforeinstallprompt', e => {
          e.preventDefault();
          AppState.deferredPrompt = e;
          if (localStorage.getItem('pwa_installed') !== 'true') document.getElementById('pwa-banner').style.display = 'flex';
        });
        window.addEventListener('appinstalled', () => {
          document.getElementById('pwa-banner').style.display = 'none';
          AppState.deferredPrompt = null;
          localStorage.setItem('pwa_installed', 'true');
        });
      },
      instalarPWA: function() {
        if (!AppState.deferredPrompt) {
          alert('Men√∫ del navegador ‚Üí "A√±adir a pantalla de inicio"');
          return;
        }
        AppState.deferredPrompt.prompt();
        AppState.deferredPrompt.userChoice.then(c => {
          if (c.outcome === 'accepted') localStorage.setItem('pwa_installed', 'true');
          AppState.deferredPrompt = null;
          document.getElementById('pwa-banner').style.display = 'none';
        });
      },
      cerrarBannerPWA: function() {
        document.getElementById('pwa-banner').style.display = 'none';
        localStorage.setItem('pwa_banner_closed', 'true');
      }
    };

    // ==================== INICIALIZACI√ìN ====================
    window.onload = async () => {
      if (!await Auth.checkSavedSession()) {
        document.getElementById("loginPage").style.display = "flex";
      }
      document.getElementById("name").addEventListener("blur", () => UI.marcarCampoTocado('name'));
      document.getElementById("age").addEventListener("blur", () => UI.marcarCampoTocado('age'));
      document.getElementById("time").addEventListener("blur", () => UI.marcarCampoTocado('time'));
      document.getElementById("name").addEventListener("input", () => {
        if (AppState.camposTocados.name) UI.validarCampo('name');
        UI.validarTodo();
      });
      document.getElementById("age").addEventListener("input", () => {
        if (AppState.camposTocados.age) UI.validarCampo('age');
        UI.validarTodo();
      });
      document.getElementById("time").addEventListener("input", () => {
        if (AppState.camposTocados.time) UI.validarCampo('time');
        UI.validarTodo();
      });
      UI.validarTodo();
      UI.initDiasCheckboxes();
      PWA.init();
    };

    // Exponer funciones globales
    window.switchAuthTab = Auth.switchAuthTab.bind(Auth);
    window.registerUser = Auth.registerUser.bind(Auth);
    window.loginUser = Auth.loginUser.bind(Auth);
    window.logoutUser = Auth.logoutUser.bind(Auth);
    window.logoutAdmin = Auth.logoutAdmin.bind(Auth);
    window.startCalc = Training.startCalc.bind(Training);
    window.copyResults = Training.copyResults.bind(Training);
    window.switchTab = UI.switchTab.bind(UI);
    window.changeDailyTip = UI.changeDailyTip.bind(UI);
    window.changeConsejo = UI.changeConsejo.bind(UI);
    window.borrarHistorial = UI.borrarHistorial;
    window.cerrarModalSesion = UI.cerrarModalSesion;
    window.toggleCuestionario = PlanGenerator.toggleCuestionario.bind(PlanGenerator);
    window.mostrarUltimoPlanGuardado = PlanGenerator.mostrarUltimoPlanGuardado.bind(PlanGenerator);
    window.borrarPlanGuardado = PlanGenerator.borrarPlanGuardado.bind(PlanGenerator);
    window.generarCalendarioEntreno = PlanGenerator.generarCalendarioEntreno.bind(PlanGenerator);
    window.instalarPWA = PWA.instalarPWA.bind(PWA);
    window.cerrarBannerPWA = PWA.cerrarBannerPWA.bind(PWA);
    window.showPremiumBenefits = Auth.showPremiumBenefits;
    window.switchAdminTab = function(tab) {
      document.querySelectorAll('#adminPage .tab-button').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('#adminPage .tab-content').forEach(c => c.classList.remove('active'));
      if (tab === 'usuarios') {
        document.querySelectorAll('#adminPage .tab-button')[0].classList.add('active');
        document.getElementById('admin-tab-usuarios').classList.add('active');
      } else {
        document.querySelectorAll('#adminPage .tab-button')[1].classList.add('active');
        document.getElementById('admin-tab-soporte').classList.add('active');
        Admin.cargarMensajesAdmin();
      }
    };
    window.cambiarAdminSoporteTab = Admin.cambiarSoporteTab;
    window.exportarUsuariosCSV = Admin.exportarUsuariosCSV.bind(Admin);
    window.renovarExpirados = Admin.renovarExpirados.bind(Admin);
    window.Admin = Admin;
    window.UI = UI;
  </script>
</body>
</html>